<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>calibrate &mdash; Thermoengine 1.0.1 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../None"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="Thermoengine 1.0.1 documentation" href="../index.html" >
    <link rel="up" title="Module code" href="index.html" > 
  </head>
  <body>

<div class="container">
  <div class="top-scipy-org-logo-header">
    <a href="../index.html">
      <img style="border: 0;" alt="ENKI" src="../_static/img/ENKI_header.png"></a>
    </div>
  </div>
</div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="http://enki-portal.org">ENKI Web</a></li>
        <li class="active"><a href="https://enki.ofm-research.org">ENKI Server</a></li>
	
        <li class="active"><a href="../index.html">Thermoengine 1.0.1 documentation</a></li>
	
          <li class="active"><a href="index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Enki.png" alt="Logo">
            </a></p>
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for calibrate</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The phases subpackage implements a Python interface with the Phase</span>
<span class="sd">Objective-C classes as well as the infrastructure for pure phase thermodynamic calibration.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">chem</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="c1"># specialized numerical imports</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">interpolate</span> <span class="k">as</span> <span class="n">interp</span><span class="p">,</span> <span class="n">optimize</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">numdifftools</span> <span class="k">as</span> <span class="nn">nd</span>

<span class="n">RGAS</span> <span class="o">=</span> <span class="mf">8.3144598</span>
<span class="c1"># __all__ = [&#39;Database&#39;,&#39;Data&#39;,&#39;ParamModel&#39;,&#39;RxnModel&#39;]</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Database&#39;</span><span class="p">]</span>

<span class="c1">#===================================================</span>
<div class="viewcode-block" id="Database"><a class="viewcode-back" href="../calibrate.html#calibrate.Database">[docs]</a><span class="k">class</span> <span class="nc">Database</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calibration database model object.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rxn_data: pandas df</span>
<span class="sd">        experimental data input</span>
<span class="sd">    modelDB: str</span>
<span class="sd">        choose thermodynamic model database (e.g., &#39;Berman&#39; is a valid input)</span>
<span class="sd">    reaction_library:</span>
<span class="sd">    TOLsvd: int</span>
<span class="sd">    Ndraw: int</span>
<span class="sd">    ortho_scale: int</span>
<span class="sd">        ratio that dictates level of rxn complexity (orthogonality/simplicity)</span>
<span class="sd">    TOL: int</span>
<span class="sd">        complexity of rxns</span>
<span class="sd">    ignore_kinetics: boolean, default False</span>
<span class="sd">    contaminant_phases: str list</span>
<span class="sd">    rxn_trans_typ: [&#39;logisitic&#39;]</span>
<span class="sd">    Tscl_energy: 1.0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rxn_svd: array of ints</span>
<span class="sd">        matrix of valid, lineraly independent reactions</span>

<span class="sd">    TODO</span>
<span class="sd">    ----</span>
<span class="sd">    - get trusted data?</span>
<span class="sd">    - priors?</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RXN_FACTORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="s1">&#39;contaminant&#39;</span><span class="p">]</span>
    <span class="n">RXN_SCL_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">RXN_DEFAULT_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">PHASE_PARAM_LOOKUP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;V0&#39;</span><span class="p">:</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;S0&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;dH0&#39;</span><span class="p">:</span> <span class="s1">&#39;delta H&#39;</span><span class="p">}</span>

    <span class="n">T0</span> <span class="o">=</span> <span class="mf">300.0</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_data</span><span class="p">,</span> <span class="n">modelDB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">reaction_library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ignore_kinetics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">contaminant_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">,</span> <span class="n">TOLsvd</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">ortho_scale</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">phase_priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rxn_priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ref_energy_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">modelDB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">modelDB</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Database</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_rxns</span><span class="p">(</span><span class="n">rxn_data</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span> <span class="n">reaction_library</span><span class="p">,</span> <span class="n">Ndraw</span><span class="p">,</span> <span class="n">TOLsvd</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="p">,</span> <span class="n">TOL</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_params</span><span class="p">(</span><span class="n">phase_priors</span><span class="p">,</span> <span class="n">rxn_priors</span><span class="p">,</span> <span class="n">ref_energy_phases</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modelDB</span> <span class="o">=</span> <span class="n">modelDB</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_kinetics</span> <span class="o">=</span> <span class="n">ignore_kinetics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contaminant_phases</span> <span class="o">=</span> <span class="n">contaminant_phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span> <span class="o">=</span> <span class="n">rxn_trans_typ</span>

    <span class="k">def</span> <span class="nf">_init_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_data</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span> <span class="n">reaction_library</span><span class="p">,</span> <span class="n">Ndraw</span><span class="p">,</span> <span class="n">TOLsvd</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="p">,</span> <span class="n">TOL</span><span class="p">):</span>
        <span class="n">rxn_coefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rxn_eqns</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#Need to revisit this</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">reaction_library</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#endmember_ids = [0,0]</span>

            <span class="c1">#rxns = [modelDB.get_rxn(irxn_prop[&#39;phases&#39;], endmember_ids,</span>
                                    <span class="c1">#irxn_prop[&#39;coefs&#39;])</span>
                    <span class="c1">#for irxn_prop in rxn_data.rxn_props]</span>
            <span class="c1">#rxn_eqns = [irxn_prop[&#39;eqn&#39;] for irxn_prop in rxn_data.rxn_props]</span>

            <span class="c1">#phases = []</span>
            <span class="c1">#for irxn in rxns:</span>
                <span class="c1">#phases.extend(irxn.phases)</span>

            <span class="c1">#phases = np.unique(phases)</span>

            <span class="n">phase_symbols</span><span class="o">=</span><span class="n">chem</span><span class="o">.</span><span class="n">get_phase_symbols</span><span class="p">(</span><span class="n">rxn_data</span><span class="p">)</span>
            <span class="n">rxn_svd_props</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">calc_reaction_svd</span><span class="p">(</span><span class="n">phase_symbols</span><span class="p">,</span> <span class="n">TOLsvd</span><span class="o">=</span><span class="n">TOLsvd</span><span class="p">)</span>
            <span class="n">rxn_svd</span> <span class="o">=</span> <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;rxn_svd&#39;</span><span class="p">]</span>
            <span class="n">Nbasis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn_svd</span><span class="p">)</span>
            <span class="n">wtcoefs</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">rxn_coefs_raw</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">get_rxns</span><span class="p">(</span><span class="n">rxn_svd</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="n">Ndraw</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="n">Nbasis</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="n">TOL</span><span class="p">)</span>
            <span class="n">rxn_coefs</span> <span class="o">=</span> <span class="n">rxn_coefs_raw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">rxn_coefs</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rxn_coefs</span><span class="p">)</span><span class="o">&lt;</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="c1">#rxns =</span>

            <span class="c1">#endmember_ids = np.arange(0,len(rxn_coefs[0]))</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">phase_symbols</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;reaction_library is not None, need to implement user defined set of reactions&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reaction_library</span> <span class="o">=</span> <span class="n">reaction_library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_data</span> <span class="o">=</span> <span class="n">rxn_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_coefs</span> <span class="o">=</span> <span class="n">rxn_coefs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_eqns</span> <span class="o">=</span> <span class="n">rxn_eqns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxns</span> <span class="o">=</span> <span class="n">rxns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span> <span class="o">=</span> <span class="n">phases</span>

        <span class="c1">#self.endmember_ids = endmember_ids</span>
        <span class="c1">#TK</span>
    <span class="k">def</span> <span class="nf">_init_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_priors</span><span class="p">,</span> <span class="n">rxn_priors</span><span class="p">,</span>
                     <span class="n">ref_energy_phases</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_param_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_scales</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ref_energy_phases</span><span class="p">(</span><span class="n">ref_energy_phases</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_rxn_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase_params</span><span class="p">()</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_scales</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="p">,))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_phase_priors</span><span class="p">(</span><span class="n">phase_priors</span><span class="p">,</span> <span class="n">ref_energy_phases</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_rxn_priors</span><span class="p">(</span><span class="n">rxn_priors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_ref_energy_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_energy_phases</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span>
        <span class="c1">#TK</span>
        <span class="k">if</span> <span class="n">phases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phases is None&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phase_symbols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">iphs</span><span class="o">.</span><span class="n">abbrev</span> <span class="k">for</span> <span class="n">iphs</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;phases is good to go&#39;</span><span class="p">)</span>

        <span class="c1">#phase_symbols = np.array(</span>
            <span class="c1">#[iphs.abbrev for iphs in phases])</span>

        <span class="k">if</span> <span class="n">ref_energy_phases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_energy_phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase_symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">ref_phs</span> <span class="ow">in</span> <span class="n">phase_symbols</span>
                           <span class="k">for</span> <span class="n">ref_phs</span> <span class="ow">in</span> <span class="n">ref_energy_phases</span><span class="p">]),(</span>
                               <span class="s1">&#39;The ref_energy_phases provided &#39;</span>
                               <span class="s1">&#39;are not valid.&#39;</span>
                               <span class="p">)</span>

        <span class="n">H0_ref_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">ref_energy_phases</span><span class="p">:</span>
            <span class="n">iref_phase</span><span class="p">,</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="n">phase_symbols</span><span class="o">==</span><span class="n">phase_name</span><span class="p">]</span>
            <span class="n">H0_ref_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iref_phase</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ref_energy_phases</span> <span class="o">=</span> <span class="n">H0_ref_phases</span>

    <span class="k">def</span> <span class="nf">_get_ref_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
        <span class="n">ref_energy_phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_energy_phases</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_energy_phases</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;Currently, only a single ref_energy_phase is implimented. Must work to implement composition-dependent enthalpy ref.&#39;</span>
        <span class="p">)</span>

        <span class="n">ref_phase</span> <span class="o">=</span> <span class="n">ref_energy_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">H0</span><span class="p">,</span> <span class="o">=</span> <span class="n">ref_phase</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;delta H&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">H0</span>

    <span class="k">def</span> <span class="nf">_set_phase_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_priors</span><span class="p">,</span> <span class="n">ref_energy_phases</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span>
        <span class="n">phase_symbols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">iphs</span><span class="o">.</span><span class="n">abbrev</span> <span class="k">for</span> <span class="n">iphs</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">])</span>

        <span class="c1"># from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>

        <span class="n">prior_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prior_avg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prior_error</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">iphs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
            <span class="n">isym</span> <span class="o">=</span> <span class="n">iphs</span><span class="o">.</span><span class="n">abbrev</span>
            <span class="n">imask</span> <span class="o">=</span> <span class="n">phase_priors</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">isym</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">imask</span><span class="p">):</span>
                <span class="n">ipriors</span> <span class="o">=</span> <span class="n">phase_priors</span><span class="p">[</span><span class="n">imask</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">iname</span><span class="p">,</span> <span class="n">iavg</span><span class="p">,</span> <span class="n">ierror</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">ipriors</span><span class="p">[</span><span class="s1">&#39;param_name&#39;</span><span class="p">],</span>
                    <span class="n">ipriors</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">],</span>
                    <span class="n">ipriors</span><span class="p">[</span><span class="s1">&#39;param_error&#39;</span><span class="p">]):</span>

                    <span class="k">if</span> <span class="n">iname</span><span class="o">==</span><span class="s1">&#39;H0&#39;</span><span class="p">:</span>
                        <span class="n">iparam_name</span> <span class="o">=</span> <span class="s1">&#39;dH0_P&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                        <span class="c1"># Adjust dH0 value here</span>

                        <span class="n">iavg</span> <span class="o">=</span> <span class="n">iavg</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">iparam_name</span> <span class="o">=</span> <span class="n">iname</span><span class="o">+</span><span class="s1">&#39;_P&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>

                    <span class="n">prior_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iparam_name</span><span class="p">)</span>
                    <span class="n">prior_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iavg</span><span class="p">)</span>
                    <span class="n">prior_error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ierror</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prior_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prior_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prior_avg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prior_error</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_rxn_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_priors</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_append_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_value</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_value</span><span class="o">/</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_scales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_rxn_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rxns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxns</span>

        <span class="k">for</span> <span class="n">factor</span><span class="p">,</span> <span class="n">scl_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RXN_FACTORS</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">RXN_SCL_VALUES</span><span class="p">):</span>
            <span class="n">param_basename</span> <span class="o">=</span> <span class="s1">&#39;alpha_&#39;</span><span class="o">+</span><span class="n">factor</span><span class="o">+</span><span class="s1">&#39;_R&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_param</span><span class="p">(</span><span class="n">param_basename</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">irxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxns</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_param</span><span class="p">(</span><span class="n">param_basename</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_phase_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T0</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P0</span>

        <span class="k">def</span> <span class="nf">get_set_phase_param</span><span class="p">(</span><span class="n">param_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dH0_P&#39;</span><span class="p">):</span>
                <span class="n">H0</span><span class="p">,</span> <span class="n">iphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phase_param</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">return_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">H0_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_energy</span><span class="p">(</span><span class="n">iphs</span><span class="p">)</span>
                <span class="c1"># val0 = (H0 - H0_ref)/1e3</span>
                <span class="n">val0</span> <span class="o">=</span> <span class="p">(</span><span class="n">H0</span> <span class="o">-</span> <span class="n">H0_ref</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phase_param</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">val0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_append_param</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">val0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">iphs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="p">):</span>
            <span class="n">get_set_phase_param</span><span class="p">(</span><span class="s1">&#39;V0_P&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
            <span class="n">get_set_phase_param</span><span class="p">(</span><span class="s1">&#39;S0_P&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">iphs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref_energy_phases</span><span class="p">:</span>
                <span class="n">get_set_phase_param</span><span class="p">(</span><span class="s1">&#39;dH0_P&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_split_param_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">):</span>
        <span class="n">ind_sep</span> <span class="o">=</span> <span class="n">param_name</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">param_typ</span><span class="p">,</span> <span class="n">phs_key</span> <span class="o">=</span> <span class="n">param_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ind_sep</span><span class="p">],</span> <span class="n">param_name</span><span class="p">[</span><span class="n">ind_sep</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">param_typ</span><span class="p">,</span> <span class="n">phs_key</span>

    <span class="k">def</span> <span class="nf">_get_phase_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">return_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">param_typ</span><span class="p">,</span> <span class="n">phs_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_param_name</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">phs_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;This parameter must be a phase parameter.&#39;</span>
        <span class="p">)</span>

        <span class="n">phs_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">phs_key</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">iphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="n">phs_ind</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">iphs</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span>
            <span class="n">param_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PHASE_PARAM_LOOKUP</span><span class="p">[</span><span class="n">param_typ</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">return_phase</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">iphs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_update_phase_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phase_param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;delta H&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">]</span>
        <span class="n">calib_param_basenames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dH0_P&#39;</span><span class="p">,</span> <span class="s1">&#39;V0_P&#39;</span><span class="p">,</span> <span class="s1">&#39;S0_P&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_add_set_params</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">calib_names</span><span class="p">,</span> <span class="n">calib_values</span><span class="p">,</span>
                           <span class="n">phase_param_names</span><span class="p">,</span> <span class="n">phase_param_values</span><span class="p">):</span>
            <span class="n">phase_param_lookup</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;V0&#39;</span><span class="p">:</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;S0&#39;</span><span class="p">:</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;dH0&#39;</span><span class="p">:</span><span class="s1">&#39;delta H&#39;</span><span class="p">}</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">iname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span> <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="n">calib_names</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">calib_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">basename</span><span class="o">==</span><span class="s1">&#39;dH0&#39;</span><span class="p">:</span>
                <span class="n">H0_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_energy</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
                <span class="c1"># H0 = 1e3*(val + H0_ref)</span>
                <span class="n">H0</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">H0_ref</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">H0</span>

            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phase_param_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">phase_param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_param_lookup</span><span class="p">[</span><span class="n">basename</span><span class="p">])</span>

            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">iphase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phases</span><span class="p">):</span>
            <span class="n">icalib_param_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_group</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;phase&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">ind</span><span class="p">)</span>

            <span class="c1"># icalib_param_values = self.param_values(</span>
            <span class="c1">#     param_group=icalib_param_names, scale_params=False)</span>
            <span class="n">icalib_param_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_values</span><span class="p">(</span>
                <span class="n">param_group</span><span class="o">=</span><span class="n">icalib_param_names</span><span class="p">,</span> <span class="n">scale_params</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">iphase_param_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">iphase_param_values</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">_add_set_params</span><span class="p">(</span><span class="s1">&#39;V0&#39;</span><span class="p">,</span> <span class="n">iphase</span><span class="p">,</span>
                            <span class="n">icalib_param_names</span><span class="p">,</span> <span class="n">icalib_param_values</span><span class="p">,</span>
                            <span class="n">iphase_param_names</span><span class="p">,</span> <span class="n">iphase_param_values</span><span class="p">)</span>
            <span class="n">_add_set_params</span><span class="p">(</span><span class="s1">&#39;S0&#39;</span><span class="p">,</span> <span class="n">iphase</span><span class="p">,</span>
                            <span class="n">icalib_param_names</span><span class="p">,</span> <span class="n">icalib_param_values</span><span class="p">,</span>
                            <span class="n">iphase_param_names</span><span class="p">,</span> <span class="n">iphase_param_values</span><span class="p">)</span>
            <span class="n">_add_set_params</span><span class="p">(</span><span class="s1">&#39;dH0&#39;</span><span class="p">,</span> <span class="n">iphase</span><span class="p">,</span>
                            <span class="n">icalib_param_names</span><span class="p">,</span> <span class="n">icalib_param_values</span><span class="p">,</span>
                            <span class="n">iphase_param_names</span><span class="p">,</span> <span class="n">iphase_param_values</span><span class="p">)</span>

            <span class="n">iphase</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="n">iphase_param_names</span><span class="p">,</span>
                                    <span class="n">param_values</span><span class="o">=</span><span class="n">iphase_param_values</span><span class="p">)</span>

        <span class="k">pass</span>
    <span class="c1">#===========================</span>
    <span class="k">def</span> <span class="nf">_get_param_group_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">param_group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_group</span><span class="p">(</span><span class="n">free</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>

        <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_group</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_group</span><span class="p">):</span>
            <span class="n">iloc</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span><span class="o">==</span><span class="n">name</span><span class="p">)</span>
            <span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">iloc</span>

        <span class="k">return</span> <span class="n">loc</span>

<div class="viewcode-block" id="Database.get_param_group"><a class="viewcode-back" href="../calibrate.html#calibrate.Database.get_param_group">[docs]</a>    <span class="k">def</span> <span class="nf">get_param_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        kind: [&#39;all&#39;, &#39;phase&#39;, &#39;rxn&#39;]</span>
<span class="sd">        id: [None, &#39;*&#39;, int]</span>
<span class="sd">        base: [None, str]</span>
<span class="sd">        free: [None, True, False]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span>

        <span class="k">def</span> <span class="nf">_get_param_mask</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;.*_&#39;</span><span class="o">+</span><span class="n">symbol</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="s1">&#39;[\*0-9]*&#39;</span><span class="p">,</span> <span class="n">iname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                     <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">id</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="s1">&#39;\*&#39;</span><span class="p">,</span> <span class="n">iname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                     <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)),</span> <span class="n">iname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                     <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">param_names</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">_get_param_mask</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;rxn&#39;</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">_get_param_mask</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;That is not a valid param_group kind.&#39;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">free</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">free</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span>

        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">param_names</span><span class="p">])</span>

        <span class="n">param_group</span> <span class="o">=</span> <span class="n">param_names</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">param_group</span></div>

    <span class="k">def</span> <span class="nf">scale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_values</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">param_scales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">(</span><span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">)</span>
        <span class="n">scaled_param_values</span> <span class="o">=</span> <span class="n">param_values</span><span class="o">*</span><span class="n">param_scales</span>
        <span class="k">return</span> <span class="n">scaled_param_values</span>

    <span class="k">def</span> <span class="nf">unscale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaled_param_values</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">param_scales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_scales</span><span class="p">(</span><span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">)</span>
        <span class="n">param_values</span> <span class="o">=</span> <span class="n">param_values</span><span class="o">/</span><span class="n">param_scales</span>
        <span class="k">return</span> <span class="n">param_values</span>

    <span class="k">def</span> <span class="nf">param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_names</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">param_scales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_scales</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">param_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_params</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>
        <span class="n">param_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">scale_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_params</span><span class="p">(</span><span class="n">param_values</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_values</span>

    <span class="k">def</span> <span class="nf">param_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_errors</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_param_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_values</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_param_values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_phase_params</span><span class="p">()</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">add_free_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">del_free_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_param_group_index</span><span class="p">(</span><span class="n">param_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_params</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">pass</span>
    <span class="c1">#===========================</span>
    <span class="k">def</span> <span class="nf">rxn_affinity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rxns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxns</span>
        <span class="n">rxn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_data</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">rxn_id</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rxn_id&#39;</span><span class="p">]</span>

        <span class="n">rxn_affinity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">irxn_id</span><span class="p">,</span> <span class="n">iT</span><span class="p">,</span> <span class="n">iP</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">)):</span>
            <span class="n">irxn</span> <span class="o">=</span> <span class="n">rxns</span><span class="p">[</span><span class="n">irxn_id</span><span class="p">]</span>
            <span class="n">rxn_affinity</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">irxn</span><span class="o">.</span><span class="n">affinity</span><span class="p">(</span><span class="n">iT</span><span class="p">,</span> <span class="n">iP</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rxn_affinity</span>

    <span class="k">def</span> <span class="nf">rxn_affinity_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rxns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxns</span>
        <span class="n">rxn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_data</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">P_err</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;P_err&#39;</span><span class="p">]</span>
        <span class="n">T_err</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;T_err&#39;</span><span class="p">]</span>
        <span class="n">rxn_id</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rxn_id&#39;</span><span class="p">]</span>

        <span class="n">affinity_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>

        <span class="c1"># from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">irxn_id</span><span class="p">,</span> <span class="n">iT</span><span class="p">,</span> <span class="n">iP</span><span class="p">,</span> <span class="n">iTerr</span><span class="p">,</span> <span class="n">iPerr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rxn_id</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T_err</span><span class="p">,</span> <span class="n">P_err</span><span class="p">)):</span>
            <span class="n">irxn</span> <span class="o">=</span> <span class="n">rxns</span><span class="p">[</span><span class="n">irxn_id</span><span class="p">]</span>
            <span class="n">irxn_vol</span> <span class="o">=</span> <span class="n">irxn</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">iT</span><span class="p">,</span> <span class="n">iP</span><span class="p">)</span>
            <span class="n">irxn_entropy</span> <span class="o">=</span> <span class="n">irxn</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">iT</span><span class="p">,</span> <span class="n">iP</span><span class="p">)</span>

            <span class="n">affinity_err</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">irxn_vol</span><span class="o">*</span><span class="n">iPerr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">irxn_entropy</span><span class="o">*</span><span class="n">iTerr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>


        <span class="k">return</span> <span class="n">affinity_err</span>

    <span class="k">def</span> <span class="nf">rxn_affinity_thresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rxns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxns</span>
        <span class="n">rxn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_data</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">P_err</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;P_err&#39;</span><span class="p">]</span>
        <span class="n">T_err</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">conditions</span><span class="p">[</span><span class="s1">&#39;T_err&#39;</span><span class="p">]</span>
        <span class="n">rxn_id</span> <span class="o">=</span> <span class="n">rxn_data</span><span class="o">.</span><span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rxn_id&#39;</span><span class="p">]</span>

        <span class="n">affinity_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_kinetics</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">affinity_thresh</span>


        <span class="c1"># # get universal reaction parameters</span>
        <span class="c1"># alpha_t_all   = param_d[&#39;alpha_t_rxn_all&#39;]</span>
        <span class="c1"># alpha_T_all   = param_d[&#39;alpha_T_rxn_all&#39;]</span>
        <span class="c1"># alpha_H2O_all = param_d[&#39;alpha_H2O_rxn_all&#39;]</span>

        <span class="c1"># for ind,(rxn_eqn, rxn_obj) in enumerate(zip(rxn_eqn_l,rxn_l)):</span>
        <span class="c1">#     msk_rxn = dat_d[&#39;rxn&#39;]==rxn_eqn</span>
        <span class="c1">#     idGrxn_a = rxn_obj.get_rxn_gibbs_energy(dat_d[&#39;T&#39;][msk_rxn],</span>
        <span class="c1">#                                             dat_d[&#39;P&#39;][msk_rxn],</span>
        <span class="c1">#                                             peratom=True )</span>
        <span class="c1">#     # idVrxn_a =  rxn_obj.get_rxn_volume(dat_d[&#39;T&#39;][msk_rxn],</span>
        <span class="c1">#     #                                    dat_d[&#39;P&#39;][msk_rxn],</span>
        <span class="c1">#     #                                    peratom=True )</span>
        <span class="c1">#     # idSrxn_a =  rxn_obj.get_rxn_entropy(dat_d[&#39;T&#39;][msk_rxn],</span>
        <span class="c1">#     #                                     dat_d[&#39;P&#39;][msk_rxn],</span>
        <span class="c1">#     #                                     peratom=True )</span>


        <span class="c1">#     # get reaction-specific parameters</span>
        <span class="c1">#     alpha_0_rxn = param_d[&#39;alpha_0_rxn&#39;+str(ind)]</span>
        <span class="c1">#     dalpha_t_rxn = param_d[&#39;dalpha_t_rxn&#39;+str(ind)]</span>
        <span class="c1">#     dalpha_T_rxn = param_d[&#39;dalpha_T_rxn&#39;+str(ind)]</span>
        <span class="c1">#     dalpha_H2O_rxn = param_d[&#39;dalpha_H2O_rxn&#39;+str(ind)]</span>

        <span class="c1">#     logGth_a[msk_rxn] = alpha_0_rxn \</span>
        <span class="c1">#         + (alpha_t_all+dalpha_t_rxn)*dat_d[&#39;time&#39;][msk_rxn] \</span>
        <span class="c1">#         + (alpha_T_all+dalpha_T_rxn)*dat_d[&#39;T&#39;][msk_rxn] \</span>
        <span class="c1">#         + (alpha_H2O_all+dalpha_H2O_rxn)*dat_d[&#39;water&#39;][msk_rxn]</span>

        <span class="c1">#     dGrxn_a[msk_rxn] = idGrxn_a</span>
        <span class="c1">#     # dVrxn_a[msk_rxn] = idVrxn_a</span>
        <span class="c1">#     # dSrxn_a[msk_rxn] = idSrxn_a</span>

        <span class="c1"># Gth_a = Gthresh_scl*np.exp(logGth_a)</span>
        <span class="c1"># # sigG_a = np.sqrt((dat_d[&#39;Perr&#39;]*dVrxn_a)**2+(dat_d[&#39;Terr&#39;]*dSrxn_a)**2)</span>

        <span class="c1"># loglk_a = np.zeros(Gth_a.size)</span>


        <span class="c1">#     loglk_a[msk_rxndir] = iloglk_a</span>


        <span class="c1"># # from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>
        <span class="c1"># for ind, (irxn_id, iT, iP, iTerr, iPerr) in enumerate(zip(rxn_id, T, P, T_err, P_err)):</span>
        <span class="c1">#     irxn = rxns[irxn_id]</span>
        <span class="c1">#     irxn_vol = irxn.volume(iT, iP)</span>
        <span class="c1">#     irxn_entropy = irxn.entropy(iT, iP)</span>

        <span class="c1">#     affinity_err[ind] = np.sqrt(</span>
        <span class="c1">#         (irxn_vol*iPerr)**2 + (irxn_entropy*iTerr)**2</span>
        <span class="c1">#     )</span>

        <span class="k">return</span> <span class="n">affinity_thresh</span>

    <span class="k">def</span> <span class="nf">eval_model_costfun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_values</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">):</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_values</span><span class="p">)</span>

        <span class="c1"># log_prior = -0.5*((param_values-np.array([29,-125, -3.5]))/10)**2</span>
        <span class="c1"># log_prior = -0.5*((param_values-np.array([5.147, 4.412, 4.983]))/0.1)**2</span>

        <span class="c1"># log_prior = -0.5*((param_values-np.array([1,1,1]))/0.02)**2</span>
        <span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">param_values</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">param_values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">log_prior</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">param_values</span><span class="o">-</span><span class="n">prior</span><span class="p">)</span><span class="o">/</span><span class="mf">0.02</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># param_values = 5*np.exp(param_values*1e-3)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_values</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">)</span>

        <span class="c1"># What about trust values?</span>

        <span class="n">affinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_affinity</span><span class="p">()</span>
        <span class="n">affinity_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_affinity_error</span><span class="p">()</span>
        <span class="n">affinity_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_affinity_thresh</span><span class="p">()</span>

        <span class="n">rxn_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_data</span><span class="o">.</span><span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rxn_dir&#39;</span><span class="p">]</span>
        <span class="n">log_like</span> <span class="o">=</span> <span class="n">Stats</span><span class="o">.</span><span class="n">logprob_rxn_dir</span><span class="p">(</span><span class="n">rxn_dir</span><span class="p">,</span> <span class="n">affinity</span><span class="p">,</span> <span class="n">affinity_err</span><span class="p">,</span>
                                         <span class="n">affinity_thresh</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="c1"># log_prior = -0.5*((param_values-np.array([29,-125, -3.5]))/1)**2</span>

        <span class="n">log_like_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>
        <span class="n">log_prior_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_prior</span><span class="p">)</span>

        <span class="c1"># log_prior = self.eval_log_prior()</span>

        <span class="n">cost_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">log_like</span><span class="p">,</span> <span class="o">-</span><span class="n">log_prior</span><span class="p">))</span>
        <span class="n">cost_tot</span> <span class="o">=</span> <span class="o">-</span> <span class="n">log_like_tot</span> <span class="o">-</span> <span class="n">log_prior_tot</span>

        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;cost_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_tot</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;cost_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_val</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;log_like&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_like</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;log_prior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_prior</span>

            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;log_prior_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_prior_tot</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;log_like_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_like_tot</span>

            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;affinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">affinity</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;affinity_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">affinity_err</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;affinity_thresh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">affinity_thresh</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cost_tot</span>

    <span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">):</span>

        <span class="c1"># Extract only trustworthy data</span>
        <span class="c1"># self._dat_trust_d = self.extract_trust_data()</span>

        <span class="n">params0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_values</span><span class="p">(</span><span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">)</span>
        <span class="c1"># params0 = np.log(params0/5)/1e-3</span>

        <span class="n">model_cost0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model_costfun</span><span class="p">(</span>
            <span class="n">params0</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print(params0)</span>
        <span class="c1"># print(model_cost0)</span>

        <span class="c1"># param0_unscale_a = self.get_param_values(free_params)</span>
        <span class="c1"># param0_a = self.unscale_params(param0_unscale_a, free_params)</span>
        <span class="c1"># param0_tbl = self.get_param_table(param_nm_a=free_params)</span>

        <span class="c1"># Precalculate approx Gibbs energy uncertainties</span>
        <span class="c1"># sigG_trust_a = self.propagate_data_errors(param0_unscale_a,</span>
        <span class="c1">#                                           free_params=free_params)</span>
        <span class="c1"># self._sigG_trust_a = sigG_trust_a</span>

        <span class="c1"># costfun = lambda params: self.eval_model_costfun_scl(</span>
        <span class="c1">#     params0, free_params=free_params)</span>

        <span class="c1"># lnprob_f = lambda param_a: -costfun(param_a)</span>

        <span class="n">costfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">params</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model_costfun</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span>
        <span class="c1"># method = &#39;BFGS&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">costfun</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mf">1e4</span><span class="p">})</span>

        <span class="c1"># set best-fit value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">param_group</span><span class="o">=</span><span class="n">param_group</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># def shift_one_param(shift,ind,mu_a=result.x,costfun=costfun):</span>
        <span class="c1">#     param_a = np.copy(mu_a)</span>
        <span class="c1">#     param_a[ind] += shift</span>
        <span class="c1">#     return costfun(param_a)</span>

        <span class="c1"># # Create re-scaled-shifted function for hessian</span>
        <span class="c1"># mu_a = result.x</span>
        <span class="c1"># cost0 = costfun(mu_a)</span>
        <span class="c1"># delx_param_scl = np.zeros(mu_a.shape)</span>
        <span class="c1"># dcost_target=1</span>
        <span class="c1"># for ind,param in enumerate(mu_a):</span>
        <span class="c1">#     del0 = 1e-2</span>
        <span class="c1">#     idelcostfun = lambda dx, ind=ind,target=dcost_target: \</span>
        <span class="c1">#         shift_one_param(dx,ind)-cost0-dcost_target</span>
        <span class="c1">#     delx = optim.fsolve(idelcostfun,del0)</span>
        <span class="c1">#     delx_param_scl[ind] = np.abs(delx)</span>


        <span class="c1"># norm_costfun = lambda dx_a, shift_scl=delx_param_scl,\</span>
        <span class="c1">#     mu_a=mu_a,costfun=costfun: costfun(dx_a*shift_scl+mu_a)</span>


        <span class="c1"># curv_scl_a = delx_param_scl*self.get_param_scl_values(free_params)</span>
        <span class="c1"># scl_mat_a = core.make_scale_matrix(curv_scl_a)</span>

        <span class="c1"># Hnorm_fun = nd.Hessian(norm_costfun,step = 1e-2)</span>
        <span class="c1"># Hnorm_a = Hnorm_fun(np.zeros(mu_a.shape))</span>

        <span class="c1"># covnorm_a = np.linalg.pinv(Hnorm_a)</span>

        <span class="c1"># cov_a = covnorm_a*scl_mat_a</span>

        <span class="c1"># try:</span>
        <span class="c1">#     err_a = np.sqrt(np.diag(cov_a))</span>
        <span class="c1">#     # print(cov_a)</span>
        <span class="c1">#     err_scl_a = core.make_scale_matrix(err_a)</span>
        <span class="c1">#     corr_a = cov_a/err_scl_a</span>
        <span class="c1"># except:</span>
        <span class="c1">#     err_a = None</span>
        <span class="c1">#     corr_a = None</span>

        <span class="c1"># # MCMC</span>
        <span class="c1"># # ndim = len(free_params)</span>
        <span class="c1"># # nwalkers = 10*ndim</span>
        <span class="c1"># # walker_pos0_a = [result[&#39;x&#39;] + 1e-4*np.random.randn(ndim)</span>
        <span class="c1"># #                  for i in range(nwalkers)]</span>
        <span class="c1"># # sampler = emcee.EnsembleSampler(nwalkers, ndim,lnprob_f)</span>
        <span class="c1"># # sampler.run_mcmc(walker_pos0_a,10)</span>


        <span class="c1"># # from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>

        <span class="c1"># paramf_unscale_a = self.scale_params(result.x, free_params)</span>
        <span class="c1"># self.set_param_values(paramf_unscale_a,free_params)</span>
        <span class="c1"># self._fit_result_d = result</span>

        <span class="c1"># if full_output:</span>

        <span class="c1">#     output_d = {}</span>
        <span class="c1">#     output_d[&#39;err_a&#39;] = err_a</span>
        <span class="c1">#     output_d[&#39;corr_a&#39;] = corr_a</span>

        <span class="c1">#     self._mu_a = paramf_unscale_a</span>
        <span class="c1">#     self._err_a = err_a</span>
        <span class="c1">#     self._corr_a = corr_a</span>

        <span class="c1">#     for key in self._param_error_d:</span>
        <span class="c1">#         self._param_error_d[key] = np.nan</span>

        <span class="c1">#     for key,err_val in zip(free_params,err_a):</span>
        <span class="c1">#         self._param_error_d[key] = err_val</span>

        <span class="c1">#     model_cost_d = self.eval_model_costfun(paramf_unscale_a,</span>
        <span class="c1">#                                            free_params=free_params,</span>
        <span class="c1">#                                            full_output=True)</span>
        <span class="c1">#     param_tbl = self.get_param_table(param_nm_a=free_params)</span>
        <span class="c1">#     param_all_tbl = self.get_param_table(typ=&#39;all&#39;)</span>

        <span class="c1">#     output_d[&#39;free_params&#39;] = free_params</span>

        <span class="c1">#     output_d[&#39;costval0&#39;] = model_cost0_d[&#39;cost_val&#39;]</span>
        <span class="c1">#     output_d[&#39;costdata0_df&#39;] = model_cost0_d[&#39;cost_data_df&#39;]</span>
        <span class="c1">#     output_d[&#39;param0_tbl&#39;] = param0_tbl</span>

        <span class="c1">#     output_d[&#39;costval&#39;] = model_cost_d[&#39;cost_val&#39;]</span>
        <span class="c1">#     output_d[&#39;costdata_df&#39;] = model_cost_d[&#39;cost_data_df&#39;]</span>
        <span class="c1">#     output_d[&#39;prior_df&#39;] = model_cost_d[&#39;prior_df&#39;]</span>
        <span class="c1">#     output_d[&#39;param_tbl&#39;] = param_tbl</span>
        <span class="c1">#     output_d[&#39;param_all_tbl&#39;] = param_all_tbl</span>

        <span class="c1">#     output_d[&#39;result&#39;] = result</span>

        <span class="c1">#     # output_d[&#39;param_d&#39;] = copy.copy(self._param_d)</span>
        <span class="c1">#     # output_d[&#39;param0_a&#39;] = param0_a</span>
        <span class="c1">#     # output_d[&#39;paramf_a&#39;] = result.x</span>
        <span class="c1">#     # output_d[&#39;param0_unscl_a&#39;] = param0_unscale_a</span>
        <span class="c1">#     # output_d[&#39;paramf_unscl_a&#39;] = paramf_unscale_a</span>

        <span class="c1">#     return output_d</span>

        <span class="k">pass</span></div>
<span class="c1">#===================================================</span>
<span class="k">class</span> <span class="nc">Stats</span><span class="p">:</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">logprior_fun</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;studentt&#39;</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;studentt&#39;</span><span class="p">:</span>
            <span class="c1"># Variance of student&#39;s t distribution is slightly larger than a</span>
            <span class="c1"># normal (depending on dof). Thus the relative residual x must be</span>
            <span class="c1"># scaled down to match the desired standard deviation.</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">dof</span><span class="o">/</span><span class="p">(</span><span class="n">dof</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">const</span><span class="p">,</span><span class="n">dof</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;erf&#39;</span><span class="p">):</span>
            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">log_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log_prob</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rxn_trans_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;logistic&#39;</span><span class="p">:</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mf">1.8138</span> <span class="c1"># pi/sqrt(3)</span>
            <span class="c1"># F_a = 1.0/(1+np.exp(-const*x))</span>
            <span class="c1"># Special optimized version of logistic function</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">expit</span><span class="p">(</span><span class="n">const</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;erf&#39;</span><span class="p">):</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mf">0.70711</span> <span class="c1"># 1/sqrt(2)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">const</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">prob</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rxn_logtrans_fun</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;logistic&#39;</span><span class="p">:</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mf">1.8138</span> <span class="c1"># pi/sqrt(3)</span>
            <span class="c1"># Special optimized version of logistic function</span>
            <span class="n">log_prob</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">const</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;erf&#39;</span><span class="p">):</span>
            <span class="n">const</span> <span class="o">=</span> <span class="mf">0.70711</span> <span class="c1"># 1/sqrt(2)</span>
            <span class="c1"># Special optimized version of log-cdf for normal distribution</span>
            <span class="n">log_prob</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">log_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log_prob</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">logprob_rxn_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rxn_dir</span><span class="p">,</span> <span class="n">affinity</span><span class="p">,</span> <span class="n">affinity_err</span><span class="p">,</span> <span class="n">affinity_thresh</span><span class="p">,</span>
                        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        rxndir = [&#39;FWD&#39;, &#39;REV&#39;, &#39;NC&#39;, &#39;FWD?&#39;, &#39;REV?&#39;, &#39;NC?&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">shp</span> <span class="o">=</span> <span class="n">affinity</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">x_fwd</span> <span class="o">=</span> <span class="p">(</span><span class="n">affinity</span><span class="o">-</span><span class="n">affinity_thresh</span><span class="p">)</span><span class="o">/</span><span class="n">affinity_err</span>
        <span class="n">x_rev</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">affinity</span><span class="o">+</span><span class="n">affinity_thresh</span><span class="p">)</span><span class="o">/</span><span class="n">affinity_err</span>

        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
        <span class="n">log_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rxn_logtrans_fun</span><span class="p">(</span>
            <span class="n">x_fwd</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rxn_logtrans_fun</span><span class="p">(</span>
            <span class="n">x_rev</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;BIASED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">rxn_logtrans_fun</span><span class="p">(</span><span class="n">x_rev</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD?&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">),</span>
                <span class="n">zeros</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD?&#39;</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD?&#39;</span><span class="p">],</span> <span class="o">+</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;FWD?&#39;</span><span class="p">])))</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">rxn_logtrans_fun</span><span class="p">(</span><span class="n">x_fwd</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">),</span>
                <span class="n">zeros</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">],</span> <span class="o">+</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">])))</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;NC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">rxn_logtrans_fun</span><span class="p">(</span><span class="n">x_fwd</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">),</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">rxn_logtrans_fun</span><span class="p">(</span><span class="n">x_rev</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">),</span>
                <span class="n">zeros</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">],</span> <span class="o">-</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">],</span> <span class="o">+</span><span class="n">ones</span><span class="p">[</span><span class="n">rxn_dir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">])))</span>

        <span class="n">log_prob</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">log_prob</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="c1"># from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>

        <span class="k">return</span> <span class="n">log_prob</span>
<span class="c1">#===================================================</span>
<span class="k">class</span> <span class="nc">Database_OLD</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_data</span><span class="p">,</span> <span class="n">thermoDB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_kinetics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">contaminant_phases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="s1">&#39;logistic&#39;</span><span class="p">,</span>
                 <span class="n">Tscl_energy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">thermoDB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thermoDB</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Database</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_data</span> <span class="o">=</span> <span class="n">rxn_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thermoDB</span> <span class="o">=</span> <span class="n">thermoDB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_kinetics</span> <span class="o">=</span> <span class="n">ignore_kinetics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contaminant_phases</span> <span class="o">=</span> <span class="n">contaminant_phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span> <span class="o">=</span> <span class="n">rxn_trans_typ</span>


        <span class="c1"># self.datadir = DATADIR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Escl</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">RGAS</span><span class="o">*</span><span class="n">Tscl_energy</span>


        <span class="c1"># self.Gthresh_scl = 3.0/2*Rgas*Tthresh_scl</span>
        <span class="c1"># self.Gthresh_scl = self.Escl</span>

        <span class="c1"># dat_df, rxn_d_l, phasesym_l = self.filter_phase_rev_data(</span>
        <span class="c1">#     raw_df, mask_phs_l=mask_phs_l)</span>
        <span class="c1"># self._dat_trust_d = self.extract_trust_data()</span>

        <span class="c1"># self.load_exp_prior_data()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_model_phases</span><span class="p">(</span><span class="n">phasesym_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_model_rxns</span><span class="p">(</span><span class="n">rxn_d_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_exp_priors</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_param_scl</span><span class="p">()</span>

        <span class="n">param_error_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param_error_d</span><span class="p">:</span>
            <span class="n">param_error_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_param_error_d</span> <span class="o">=</span> <span class="n">param_error_d</span>

        <span class="n">param_name_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_param_a</span> <span class="o">=</span> <span class="n">param_name_a</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">load_exp_prior_data</span><span class="p">()</span>

        <span class="c1"># sigG_trust_a = self.propagate_data_errors(param0_unscale_a)</span>
        <span class="c1"># self._sigG_trust_a = sigG_trust_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigG_trust_a</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">load_exp_prior_data</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">datadir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
        <span class="n">filenm</span> <span class="o">=</span> <span class="s1">&#39;ExpPriorData.xlsx&#39;</span>


        <span class="n">parentpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">pathnm</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parentpath</span><span class="p">,</span><span class="n">datadir</span><span class="p">,</span><span class="n">filenm</span><span class="p">)</span>
        <span class="n">exp_prior_data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">pathnm</span><span class="p">,</span><span class="n">sheetname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Cycle through sheets, each representing a different parameter</span>
        <span class="n">all_prior_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">paramnm</span> <span class="ow">in</span> <span class="n">exp_prior_data_df</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">paramnm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">paramnm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;&gt;&#39;</span><span class="p">):</span>
                <span class="c1"># This sheet provides metadata (such as references) rather than</span>
                <span class="c1"># actual priors</span>
                <span class="k">continue</span>

            <span class="n">data_df</span> <span class="o">=</span> <span class="n">exp_prior_data_df</span><span class="p">[</span><span class="n">paramnm</span><span class="p">]</span>
            <span class="n">param_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">paramnm</span><span class="p">,</span><span class="n">data_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_s</span>
            <span class="n">prior_data_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[[</span><span class="s1">&#39;Phase&#39;</span><span class="p">,</span><span class="s1">&#39;Abbrev&#39;</span><span class="p">,</span><span class="s1">&#39;Param&#39;</span><span class="p">,</span><span class="s1">&#39;Trust&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Data&#39;</span><span class="p">,</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span><span class="s1">&#39;Ref&#39;</span><span class="p">]]</span>

            <span class="n">all_prior_df</span> <span class="o">=</span> <span class="n">all_prior_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prior_data_df</span><span class="p">)</span>

            <span class="c1"># phssym_a = data_df[&#39;Abbrev&#39;]</span>
            <span class="c1"># val_a = data_df[&#39;Data&#39;]</span>
            <span class="c1"># err_a = data_df[&#39;Error&#39;]</span>
            <span class="c1"># trust_a = data_df[&#39;Trust&#39;]</span>
            <span class="c1"># refID_a = data_df[&#39;RefID&#39;]</span>

            <span class="c1"># for sym in phssym_a:</span>
            <span class="c1"># prior_d = {&#39;refID&#39;:refID_a,&#39;phase_sym&#39;:phssym_a,&#39;value&#39;:val_a,</span>
            <span class="c1">#            &#39;error&#39;:err_a,&#39;trust&#39;:trust_a}</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">all_prior_df</span> <span class="o">=</span> <span class="n">all_prior_df</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_exp_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_prior_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_prior_df</span>
        <span class="n">exp_prior_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">phs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phs_key</span><span class="p">):</span>
            <span class="n">prior_dat_phs_df</span> <span class="o">=</span> <span class="n">all_prior_df</span><span class="p">[</span><span class="n">all_prior_df</span><span class="p">[</span><span class="s1">&#39;Abbrev&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">phs</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">param_name_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">prior_dat_phs_df</span><span class="p">[</span><span class="s1">&#39;Param&#39;</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
            <span class="n">prior_dat_phs_df</span><span class="p">[</span><span class="s1">&#39;Param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_name_s</span>
            <span class="n">exp_prior_df</span> <span class="o">=</span> <span class="n">exp_prior_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prior_dat_phs_df</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># print(prior_dat_phs_df)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span> <span class="o">=</span> <span class="n">exp_prior_df</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_param_scl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">param_name_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c1"># Define the scale for each type of parameter</span>
        <span class="n">S0_param_keys_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_name_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">param_name_a</span><span class="p">,</span><span class="s1">&#39;S0_phs&#39;</span><span class="p">)])</span>
        <span class="n">V0_param_keys_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_name_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">param_name_a</span><span class="p">,</span><span class="s1">&#39;V0_phs&#39;</span><span class="p">)])</span>
        <span class="n">dH0_param_keys_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_name_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">param_name_a</span><span class="p">,</span><span class="s1">&#39;dH0_phs&#39;</span><span class="p">)])</span>

        <span class="n">S0_scl_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">S0_param_keys_a</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Natom_a</span><span class="p">)</span>
        <span class="n">V0_scl_atom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">V0_param_keys_a</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Natom_a</span><span class="p">)</span>
        <span class="c1"># dH0_a = self.get_param_values(dH0_param_keys_a)/self.Natom_a</span>
        <span class="c1"># dH0_scl_atom = 3./2*Rgas*1e1</span>
        <span class="n">dH0_scl_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Escl</span>

        <span class="c1"># alpha_T_scl = 1.0/1000 # 1/K</span>
        <span class="n">alpha_T_scl</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.0</span> <span class="c1"># 1/K</span>
        <span class="n">alpha_t_scl</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">alpha_H2O_scl</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">alpha_0_scl</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">param_scl_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">phs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_l</span><span class="p">):</span>
            <span class="n">Natom</span><span class="o">=</span><span class="n">phs</span><span class="o">.</span><span class="n">props_d</span><span class="p">[</span><span class="s1">&#39;Natom&#39;</span><span class="p">]</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;S0_phs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">S0_scl_atom</span><span class="o">*</span><span class="n">Natom</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;V0_phs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">V0_scl_atom</span><span class="o">*</span><span class="n">Natom</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;dH0_phs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dH0_scl_atom</span><span class="o">*</span><span class="n">Natom</span>



        <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;alpha_t_rxn_all&#39;</span><span class="p">]</span>   <span class="o">=</span><span class="n">alpha_t_scl</span>
        <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;alpha_T_rxn_all&#39;</span><span class="p">]</span>   <span class="o">=</span><span class="n">alpha_T_scl</span>
        <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;alpha_H2O_rxn_all&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">alpha_H2O_scl</span>

        <span class="c1"># logGth_rxn = log(3/2*Rgas*1) + alpha_i*X_i</span>
        <span class="n">rxn_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn_l</span><span class="p">):</span>
            <span class="c1"># self._param_d[&#39;logGth0_rxn&#39;+str(ind)] = -</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;alpha_0_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>   <span class="o">=</span> <span class="n">alpha_0_scl</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;dalpha_t_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>   <span class="o">=</span> <span class="n">alpha_t_scl</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;dalpha_T_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>   <span class="o">=</span> <span class="n">alpha_T_scl</span>
            <span class="n">param_scl_d</span><span class="p">[</span><span class="s1">&#39;dalpha_H2O_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">alpha_H2O_scl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">param_scl_d</span> <span class="o">=</span> <span class="n">param_scl_d</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_model_phases</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">phasesym_l</span> <span class="p">):</span>
        <span class="n">phase_l</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermoDB</span><span class="o">.</span><span class="n">new_phase</span><span class="p">(</span><span class="n">phasesym</span><span class="p">)</span> <span class="k">for</span> <span class="n">phasesym</span> <span class="ow">in</span> <span class="n">phasesym_l</span><span class="p">]</span>
        <span class="n">Natom_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">phs</span><span class="o">.</span><span class="n">props_d</span><span class="p">[</span><span class="s1">&#39;Natom&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">phs</span> <span class="ow">in</span> <span class="n">phase_l</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_phasesym_l</span> <span class="o">=</span> <span class="n">phasesym_l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_l</span> <span class="o">=</span> <span class="n">phase_l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Natom_a</span> <span class="o">=</span> <span class="n">Natom_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_std_state_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_std_state_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phase_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_l</span>
        <span class="n">phasesym_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">phs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_l</span><span class="p">):</span>
            <span class="n">iparam_a</span> <span class="o">=</span> <span class="n">phs</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span> <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;delta H&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">phasesym_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phs</span><span class="o">.</span><span class="n">props_d</span><span class="p">[</span><span class="s1">&#39;abbrev&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;S0_phs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">iparam_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;V0_phs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">iparam_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;dH0_phs&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="n">iparam_a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_model_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_d_l</span><span class="p">):</span>
        <span class="n">rxn_obj_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rxn_eqn_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rxn_d</span> <span class="ow">in</span> <span class="n">rxn_d_l</span><span class="p">:</span>
            <span class="n">rxn_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermoDB</span><span class="o">.</span><span class="n">new_rxn</span><span class="p">(</span> <span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;reac_l&#39;</span><span class="p">],</span> <span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;prod_l&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">rxn_obj_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_obj</span><span class="p">)</span>
            <span class="n">rxn_eqn_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;rxn_eqn&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span> <span class="o">=</span> <span class="n">rxn_obj_l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rxn_eqn_l</span> <span class="o">=</span> <span class="n">rxn_eqn_l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_rxn_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">init_rxn_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dTthresh0</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;alpha_t_rxn_all&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;alpha_T_rxn_all&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;alpha_H2O_rxn_all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># logGth_rxn = log(3/2*Rgas*1) + alpha_i*X_i</span>
        <span class="n">rxn_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn_l</span><span class="p">):</span>
            <span class="c1"># self._param_d[&#39;logGth0_rxn&#39;+str(ind)] = -</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;alpha_0_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>   <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;dalpha_t_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>   <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;dalpha_T_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>   <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="s1">&#39;dalpha_H2O_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rxn_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rxn_eqn_l</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phs_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phasesym_l</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">)</span>
    <span class="c1">#########</span>

    <span class="k">def</span> <span class="nf">get_param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="c1"># typ = [&#39;all&#39;,&#39;free&#39;,&#39;rxn&#39;,&#39;phs&#39;,&#39;rxnadj&#39;,&#39;rxnall&#39;]</span>
        <span class="n">param_names_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">param_names_typ_a</span> <span class="o">=</span> <span class="n">param_names_a</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span>
                <span class="n">param_names_typ_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_param_a</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;rxn&#39;</span><span class="p">:</span>
                <span class="n">param_names_typ_a</span> <span class="o">=</span> \
                    <span class="n">param_names_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">param_names_a</span><span class="p">,</span><span class="s1">&#39;_rxn&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;rxnadj&#39;</span><span class="p">:</span>
                <span class="n">param_names_typ_a</span> <span class="o">=</span> \
                    <span class="n">param_names_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">param_names_a</span><span class="p">,</span><span class="s1">&#39;dalpha&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;rxnall&#39;</span><span class="p">:</span>
                <span class="n">param_names_typ_a</span> <span class="o">=</span> \
                    <span class="n">param_names_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">param_names_a</span><span class="p">,</span><span class="s1">&#39;_rxn_all&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;phs&#39;</span><span class="p">:</span>
                <span class="n">param_names_typ_a</span> <span class="o">=</span> \
                    <span class="n">param_names_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">param_names_a</span><span class="p">,</span><span class="s1">&#39;_phs&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="n">typ</span><span class="o">+</span><span class="s1">&#39; is not a valid param typ for get_param_names.&#39;</span>

        <span class="c1"># Finally, sort params into sensible order</span>
        <span class="c1"># msk_phs_a = np.char.find(param_names_typ_a,&#39;_phs&#39;)&gt;=0</span>
        <span class="c1"># msk_rxn_all_a = np.char.find(param_names_typ_a,&#39;_rxn_all&#39;)&gt;=0</span>
        <span class="c1"># msk_rxn_a = np.char.find(param_names_typ_a,&#39;_rxn&#39;)&gt;=0</span>
        <span class="n">msk_phs_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">istr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_phs&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">istr</span> <span class="ow">in</span> <span class="n">param_names_typ_a</span><span class="p">])</span>
        <span class="n">msk_rxn_all_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">istr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_rxn_all&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">istr</span> <span class="ow">in</span> <span class="n">param_names_typ_a</span><span class="p">])</span>
        <span class="n">msk_rxn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">istr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_rxn&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">istr</span> <span class="ow">in</span> <span class="n">param_names_typ_a</span><span class="p">])</span>

        <span class="n">msk_rxn_a</span> <span class="o">=</span> <span class="n">msk_rxn_a</span><span class="o">*~</span><span class="n">msk_rxn_all_a</span>
        <span class="n">msk_other_a</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">msk_phs_a</span><span class="p">,</span><span class="n">msk_rxn_all_a</span><span class="p">,</span><span class="n">msk_rxn_a</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">param_names_sort_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk_phs_a</span><span class="p">)):</span>
            <span class="n">param_names_sort_a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_names_typ_a</span><span class="p">[</span><span class="n">msk_phs_a</span><span class="p">]))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk_rxn_all_a</span><span class="p">)):</span>
            <span class="n">param_names_sort_a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_names_typ_a</span><span class="p">[</span><span class="n">msk_rxn_all_a</span><span class="p">]))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk_rxn_a</span><span class="p">)):</span>
            <span class="n">param_names_sort_a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_names_typ_a</span><span class="p">[</span><span class="n">msk_rxn_a</span><span class="p">]))</span>
        <span class="k">if</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">msk_other_a</span><span class="p">)):</span>
            <span class="n">param_names_sort_a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">param_names_typ_a</span><span class="p">[</span><span class="n">msk_other_a</span><span class="p">]))</span>

        <span class="n">param_names_sort_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_names_sort_a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">param_names_sort_a</span>

    <span class="k">def</span> <span class="nf">get_param_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_key_a</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_key_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">param_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param_key_a</span><span class="p">:</span>
            <span class="n">param_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_param_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_key_a</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_key_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">error_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param_key_a</span><span class="p">:</span>
            <span class="n">error_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_error_d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">error_a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_param_scl_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_key_a</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_key_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">param_scl_a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param_key_a</span><span class="p">:</span>
            <span class="n">param_scl_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_scl_d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">param_scl_a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_param_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_nm_a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">param_nm_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_nm_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">param_val_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">param_nm_a</span><span class="p">)</span>
        <span class="n">param_scl_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_scl_values</span><span class="p">(</span><span class="n">param_nm_a</span><span class="p">)</span>
        <span class="n">scaled_param_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unscale_params</span><span class="p">(</span><span class="n">param_val_a</span><span class="p">,</span> <span class="n">param_nm_a</span><span class="p">)</span>
        <span class="n">err_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_errors</span><span class="p">(</span><span class="n">param_nm_a</span><span class="p">)</span>

        <span class="n">param_tbl_d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">param_nm_a</span><span class="p">,</span>
                       <span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">param_val_a</span><span class="p">,</span>
                       <span class="s1">&#39;error&#39;</span><span class="p">:</span><span class="n">err_a</span><span class="p">,</span>
                       <span class="s1">&#39;scale&#39;</span><span class="p">:</span><span class="n">param_scl_a</span><span class="p">,</span>
                       <span class="s1">&#39;scaled value&#39;</span><span class="p">:</span><span class="n">scaled_param_a</span><span class="p">}</span>
        <span class="n">param_tbl_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">param_tbl_d</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;scale&#39;</span><span class="p">,</span><span class="s1">&#39;scaled value&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">param_tbl_df</span>

    <span class="k">def</span> <span class="nf">set_param_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_val_a</span><span class="p">,</span> <span class="n">param_key_a</span> <span class="p">):</span>
        <span class="c1"># print(param_val_a)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_key_a</span><span class="p">,</span> <span class="n">param_val_a</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;phs&#39;</span><span class="p">)</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_phaseobj_param</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">set_phaseobj_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_val</span><span class="p">,</span> <span class="n">param_key</span><span class="p">):</span>
        <span class="n">phsid</span> <span class="o">=</span> <span class="s1">&#39;phs&#39;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">param_key</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">phsid</span><span class="p">)</span>
        <span class="n">phs_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_key</span><span class="p">[</span><span class="n">loc</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">phsid</span><span class="p">):])</span>
        <span class="n">iphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_l</span><span class="p">[</span><span class="n">phs_ind</span><span class="p">]</span>
        <span class="c1"># print(param_key)</span>
        <span class="c1"># print(param_val)</span>

        <span class="k">if</span> <span class="n">param_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;S0&#39;</span><span class="p">):</span>
            <span class="n">iphs</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">],</span><span class="n">param_values</span><span class="o">=</span><span class="p">[</span><span class="n">param_val</span><span class="p">])</span>
            <span class="c1"># print(iphs.get_param_values(param_names=[&#39;S&#39;]))</span>

        <span class="k">elif</span> <span class="n">param_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;V0&#39;</span><span class="p">):</span>
            <span class="n">iphs</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">],</span><span class="n">param_values</span><span class="o">=</span><span class="p">[</span><span class="n">param_val</span><span class="p">])</span>
            <span class="c1"># print(iphs.get_param_values(param_names=[&#39;V&#39;]))</span>

        <span class="k">elif</span> <span class="n">param_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dH0&#39;</span><span class="p">):</span>
            <span class="n">initval</span><span class="o">=</span> <span class="n">iphs</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;delta H&#39;</span><span class="p">])</span>
            <span class="n">initgibbs</span> <span class="o">=</span> <span class="n">iphs</span><span class="o">.</span><span class="n">get_gibbs_energy</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">iphs</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;delta H&#39;</span><span class="p">],</span><span class="n">param_values</span><span class="o">=</span><span class="p">[</span><span class="n">param_val</span><span class="p">])</span>
            <span class="n">setval</span> <span class="o">=</span> <span class="n">iphs</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;delta H&#39;</span><span class="p">])</span>

            <span class="n">setgibbs</span> <span class="o">=</span> <span class="n">iphs</span><span class="o">.</span><span class="n">get_gibbs_energy</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># print(initval,setval,setval-initval)</span>
            <span class="c1"># print(&#39;%%%%%&#39;)</span>
            <span class="c1"># print(initgibbs,setgibbs,setgibbs-initgibbs)</span>
            <span class="c1"># print(&#39;============&#39;)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="n">param_key</span><span class="o">+</span><span class="s1">&#39; is not a valid phase parameter name.&#39;</span>


        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">add_free_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_free_param_a</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_free_param_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">free_param_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_free_param_a</span><span class="p">,</span><span class="n">new_free_param_a</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_param_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">free_param_a</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">del_free_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fix_param_a</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fix_param_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

        <span class="n">free_param_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_param_a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_free_param_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">free_param_a</span><span class="p">,</span> <span class="n">fix_param_a</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="c1">#########</span>

    <span class="k">def</span> <span class="nf">extract_trust_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_df</span>

        <span class="n">trust_msk</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Trust&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Yes&#39;</span>

        <span class="c1"># print(data_df[trust_msk])</span>
        <span class="c1"># test_df = data_df[trust_msk].set_index(&#39;Rxn&#39;)</span>
        <span class="c1"># print(test_df)</span>

        <span class="c1"># NEED TO CAST as FLOAT!!</span>
        <span class="n">num_dat_df</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[[</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;P_err&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;T_err&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;equil_time&#39;</span><span class="p">]][</span><span class="n">trust_msk</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="n">P_a</span> <span class="o">=</span> <span class="mf">1e3</span><span class="o">*</span><span class="n">num_dat_df</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Perr_a</span> <span class="o">=</span> <span class="mf">1e3</span><span class="o">*</span><span class="n">num_dat_df</span><span class="p">[</span><span class="s1">&#39;P_err&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">T_a</span> <span class="o">=</span> <span class="mf">273.15</span><span class="o">+</span><span class="n">num_dat_df</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Terr_a</span> <span class="o">=</span> <span class="n">num_dat_df</span><span class="p">[</span><span class="s1">&#39;T_err&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># time_a = np.log10(num_dat_df[&#39;equil_time&#39;].values) # NOTE: use log time</span>
        <span class="n">time_a</span> <span class="o">=</span> <span class="n">num_dat_df</span><span class="p">[</span><span class="s1">&#39;equil_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># NOTE: use log time</span>

        <span class="n">pubid_a</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;PubID&#39;</span><span class="p">][</span><span class="n">trust_msk</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">run_num_a</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Run Num.&#39;</span><span class="p">][</span><span class="n">trust_msk</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">rxn_dir_a</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;rxn_dir&#39;</span><span class="p">][</span><span class="n">trust_msk</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">rxn_a</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">][</span><span class="n">trust_msk</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># NOTE: need to fix Water flag to flux_amt</span>
        <span class="n">water_a</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;Water&#39;</span><span class="p">][</span><span class="n">trust_msk</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">water_flag_a</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">water_a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">water_flag_a</span><span class="p">[</span><span class="n">water_a</span><span class="o">==</span><span class="s1">&#39;dry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">water_flag_a</span><span class="p">[</span><span class="n">water_a</span><span class="o">==</span><span class="s1">&#39;trace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">data_trust_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;pubid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pubid_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;run_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_num_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;Perr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Perr_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;Terr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Terr_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;rxn_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn_dir_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;rxn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn_a</span>
        <span class="n">data_trust_d</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">water_flag_a</span>

        <span class="k">return</span> <span class="n">data_trust_d</span>

    <span class="k">def</span> <span class="nf">fit_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">free_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">free_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">)</span>

        <span class="c1"># if not np.any([startswith(fix_param,&#39;dH0&#39;) for fix_param in fix_param_a]):</span>
        <span class="c1">#     assert False, &#39;User MUST fix some of the Std. State enthalpy params, dH0_X, relative to the elements.&#39;</span>

        <span class="c1"># Extract only trustworthy data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dat_trust_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_trust_data</span><span class="p">()</span>

        <span class="n">param0_unscale_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">free_params</span><span class="p">)</span>
        <span class="n">param0_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unscale_params</span><span class="p">(</span><span class="n">param0_unscale_a</span><span class="p">,</span> <span class="n">free_params</span><span class="p">)</span>
        <span class="n">param0_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_table</span><span class="p">(</span><span class="n">param_nm_a</span><span class="o">=</span><span class="n">free_params</span><span class="p">)</span>


        <span class="c1"># Precalculate approx Gibbs energy uncertainties</span>
        <span class="n">sigG_trust_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagate_data_errors</span><span class="p">(</span><span class="n">param0_unscale_a</span><span class="p">,</span>
                                                  <span class="n">free_params</span><span class="o">=</span><span class="n">free_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sigG_trust_a</span> <span class="o">=</span> <span class="n">sigG_trust_a</span>

        <span class="n">model_cost0_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model_costfun</span><span class="p">(</span><span class="n">param0_unscale_a</span><span class="p">,</span>
                                                <span class="n">free_params</span><span class="o">=</span><span class="n">free_params</span><span class="p">,</span>
                                                <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">costfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">param_a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model_costfun_scl</span><span class="p">(</span><span class="n">param_a</span><span class="p">,</span>
                                                              <span class="n">free_params</span><span class="o">=</span><span class="n">free_params</span><span class="p">)</span>

        <span class="n">lnprob_f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">param_a</span><span class="p">:</span> <span class="o">-</span><span class="n">costfun</span><span class="p">(</span><span class="n">param_a</span><span class="p">)</span>

        <span class="c1"># costfun = self.eval_model_costfun_scl( param_free_vals_scl_a,</span>
        <span class="c1">#                                       free_params=free_params )</span>

        <span class="c1"># method = &#39;Nelder-Mead&#39;</span>
        <span class="c1"># method = &#39;BFGS&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">costfun</span><span class="p">,</span><span class="n">param0_a</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mf">1e4</span><span class="p">})</span>

        <span class="k">def</span> <span class="nf">shift_one_param</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="n">mu_a</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">costfun</span><span class="o">=</span><span class="n">costfun</span><span class="p">):</span>
            <span class="n">param_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mu_a</span><span class="p">)</span>
            <span class="n">param_a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="k">return</span> <span class="n">costfun</span><span class="p">(</span><span class="n">param_a</span><span class="p">)</span>

        <span class="c1"># Create re-scaled-shifted function for hessian</span>
        <span class="n">mu_a</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
        <span class="n">cost0</span> <span class="o">=</span> <span class="n">costfun</span><span class="p">(</span><span class="n">mu_a</span><span class="p">)</span>
        <span class="n">delx_param_scl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mu_a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">dcost_target</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mu_a</span><span class="p">):</span>
            <span class="n">del0</span> <span class="o">=</span> <span class="mf">1e-2</span>
            <span class="n">idelcostfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dx</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span><span class="n">target</span><span class="o">=</span><span class="n">dcost_target</span><span class="p">:</span> \
                <span class="n">shift_one_param</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">ind</span><span class="p">)</span><span class="o">-</span><span class="n">cost0</span><span class="o">-</span><span class="n">dcost_target</span>
            <span class="n">delx</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">idelcostfun</span><span class="p">,</span><span class="n">del0</span><span class="p">)</span>
            <span class="n">delx_param_scl</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delx</span><span class="p">)</span>


        <span class="n">norm_costfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dx_a</span><span class="p">,</span> <span class="n">shift_scl</span><span class="o">=</span><span class="n">delx_param_scl</span><span class="p">,</span>\
            <span class="n">mu_a</span><span class="o">=</span><span class="n">mu_a</span><span class="p">,</span><span class="n">costfun</span><span class="o">=</span><span class="n">costfun</span><span class="p">:</span> <span class="n">costfun</span><span class="p">(</span><span class="n">dx_a</span><span class="o">*</span><span class="n">shift_scl</span><span class="o">+</span><span class="n">mu_a</span><span class="p">)</span>


        <span class="n">curv_scl_a</span> <span class="o">=</span> <span class="n">delx_param_scl</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">get_param_scl_values</span><span class="p">(</span><span class="n">free_params</span><span class="p">)</span>
        <span class="n">scl_mat_a</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">make_scale_matrix</span><span class="p">(</span><span class="n">curv_scl_a</span><span class="p">)</span>

        <span class="n">Hnorm_fun</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">norm_costfun</span><span class="p">,</span><span class="n">step</span> <span class="o">=</span> <span class="mf">1e-2</span><span class="p">)</span>
        <span class="n">Hnorm_a</span> <span class="o">=</span> <span class="n">Hnorm_fun</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mu_a</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">covnorm_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">Hnorm_a</span><span class="p">)</span>

        <span class="n">cov_a</span> <span class="o">=</span> <span class="n">covnorm_a</span><span class="o">*</span><span class="n">scl_mat_a</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">err_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_a</span><span class="p">))</span>
            <span class="c1"># print(cov_a)</span>
            <span class="n">err_scl_a</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">make_scale_matrix</span><span class="p">(</span><span class="n">err_a</span><span class="p">)</span>
            <span class="n">corr_a</span> <span class="o">=</span> <span class="n">cov_a</span><span class="o">/</span><span class="n">err_scl_a</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">err_a</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">corr_a</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># MCMC</span>
        <span class="c1"># ndim = len(free_params)</span>
        <span class="c1"># nwalkers = 10*ndim</span>
        <span class="c1"># walker_pos0_a = [result[&#39;x&#39;] + 1e-4*np.random.randn(ndim)</span>
        <span class="c1">#                  for i in range(nwalkers)]</span>
        <span class="c1"># sampler = emcee.EnsembleSampler(nwalkers, ndim,lnprob_f)</span>
        <span class="c1"># sampler.run_mcmc(walker_pos0_a,10)</span>


        <span class="c1"># from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>

        <span class="n">paramf_unscale_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_params</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">free_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">paramf_unscale_a</span><span class="p">,</span><span class="n">free_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_result_d</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>

            <span class="n">output_d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;err_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err_a</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;corr_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_a</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_mu_a</span> <span class="o">=</span> <span class="n">paramf_unscale_a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_err_a</span> <span class="o">=</span> <span class="n">err_a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_corr_a</span> <span class="o">=</span> <span class="n">corr_a</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_error_d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_param_error_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">err_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">free_params</span><span class="p">,</span><span class="n">err_a</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_param_error_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">err_val</span>

            <span class="n">model_cost_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model_costfun</span><span class="p">(</span><span class="n">paramf_unscale_a</span><span class="p">,</span>
                                                   <span class="n">free_params</span><span class="o">=</span><span class="n">free_params</span><span class="p">,</span>
                                                   <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">param_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_table</span><span class="p">(</span><span class="n">param_nm_a</span><span class="o">=</span><span class="n">free_params</span><span class="p">)</span>
            <span class="n">param_all_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_table</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;free_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_params</span>

            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;costval0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cost0_d</span><span class="p">[</span><span class="s1">&#39;cost_val&#39;</span><span class="p">]</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;costdata0_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cost0_d</span><span class="p">[</span><span class="s1">&#39;cost_data_df&#39;</span><span class="p">]</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;param0_tbl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param0_tbl</span>

            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;costval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;cost_val&#39;</span><span class="p">]</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;costdata_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;cost_data_df&#39;</span><span class="p">]</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;prior_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;prior_df&#39;</span><span class="p">]</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;param_tbl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_tbl</span>
            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;param_all_tbl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_all_tbl</span>

            <span class="n">output_d</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

            <span class="c1"># output_d[&#39;param_d&#39;] = copy.copy(self._param_d)</span>
            <span class="c1"># output_d[&#39;param0_a&#39;] = param0_a</span>
            <span class="c1"># output_d[&#39;paramf_a&#39;] = result.x</span>
            <span class="c1"># output_d[&#39;param0_unscl_a&#39;] = param0_unscale_a</span>
            <span class="c1"># output_d[&#39;paramf_unscl_a&#39;] = paramf_unscale_a</span>

            <span class="k">return</span> <span class="n">output_d</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">posterior_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">param_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">)</span>
        <span class="n">mu_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu_a</span>
        <span class="n">err_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_err_a</span>
        <span class="n">corr_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corr_a</span>
        <span class="n">err_scl_mat_a</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">make_scale_matrix</span><span class="p">(</span><span class="n">err_a</span><span class="p">)</span>

        <span class="n">cov_a</span> <span class="o">=</span> <span class="n">err_scl_mat_a</span><span class="o">*</span><span class="n">corr_a</span>

        <span class="n">pdraw_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu_a</span><span class="p">,</span> <span class="n">cov_a</span><span class="p">,</span> <span class="n">Ndraw</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pdraw_a</span>

    <span class="k">def</span> <span class="nf">posterior_rxn_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tlims</span><span class="p">,</span> <span class="n">conf_lvl</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                            <span class="n">Nsamp</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sampfac</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">convert_units</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">Nrxn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_key</span><span class="p">)</span>
        <span class="n">Nsamptot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Nsamp</span><span class="o">*</span><span class="n">sampfac</span><span class="p">)</span>

        <span class="c1"># T_bound_draw_a = np.zeros((Nrxn,Ndraw,Nsamptot))</span>
        <span class="n">P_bound_draw_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nrxn</span><span class="p">,</span><span class="n">Ndraw</span><span class="p">,</span><span class="n">Nsamptot</span><span class="p">))</span>
        <span class="n">T_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Tlims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Tlims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Nsamptot</span><span class="p">)</span>
        <span class="n">free_param_nm_a</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">)</span>
        <span class="n">PT_triple_draw_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">Ndraw</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndraw</span><span class="p">):</span>
            <span class="n">pdraw_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">posterior_draw</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">pdraw_a</span><span class="p">,</span><span class="n">free_param_nm_a</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">irxn</span><span class="p">,(</span><span class="n">rxn_eqn</span><span class="p">,</span><span class="n">rxn_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span><span class="p">)):</span>
                <span class="n">iTP_bound_a</span> <span class="o">=</span> <span class="n">rxn_obj</span><span class="o">.</span><span class="n">trace_rxn_bound</span><span class="p">(</span><span class="n">Tlims</span><span class="o">=</span><span class="n">Tlims</span><span class="p">,</span><span class="n">Nsamp</span><span class="o">=</span><span class="n">Nsamp</span><span class="p">)</span>
                <span class="n">fun</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">iTP_bound_a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">iTP_bound_a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">Pbnd_a</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">T_a</span><span class="p">)</span>

                <span class="c1"># T_bound_draw_a[irxn,ind,:] = T_a</span>
                <span class="n">P_bound_draw_a</span><span class="p">[</span><span class="n">irxn</span><span class="p">,</span><span class="n">ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Pbnd_a</span>

            <span class="n">T_tp</span><span class="p">,</span><span class="n">P_tp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_simultaneous_rxn_cond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">PT_triple_draw_a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_tp</span>
            <span class="n">PT_triple_draw_a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_tp</span>


        <span class="k">if</span> <span class="n">convert_units</span><span class="p">:</span>
            <span class="n">T_a</span> <span class="o">-=</span> <span class="mf">273.15</span>
            <span class="n">P_bound_draw_a</span><span class="o">/=</span><span class="mf">1e3</span>
            <span class="n">PT_triple_draw_a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">273.15</span>
            <span class="n">PT_triple_draw_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1e3</span>

        <span class="n">posterior_rxn_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;T_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_a</span>
        <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;P_bound_draw_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_bound_draw_a</span>
        <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;PT_triple_draw_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_triple_draw_a</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calc_rxn_bound_conf_lvl</span><span class="p">(</span><span class="n">posterior_rxn_d</span><span class="p">,</span><span class="n">conf_lvl</span><span class="o">=</span><span class="n">conf_lvl</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">posterior_rxn_d</span>

    <span class="k">def</span> <span class="nf">calc_rxn_bound_conf_lvl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">posterior_rxn_d</span><span class="p">,</span> <span class="n">conf_lvl</span><span class="o">=</span><span class="mf">0.68</span><span class="p">):</span>
        <span class="n">T_a</span> <span class="o">=</span> <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;T_a&#39;</span><span class="p">]</span>
        <span class="n">P_bound_draw_a</span> <span class="o">=</span> <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;P_bound_draw_a&#39;</span><span class="p">]</span>
        <span class="n">PT_triple_draw_a</span> <span class="o">=</span> <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;PT_triple_draw_a&#39;</span><span class="p">]</span>

        <span class="n">rxn_conf_bnd_a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">P_bound_draw_a</span><span class="p">,</span>
                                     <span class="p">[</span><span class="mi">50</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">conf_lvl</span><span class="p">,</span><span class="mi">50</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="mi">100</span><span class="o">*</span><span class="n">conf_lvl</span><span class="p">],</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">PT_triple_mean_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">PT_triple_draw_a</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">PT_triple_cov_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">PT_triple_draw_a</span><span class="p">)</span>

        <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;rxn_conf_bnd_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn_conf_bnd_a</span>
        <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;PT_triple_mean_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_triple_mean_a</span>
        <span class="n">posterior_rxn_d</span><span class="p">[</span><span class="s1">&#39;PT_triple_cov_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PT_triple_cov_a</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">scale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_vals_scl_a</span><span class="p">,</span> <span class="n">param_names_a</span><span class="p">):</span>
        <span class="n">param_scl_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_scl_values</span><span class="p">(</span><span class="n">param_names_a</span><span class="p">)</span>
        <span class="n">param_vals_a</span> <span class="o">=</span> <span class="n">param_vals_scl_a</span><span class="o">*</span><span class="n">param_scl_a</span>
        <span class="k">return</span> <span class="n">param_vals_a</span>

    <span class="k">def</span> <span class="nf">unscale_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_vals_a</span><span class="p">,</span> <span class="n">param_names_a</span><span class="p">):</span>
        <span class="n">param_scl_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_scl_values</span><span class="p">(</span><span class="n">param_names_a</span><span class="p">)</span>
        <span class="n">param_vals_scl_a</span> <span class="o">=</span> <span class="n">param_vals_a</span><span class="o">/</span><span class="n">param_scl_a</span>
        <span class="k">return</span> <span class="n">param_vals_scl_a</span>

    <span class="k">def</span> <span class="nf">eval_model_costfun_scl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_free_vals_scl_a</span><span class="p">,</span> <span class="n">free_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">free_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">)</span>

        <span class="c1"># param_free_scl_a = thermoDB_mod.get_param_scl_values(free_params)</span>
        <span class="c1"># param_free_vals_a = param_free_vals_scl_a*param_free_scl_a</span>

        <span class="n">param_free_vals_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_params</span><span class="p">(</span><span class="n">param_free_vals_scl_a</span><span class="p">,</span><span class="n">free_params</span><span class="p">)</span>

        <span class="n">cost_fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_model_costfun</span><span class="p">(</span><span class="n">param_free_vals_a</span><span class="p">,</span>
                                           <span class="n">free_params</span><span class="o">=</span><span class="n">free_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cost_fun</span>

    <span class="k">def</span> <span class="nf">propagate_data_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_free_vals_a</span><span class="p">,</span> <span class="n">free_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">free_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param_free_vals_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_free_vals_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">free_params</span><span class="p">)</span>



        <span class="c1"># Extract only trustworthy data</span>
        <span class="c1"># if self._dat_trust_d is None:</span>
        <span class="c1">#     self._dat_trust_d = self.extract_trust_data()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_free_vals_a</span><span class="p">,</span><span class="n">free_params</span><span class="p">)</span>
        <span class="c1"># self.set_free_param_values(param_free_vals_a)</span>

        <span class="n">data_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_df</span>
        <span class="n">rxn_eqn_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rxn_eqn_l</span>
        <span class="n">rxn_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span>
        <span class="n">param_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span>

        <span class="n">dat_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_trust_d</span>
        <span class="c1"># dat_d = self.extract_trust_data()</span>

        <span class="c1"># print(P_a)</span>
        <span class="c1"># print(P_a.reset_index())</span>

        <span class="n">Ndat</span> <span class="o">=</span> <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dVrxn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ndat</span><span class="p">)</span>
        <span class="n">dSrxn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ndat</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">rxn_eqn</span><span class="p">,</span> <span class="n">rxn_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rxn_eqn_l</span><span class="p">,</span><span class="n">rxn_l</span><span class="p">)):</span>
            <span class="n">msk_rxn</span> <span class="o">=</span> <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;rxn&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">rxn_eqn</span>
            <span class="n">idVrxn_a</span> <span class="o">=</span>  <span class="n">rxn_obj</span><span class="o">.</span><span class="n">get_rxn_volume</span><span class="p">(</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">],</span>
                                               <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">],</span>
                                               <span class="n">peratom</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="n">idSrxn_a</span> <span class="o">=</span>  <span class="n">rxn_obj</span><span class="o">.</span><span class="n">get_rxn_entropy</span><span class="p">(</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">],</span>
                                                <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">],</span>
                                                <span class="n">peratom</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

            <span class="n">dVrxn_a</span><span class="p">[</span><span class="n">msk_rxn</span><span class="p">]</span> <span class="o">=</span> <span class="n">idVrxn_a</span>
            <span class="n">dSrxn_a</span><span class="p">[</span><span class="n">msk_rxn</span><span class="p">]</span> <span class="o">=</span> <span class="n">idSrxn_a</span>

        <span class="n">sigG_trust_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;Perr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dVrxn_a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;Terr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dSrxn_a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sigG_trust_a</span>

    <span class="k">def</span> <span class="nf">eval_model_costfun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_free_vals_a</span><span class="p">,</span> <span class="n">free_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">free_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_param_names</span><span class="p">(</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;free&#39;</span><span class="p">)</span>


        <span class="c1"># Extract only trustworthy data</span>
        <span class="c1"># if self._dat_trust_d is None:</span>
        <span class="c1">#     self._dat_trust_d = self.extract_trust_data()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_param_values</span><span class="p">(</span><span class="n">param_free_vals_a</span><span class="p">,</span><span class="n">free_params</span><span class="p">)</span>
        <span class="c1"># self.set_free_param_values(param_free_vals_a)</span>

        <span class="c1"># Try to use precalculated approx Gibbs energy uncertainties</span>
        <span class="n">sigG_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigG_trust_a</span>
        <span class="k">if</span> <span class="n">sigG_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigG_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagate_data_errors</span><span class="p">(</span><span class="n">param_free_vals_a</span><span class="p">,</span>
                                                <span class="n">free_params</span><span class="o">=</span><span class="n">free_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigG_trust_a</span> <span class="o">=</span> <span class="n">sigG_a</span>

        <span class="n">Gthresh_scl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Gthresh_scl</span>
        <span class="n">data_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_df</span>
        <span class="n">rxn_eqn_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rxn_eqn_l</span>
        <span class="n">rxn_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_l</span>
        <span class="n">param_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_d</span>

        <span class="n">dat_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dat_trust_d</span>
        <span class="c1"># dat_d = self.extract_trust_data()</span>

        <span class="c1"># print(P_a)</span>
        <span class="c1"># print(P_a.reset_index())</span>

        <span class="n">Ndat</span> <span class="o">=</span> <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dGrxn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ndat</span><span class="p">)</span>
        <span class="n">logGth_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ndat</span><span class="p">)</span>

        <span class="c1"># dVrxn_a = np.zeros(Ndat)</span>
        <span class="c1"># dSrxn_a = np.zeros(Ndat)</span>

        <span class="c1"># get universal reaction parameters</span>
        <span class="n">alpha_t_all</span>   <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;alpha_t_rxn_all&#39;</span><span class="p">]</span>
        <span class="n">alpha_T_all</span>   <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;alpha_T_rxn_all&#39;</span><span class="p">]</span>
        <span class="n">alpha_H2O_all</span> <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;alpha_H2O_rxn_all&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">rxn_eqn</span><span class="p">,</span> <span class="n">rxn_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rxn_eqn_l</span><span class="p">,</span><span class="n">rxn_l</span><span class="p">)):</span>
            <span class="n">msk_rxn</span> <span class="o">=</span> <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;rxn&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">rxn_eqn</span>
            <span class="n">idGrxn_a</span> <span class="o">=</span> <span class="n">rxn_obj</span><span class="o">.</span><span class="n">get_rxn_gibbs_energy</span><span class="p">(</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">],</span>
                                                    <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">],</span>
                                                    <span class="n">peratom</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="c1"># idVrxn_a =  rxn_obj.get_rxn_volume(dat_d[&#39;T&#39;][msk_rxn],</span>
            <span class="c1">#                                    dat_d[&#39;P&#39;][msk_rxn],</span>
            <span class="c1">#                                    peratom=True )</span>
            <span class="c1"># idSrxn_a =  rxn_obj.get_rxn_entropy(dat_d[&#39;T&#39;][msk_rxn],</span>
            <span class="c1">#                                     dat_d[&#39;P&#39;][msk_rxn],</span>
            <span class="c1">#                                     peratom=True )</span>


            <span class="c1"># get reaction-specific parameters</span>
            <span class="n">alpha_0_rxn</span> <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;alpha_0_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
            <span class="n">dalpha_t_rxn</span> <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;dalpha_t_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
            <span class="n">dalpha_T_rxn</span> <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;dalpha_T_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>
            <span class="n">dalpha_H2O_rxn</span> <span class="o">=</span> <span class="n">param_d</span><span class="p">[</span><span class="s1">&#39;dalpha_H2O_rxn&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)]</span>

            <span class="n">logGth_a</span><span class="p">[</span><span class="n">msk_rxn</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_0_rxn</span> \
                <span class="o">+</span> <span class="p">(</span><span class="n">alpha_t_all</span><span class="o">+</span><span class="n">dalpha_t_rxn</span><span class="p">)</span><span class="o">*</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">]</span> \
                <span class="o">+</span> <span class="p">(</span><span class="n">alpha_T_all</span><span class="o">+</span><span class="n">dalpha_T_rxn</span><span class="p">)</span><span class="o">*</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">]</span> \
                <span class="o">+</span> <span class="p">(</span><span class="n">alpha_H2O_all</span><span class="o">+</span><span class="n">dalpha_H2O_rxn</span><span class="p">)</span><span class="o">*</span><span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">][</span><span class="n">msk_rxn</span><span class="p">]</span>

            <span class="n">dGrxn_a</span><span class="p">[</span><span class="n">msk_rxn</span><span class="p">]</span> <span class="o">=</span> <span class="n">idGrxn_a</span>
            <span class="c1"># dVrxn_a[msk_rxn] = idVrxn_a</span>
            <span class="c1"># dSrxn_a[msk_rxn] = idSrxn_a</span>

        <span class="n">Gth_a</span> <span class="o">=</span> <span class="n">Gthresh_scl</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logGth_a</span><span class="p">)</span>
        <span class="c1"># sigG_a = np.sqrt((dat_d[&#39;Perr&#39;]*dVrxn_a)**2+(dat_d[&#39;Terr&#39;]*dSrxn_a)**2)</span>

        <span class="n">loglk_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Gth_a</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">irxndir</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_dir_opt</span><span class="p">:</span>
            <span class="n">msk_rxndir</span> <span class="o">=</span> <span class="n">dat_d</span><span class="p">[</span><span class="s1">&#39;rxn_dir&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">irxndir</span>
            <span class="n">iNobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk_rxndir</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iNobs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">irxndir</span><span class="o">==</span><span class="s1">&#39;FWD&#39;</span><span class="p">:</span>
                <span class="n">iloglk_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob_fwd</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                              <span class="n">Gth_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                              <span class="n">sigG_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                              <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">irxndir</span><span class="o">==</span><span class="s1">&#39;REV&#39;</span><span class="p">:</span>
                <span class="n">iloglk_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob_rev</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                              <span class="n">Gth_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                              <span class="n">sigG_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                              <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">irxndir</span><span class="o">==</span><span class="s1">&#39;FWD?&#39;</span><span class="p">:</span>
                <span class="n">iloglk_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob_fwdq</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                               <span class="n">Gth_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                               <span class="n">sigG_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                               <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">irxndir</span><span class="o">==</span><span class="s1">&#39;REV?&#39;</span><span class="p">:</span>
                <span class="n">iloglk_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob_revq</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                               <span class="n">Gth_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                               <span class="n">sigG_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                               <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">irxndir</span><span class="o">==</span><span class="s1">&#39;NC&#39;</span><span class="p">:</span>
                <span class="n">iloglk_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob_nc</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                             <span class="n">Gth_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                             <span class="n">sigG_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">],</span>
                                             <span class="n">rxn_trans_typ</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_trans_typ</span><span class="p">)</span>

            <span class="n">loglk_a</span><span class="p">[</span><span class="n">msk_rxndir</span><span class="p">]</span> <span class="o">=</span> <span class="n">iloglk_a</span>


        <span class="n">msk_zeroprob_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">loglk_a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">loglk_a</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">logprior_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_log_prior</span><span class="p">()</span>
        <span class="c1"># logprob_a[msk_zeroprob_a] = -160</span>
        <span class="n">cost_val_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">loglk_a</span><span class="p">,</span><span class="o">-</span><span class="n">logprior_a</span><span class="p">))</span>
        <span class="n">cost_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cost_val_a</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="n">model_cost_d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;cost_val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_val</span>

            <span class="n">logprior_a</span><span class="p">,</span><span class="n">prior_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_log_prior</span><span class="p">(</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">cost_data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat_d</span><span class="p">)</span>
            <span class="n">cost_data_df</span><span class="p">[</span><span class="s1">&#39;zeroprob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">msk_zeroprob_a</span><span class="p">)</span>
            <span class="n">cost_data_df</span><span class="p">[</span><span class="s1">&#39;log_lk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">loglk_a</span><span class="p">)</span>
            <span class="c1"># cost_data_df[&#39;PubID&#39;] = pubid_a</span>
            <span class="c1"># cost_data_df[&#39;run_num&#39;] = run_num_a</span>
            <span class="c1"># cost_data_df[&#39;cost_fun&#39;] = cost_fun_a</span>
            <span class="c1"># cost_data_df[&#39;rxn_dir&#39;] = rxn_dir_a</span>
            <span class="n">cost_data_df</span><span class="p">[</span><span class="s1">&#39;Gth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">Gth_a</span><span class="p">)</span>
            <span class="n">cost_data_df</span><span class="p">[</span><span class="s1">&#39;sigG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sigG_a</span><span class="p">)</span>
            <span class="n">cost_data_df</span><span class="p">[</span><span class="s1">&#39;dGrxn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="p">)</span>
            <span class="n">cost_data_df</span><span class="p">[</span><span class="s1">&#39;relG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dGrxn_a</span><span class="o">/</span><span class="n">sigG_a</span><span class="p">)</span>

            <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;cost_data_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_data_df</span>
            <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;log_prior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">logprior_a</span><span class="p">)</span>
            <span class="n">model_cost_d</span><span class="p">[</span><span class="s1">&#39;prior_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_df</span>
            <span class="k">return</span> <span class="n">model_cost_d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cost_val</span>

    <span class="k">def</span> <span class="nf">eval_log_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">typ</span><span class="o">=</span><span class="s1">&#39;studentt&#39;</span><span class="p">,</span><span class="n">dof</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">paramnm_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Param&#39;</span><span class="p">]</span>
        <span class="n">trust_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Trust&#39;</span><span class="p">]</span>
        <span class="n">val_data_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
        <span class="n">err_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span>

        <span class="n">log_prior_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">val_data_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">val_model_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">val_data_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">resid_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">val_data_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">paramnm</span><span class="p">,</span><span class="n">trust</span><span class="p">,</span><span class="n">val_data</span><span class="p">,</span><span class="n">err</span><span class="p">)</span> <span class="ow">in</span> \
                <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">paramnm_s</span><span class="p">,</span><span class="n">trust_s</span><span class="p">,</span><span class="n">val_data_s</span><span class="p">,</span><span class="n">err_s</span><span class="p">)):</span>

            <span class="n">val_mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_d</span><span class="p">[</span><span class="n">paramnm</span><span class="p">]</span>
            <span class="n">val_model_a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_mod</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">val_mod</span><span class="o">-</span><span class="n">val_data</span><span class="p">)</span><span class="o">/</span><span class="n">err</span>
            <span class="n">resid_a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">trust</span><span class="o">==</span><span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
                <span class="n">log_prior_a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprior_fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_prior_a</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>


        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="c1"># Get new dataframe by copything columns</span>
            <span class="n">prior_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[[</span><span class="s1">&#39;Param&#39;</span><span class="p">,</span><span class="s1">&#39;Abbrev&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">prior_df</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">prior_df</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span>
            <span class="n">prior_df</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">val_model_a</span><span class="p">)</span>
            <span class="n">prior_df</span><span class="p">[</span><span class="s1">&#39;Resid&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">resid_a</span><span class="p">)</span>
            <span class="n">prior_df</span><span class="p">[</span><span class="s1">&#39;Trust&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_prior_df</span><span class="p">[</span><span class="s1">&#39;Trust&#39;</span><span class="p">]</span>
            <span class="n">prior_df</span><span class="p">[</span><span class="s1">&#39;log_prior&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">log_prior_a</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">log_prior_a</span><span class="p">,</span> <span class="n">prior_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">log_prior_a</span>
<span class="c1">#===================================================</span>
<span class="k">class</span> <span class="nc">PhaseStabilityData</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">,</span> <span class="n">phase_wt_comp</span><span class="p">,</span> <span class="n">phase_symbol_key</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span>
                    <span class="n">T_units</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="n">P_units</span><span class="o">=</span><span class="s1">&#39;bars&#39;</span><span class="p">):</span>
        <span class="c1"># self._prune_missing_phases(exp_dataphase_wt_comp, modelDB)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_exps</span><span class="p">(</span><span class="n">exp_data</span><span class="p">,</span> <span class="n">phase_wt_comp</span><span class="p">,</span> <span class="n">phase_symbol_key</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span>
                            <span class="n">T_units</span><span class="p">,</span> <span class="n">P_units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_exps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_data</span><span class="p">,</span> <span class="n">phs_wt_comp</span><span class="p">,</span> <span class="n">phase_symbol_key</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span>
                    <span class="n">T_units</span><span class="p">,</span> <span class="n">P_units</span><span class="p">):</span>
        <span class="n">phase_symbol_key</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">LEPR_phase_symbols</span> <span class="c1">#Jenna added this; to get</span>
        <span class="c1"># this function to work properly, it seems like we should take output</span>
        <span class="c1"># the phase_symbol_key as an input, and create a comprehensive lists</span>
        <span class="c1"># of these lepr phase symbols?</span>
        <span class="n">phase_stability_exps</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">exp_index_invalid</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">exp_idx</span> <span class="ow">in</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">iP</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp_idx</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">]</span>
            <span class="n">iT</span> <span class="o">=</span> <span class="n">exp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp_idx</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span>

            <span class="n">phase_symbols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">phase_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">phase_wt_oxide_comp</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">phs_wt_comp</span><span class="p">:</span>
                <span class="n">iphs_wt_comp</span> <span class="o">=</span> <span class="n">phs_wt_comp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">exp_idx</span> <span class="ow">in</span> <span class="n">iphs_wt_comp</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">phase_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">phase_symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_symbol_key</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">phase_wt_oxide_comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iphs_wt_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">exp_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">phase_wt_oxide_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_wt_oxide_comp</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">phase_stability_exp</span> <span class="o">=</span> <span class="n">PhaseStabilityExp</span><span class="p">(</span>
                    <span class="n">iP</span><span class="p">,</span> <span class="n">iT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phase_symbols</span><span class="p">,</span> <span class="n">phase_wt_oxide_comp</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span>
                    <span class="n">T_units</span><span class="p">,</span> <span class="n">P_units</span><span class="p">)</span>
                <span class="n">phase_stability_exps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_stability_exp</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">exp_index_invalid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp_idx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_index_invalid</span> <span class="o">=</span> <span class="n">exp_index_invalid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_stability_exps</span> <span class="o">=</span> <span class="n">phase_stability_exps</span>

        <span class="c1">#phase_stability_info = OrderedDict()</span>
        <span class="c1">#phase_stability_info[&#39;phase_symbols&#39;] = self._phase_symbols = phase_symbols</span>
        <span class="c1">#phase_stability_info[&#39;phases&#39;] = phases</span>
        <span class="c1">#phase_stability_info[&#39;phase_num&#39;] = phase_num</span>
        <span class="c1">#phase_stability_info[&#39;phase_wt_oxide_comp&#39;] = phase_wt_oxide_comp</span>
        <span class="c1">#phase_stability_info[&#39;phase_mol_oxide_comp&#39;] = phase_mol_oxide_comp</span>
        <span class="c1">#phase_stability_info[&#39;phase_mol_endmem_comp&#39;] = phase_mol_endmem_comp</span>

    <span class="k">def</span> <span class="nf">calc_equil_rxn_affinities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phase_stability_exps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_stability_exps</span>

        <span class="n">affinities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iexp</span> <span class="ow">in</span> <span class="n">phase_stability_exps</span><span class="p">:</span>
            <span class="n">iaffinity</span> <span class="o">=</span> <span class="n">iexp</span><span class="o">.</span><span class="n">calc_equil_rxn_affinities</span><span class="p">()</span>
            <span class="n">affinities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iaffinity</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">affinities</span>

    <span class="c1"># def _prune_missing_phases(exp_data, phase_wt_comp, modelDB):</span>
    <span class="c1">#     self._modelDB = modelDB</span>
    <span class="c1">#     prune_phases = []</span>
    <span class="c1">#</span>
    <span class="c1">#     for phase_sym in phase_wt_comp:</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             phase = modelDB.get_phase(phase_sym)</span>
    <span class="c1">#</span>
    <span class="c1">#         except:</span>
    <span class="c1">#             prune_phases.append(phase_sym)</span>

    <span class="c1">#     for idx in exp_data.index:</span>




<span class="c1">#===================================================</span>
<span class="k">class</span> <span class="nc">PhaseStabilityExp</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">wt_oxide_comp</span><span class="p">,</span>
                 <span class="n">phase_symbols</span><span class="p">,</span> <span class="n">phase_wt_oxide_comp</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">,</span>
                 <span class="n">T_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wt_oxide_comp_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">phase_wt_oxide_comp_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fO2_buffer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fO2_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fO2_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">T_units</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="n">P_units</span><span class="o">=</span><span class="s1">&#39;bars&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_exp_cond</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P_err</span><span class="p">,</span> <span class="n">T_err</span><span class="p">,</span>
                            <span class="n">fO2_buffer</span><span class="p">,</span> <span class="n">fO2_offset</span><span class="p">,</span> <span class="n">fO2_err</span><span class="p">,</span> <span class="n">T_units</span><span class="p">,</span> <span class="n">P_units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_phase_info</span><span class="p">(</span><span class="n">phase_symbols</span><span class="p">,</span> <span class="n">phase_wt_oxide_comp</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_equil_rxns</span><span class="p">()</span>
            <span class="c1"># calculate rxns with svd</span>
        <span class="c1">#self._init_absent_rxns()</span>

    <span class="k">def</span> <span class="nf">_init_exp_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">T_err</span><span class="p">,</span> <span class="n">P_err</span><span class="p">,</span>
                       <span class="n">fO2_buffer</span><span class="p">,</span> <span class="n">fO2_offset</span><span class="p">,</span> <span class="n">fO2_err</span><span class="p">,</span> <span class="n">T_units</span><span class="p">,</span> <span class="n">P_units</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">T_units</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">T</span> <span class="o">+</span> <span class="mi">273</span>
        <span class="k">if</span> <span class="n">P_units</span> <span class="o">==</span> <span class="s1">&#39;GPa&#39;</span><span class="p">:</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="mi">10000</span>
            <span class="n">P_err</span> <span class="o">=</span> <span class="n">P_err</span> <span class="o">*</span> <span class="mi">10000</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_P</span> <span class="o">=</span> <span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T</span> <span class="o">=</span> <span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_P_err</span> <span class="o">=</span> <span class="n">P_err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_T_err</span> <span class="o">=</span> <span class="n">T_err</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fO2_buffer</span> <span class="o">=</span> <span class="n">fO2_buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fO2_offset</span> <span class="o">=</span> <span class="n">fO2_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fO2_err</span> <span class="o">=</span> <span class="n">fO2_err</span>

    <span class="k">def</span> <span class="nf">_init_phase_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_symbols</span><span class="p">,</span> <span class="n">phase_wt_oxide_comp</span><span class="p">,</span> <span class="n">modelDB</span><span class="p">):</span>
        <span class="n">phase_wt_oxide_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_wt_oxide_comp</span><span class="p">)</span>

        <span class="n">phase_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_symbols</span><span class="p">)</span>
        <span class="n">oxide_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chem</span><span class="o">.</span><span class="n">OXIDE_ORDER</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">phase_wt_oxide_comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">phase_num</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;phase_wt_oxide_comp must define compositions &#39;</span>
            <span class="s1">&#39;for every phase in phase_symbols.&#39;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">phase_wt_oxide_comp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">oxide_num</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;phase_wt_oxide_comp must define composition for every oxide &#39;</span>
            <span class="s1">&#39;in standard order.&#39;</span>
        <span class="p">)</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">modelDB</span><span class="o">.</span><span class="n">get_phase</span><span class="p">(</span><span class="n">phs_sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">phs_sym</span> <span class="ow">in</span> <span class="n">phase_symbols</span><span class="p">]</span>
        <span class="n">phase_mol_oxide_comp</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">wt_to_mol_oxide</span><span class="p">(</span><span class="n">phase_wt_oxide_comp</span><span class="p">)</span>

        <span class="n">phase_mol_endmem_comp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">phs_sym</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">mol_oxide_comp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">phase_symbols</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">phase_mol_oxide_comp</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">phs_sym</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modelDB</span><span class="o">.</span><span class="n">phase_obj</span><span class="p">[</span><span class="s1">&#39;pure&#39;</span><span class="p">]:</span>
                <span class="n">endmem_comp</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">calc_endmember_comp</span><span class="p">(</span>
                    <span class="n">mol_oxide_comp</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;intrinsic&#39;</span><span class="p">,</span> <span class="n">output_residual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">phase_mol_endmem_comp</span><span class="p">[</span><span class="n">phs_sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">endmem_comp</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_modelDB</span> <span class="o">=</span> <span class="n">modelDB</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_symbols</span> <span class="o">=</span> <span class="n">phase_symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span> <span class="o">=</span> <span class="n">phases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_num</span> <span class="o">=</span> <span class="n">phase_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_wt_oxide_comp</span> <span class="o">=</span> <span class="n">phase_wt_oxide_comp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_mol_oxide_comp</span> <span class="o">=</span> <span class="n">phase_mol_oxide_comp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phase_mol_endmem_comp</span> <span class="o">=</span> <span class="n">phase_mol_endmem_comp</span>

    <span class="k">def</span> <span class="nf">_init_equil_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span>
        <span class="n">phase_symbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_symbols</span>
        <span class="n">modelDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelDB</span>

        <span class="n">rxn_svd_props</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">calc_reaction_svd</span><span class="p">(</span><span class="n">phase_symbols</span><span class="p">,</span> <span class="n">TOLsvd</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">modelDB</span><span class="o">=</span><span class="n">modelDB</span><span class="p">)</span>
        <span class="n">equil_rxn_coefs</span> <span class="o">=</span> <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;rxn_svd&#39;</span><span class="p">]</span>
        <span class="n">Nbasis</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">equil_rxn_coefs</span><span class="p">)</span>
        <span class="n">rxn_endmember_name</span> <span class="o">=</span> <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_endmember_name&#39;</span><span class="p">]</span>
        <span class="n">rxn_phase_symbols</span> <span class="o">=</span> <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_phase_symbol&#39;</span><span class="p">]</span>
        <span class="n">endmember_ids</span> <span class="o">=</span> <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_endmember_id&#39;</span><span class="p">]</span>

        <span class="n">equil_rxns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">irxn_coefs</span> <span class="ow">in</span> <span class="n">equil_rxn_coefs</span><span class="p">:</span>
            <span class="n">irxn</span> <span class="o">=</span> <span class="n">modelDB</span><span class="o">.</span><span class="n">get_rxn</span><span class="p">(</span><span class="n">rxn_phase_symbols</span><span class="p">,</span> <span class="n">endmember_ids</span><span class="p">,</span> <span class="n">irxn_coefs</span><span class="p">,</span> <span class="n">coefs_per_atom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">equil_rxns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irxn</span><span class="p">)</span>

        <span class="n">equil_rxn_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">equil_rxns</span><span class="p">)</span>

        <span class="n">all_endmem_names</span> <span class="o">=</span> <span class="n">rxn_endmember_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_endmem_names</span> <span class="o">=</span> <span class="n">all_endmem_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equil_rxn_num</span> <span class="o">=</span> <span class="n">equil_rxn_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equil_rxns</span> <span class="o">=</span> <span class="n">equil_rxns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_equil_rxn_coefs</span> <span class="o">=</span> <span class="n">equil_rxn_coefs</span>

    <span class="k">def</span> <span class="nf">calc_equil_rxn_affinities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span>
        <span class="n">equil_rxns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equil_rxns</span>
        <span class="n">equil_rxn_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equil_rxn_num</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_T</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_P</span>
        <span class="n">phase_mol_endmem_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_mol_endmem_comp</span>
        <span class="c1"># print(T)</span>
        <span class="c1"># print(P)</span>
        <span class="c1"># print(phase_mol_endmem_comp)</span>

        <span class="n">rxn_affinities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">equil_rxn_num</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">equil_rxns</span><span class="p">):</span>
            <span class="n">rxn_affinities</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">affinity</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">mols</span><span class="o">=</span><span class="n">phase_mol_endmem_comp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rxn_affinities</span>

    <span class="k">def</span> <span class="nf">calc_absent_rxn_affinities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">NotImplimented</span><span class="p">()</span>

<span class="c1">#===================================================</span>
<span class="k">class</span> <span class="nc">RxnData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO:</span>
<span class="sd">        - filter trusted data</span>
<span class="sd">        - get_data() - return only trusted info?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RESULT_OPTS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="s1">&#39;+?&#39;</span><span class="p">,</span><span class="s1">&#39;-?&#39;</span><span class="p">]</span>

    <span class="n">ERROR_DEFAULT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;mol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">ERROR_TYPE</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span> <span class="s1">&#39;mol&#39;</span><span class="p">:</span><span class="s1">&#39;%&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data_sheets</span><span class="p">,</span> <span class="n">error_default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_data_tables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">input_data_sheets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_data_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_reference_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_setup_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_conditions_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_rxn_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_comp_data</span><span class="p">()</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_init_reference_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;pub_id&#39;</span><span class="p">,</span> <span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">reference</span>

    <span class="k">def</span> <span class="nf">_init_setup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">setup</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;pub_id&#39;</span><span class="p">,</span><span class="s1">&#39;run_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;total_mass&#39;</span><span class="p">,</span> <span class="s1">&#39;contaminant_phases&#39;</span><span class="p">,</span> <span class="s1">&#39;contact_geom&#39;</span><span class="p">,</span>
            <span class="s1">&#39;container_aspect_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;grain_size&#39;</span><span class="p">,</span> <span class="s1">&#39;single_xtal_size&#39;</span><span class="p">,</span>
            <span class="s1">&#39;other_phase_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_type&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_amt&#39;</span><span class="p">,</span>
            <span class="s1">&#39;init_reac_present&#39;</span><span class="p">,</span> <span class="s1">&#39;init_prod_present&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">setup</span>

    <span class="k">def</span> <span class="nf">_init_conditions_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;P_err&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T_err&#39;</span><span class="p">,</span> <span class="s1">&#39;equil_time&#39;</span><span class="p">,</span> <span class="s1">&#39;trust_conditions&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">conditions</span>

    <span class="k">def</span> <span class="nf">_init_rxn_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;rxn_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rxn_studied&#39;</span><span class="p">,</span> <span class="s1">&#39;init_rxn_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="s1">&#39;rxn_dir&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rxn</span>

    <span class="k">def</span> <span class="nf">_init_comp_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">comp</span>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">input_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_reference_data</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_setup_data</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_conditions_data</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_rxn_data</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_load_reference_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span>
        <span class="n">reference_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">ref_data</span><span class="p">,</span> <span class="n">ref_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_data_sheet</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">][</span><span class="n">reference_cols</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_data</span><span class="p">)[</span><span class="n">reference_cols</span><span class="p">]</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_load_setup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">setup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span>
        <span class="n">setup_cols</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">exp_conditions_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">,</span><span class="s1">&#39;run_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;container_aspect_ratio&#39;</span><span class="p">]</span>

        <span class="n">rxn_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;contact_geom&#39;</span><span class="p">,</span> <span class="s1">&#39;total_mass&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;other_phase_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;contaminant_phases&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;grain_size&#39;</span><span class="p">,</span> <span class="s1">&#39;single_xtal_size&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_type&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_amt&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;init_reac_present&#39;</span><span class="p">,</span> <span class="s1">&#39;init_prod_present&#39;</span><span class="p">]</span>

        <span class="n">isetup</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;exp_conditions&#39;</span><span class="p">][</span><span class="n">exp_conditions_cols</span><span class="p">],</span>
            <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;rxn&#39;</span><span class="p">][</span><span class="n">rxn_cols</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">isetup_data</span><span class="p">,</span> <span class="n">isetup_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_data_sheet</span><span class="p">(</span><span class="n">isetup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span> <span class="o">=</span> <span class="n">setup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isetup_data</span><span class="p">)[</span><span class="n">setup_cols</span><span class="p">]</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_load_conditions_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span>
        <span class="n">conditions_cols</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">iconditions_data</span><span class="p">,</span> <span class="n">iconditions_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_data_sheet</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;exp_conditions&#39;</span><span class="p">][</span><span class="n">conditions_cols</span><span class="p">])</span>

        <span class="c1"># Convert C to K</span>
        <span class="k">if</span> <span class="n">iconditions_units</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">iconditions_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">273.15</span>

        <span class="k">if</span> <span class="n">iconditions_units</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;kbar&#39;</span><span class="p">:</span>
            <span class="n">iconditions_data</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e3</span>
            <span class="n">iconditions_data</span><span class="p">[</span><span class="s1">&#39;P_err&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1e3</span>

        <span class="n">iconditions_data</span><span class="p">[</span><span class="s1">&#39;trust_conditions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">iconditions_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_default_error</span><span class="p">(</span><span class="n">iconditions_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iconditions_data</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_set_default_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions_data</span><span class="p">):</span>
        <span class="n">ERROR_DEFAULT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_DEFAULT</span>
        <span class="n">ERROR_TYPE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_TYPE</span>


        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">]:</span>
            <span class="n">default_val</span> <span class="o">=</span> <span class="n">ERROR_DEFAULT</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">default_typ</span> <span class="o">=</span> <span class="n">ERROR_TYPE</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="c1"># from IPython import embed; embed(); import ipdb; ipdb.set_trace()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">conditions_data</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="c1"># print(mask)</span>

            <span class="k">if</span> <span class="n">default_typ</span><span class="o">==</span><span class="s1">&#39;absolute&#39;</span><span class="p">:</span>
                <span class="n">ierr</span> <span class="o">=</span> <span class="n">default_val</span>
            <span class="k">elif</span> <span class="n">default_typ</span><span class="o">==</span><span class="s1">&#39;%&#39;</span><span class="p">:</span>
                <span class="n">ival</span> <span class="o">=</span> <span class="n">conditions_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">ival</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">ival</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">ierr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ival</span><span class="o">*</span><span class="n">default_val</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>

            <span class="n">conditions_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">key</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ierr</span>

        <span class="k">return</span> <span class="n">conditions_data</span>

    <span class="k">def</span> <span class="nf">_load_rxn_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="n">rxn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn</span>
        <span class="n">rxn_cols</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">rxn_input_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">,</span> <span class="s1">&#39;init_rxn_progress&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">]</span>

        <span class="n">rxn_input_data</span><span class="p">,</span> <span class="n">rxn_input_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_data_sheet</span><span class="p">(</span>
            <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;rxn&#39;</span><span class="p">][</span><span class="n">rxn_input_cols</span><span class="p">])</span>

        <span class="c1"># Redetermine rxn directions by combining ALL rxns reported</span>
        <span class="n">all_rxn_input_data</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="n">rxn_input_cols</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_input_data</span><span class="p">)</span>

        <span class="n">rxn_props</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">rxn_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_rxns</span><span class="p">(</span><span class="n">all_rxn_input_data</span><span class="p">)</span>
        <span class="n">rxn_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_rxn_dir</span><span class="p">(</span><span class="n">all_rxn_input_data</span><span class="p">,</span> <span class="n">rxn_props</span><span class="p">,</span> <span class="n">rxn_ids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rxn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rxn_ids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rxn_id&#39;</span><span class="p">),</span>
                              <span class="n">all_rxn_input_data</span><span class="p">,</span>
                              <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rxn_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rxn_dir&#39;</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># self.rxn = rxn.append(irxn)[rxn.columns]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn_props</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_props</span> <span class="o">=</span> <span class="n">rxn_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phases</span> <span class="o">=</span> <span class="n">phases</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_load_comp_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">input_data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_init_phase_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="n">phase_comp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
            <span class="n">component</span><span class="p">,</span> <span class="n">component</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">,</span> <span class="s1">&#39;init_&#39;</span><span class="o">+</span><span class="n">component</span><span class="p">,</span>
            <span class="s1">&#39;init_&#39;</span><span class="o">+</span><span class="n">component</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">[</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_comp</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_read_data_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheet</span><span class="p">):</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">units</span>

    <span class="k">def</span> <span class="nf">_init_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn</span><span class="p">):</span>
        <span class="n">rxn_eqns</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">rxn_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rxn_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">irxn_eqn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn_eqns</span><span class="p">):</span>
            <span class="n">imask</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">irxn_eqn</span>
            <span class="n">rxn_ids</span><span class="p">[</span><span class="n">imask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>

            <span class="n">iphs</span><span class="p">,</span> <span class="n">icoef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_rxn_coefs</span><span class="p">(</span><span class="n">irxn_eqn</span><span class="p">)</span>
            <span class="n">all_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iphs</span><span class="p">)</span>
            <span class="n">irxn_prop</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">({</span><span class="s1">&#39;phases&#39;</span><span class="p">:</span> <span class="n">iphs</span><span class="p">,</span> <span class="s1">&#39;coefs&#39;</span><span class="p">:</span> <span class="n">icoef</span><span class="p">,</span> <span class="s1">&#39;eqn&#39;</span><span class="p">:</span><span class="n">irxn_eqn</span><span class="p">})</span>
            <span class="n">rxn_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">irxn_prop</span><span class="p">)</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_phases</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rxn_props</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">rxn_ids</span>

    <span class="k">def</span> <span class="nf">_infer_rxn_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">rxn_props</span><span class="p">,</span> <span class="n">rxn_ids</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">rxn</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
        <span class="n">rxn_dir</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iresult</span><span class="p">,</span> <span class="n">irxn_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">rxn_ids</span><span class="p">):</span>
            <span class="n">iphases</span><span class="p">,</span> <span class="n">ichanges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_rxn_results</span><span class="p">(</span><span class="n">iresult</span><span class="p">)</span>
            <span class="n">ichange_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ichanges</span><span class="p">))</span>

            <span class="n">irxn_prop</span> <span class="o">=</span> <span class="n">rxn_props</span><span class="p">[</span><span class="n">irxn_id</span><span class="p">]</span>
            <span class="n">irxn_phases</span> <span class="o">=</span> <span class="n">irxn_prop</span><span class="p">[</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span>
            <span class="n">irxn_coefs</span> <span class="o">=</span> <span class="n">irxn_prop</span><span class="p">[</span><span class="s1">&#39;coefs&#39;</span><span class="p">]</span>

            <span class="n">irxn_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ichanges</span><span class="p">))</span>
            <span class="n">irxn_certain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ichanges</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">ijphs</span><span class="p">,</span> <span class="n">ijchange</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">iphases</span><span class="p">,</span> <span class="n">ichanges</span><span class="p">)):</span>
                <span class="n">ijdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">ijchange</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ijchange</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ijchange</span> <span class="o">==</span> <span class="s1">&#39;+?&#39;</span><span class="p">:</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">ijchange</span> <span class="o">==</span> <span class="s1">&#39;-?&#39;</span><span class="p">:</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">ijchange</span><span class="o">==</span><span class="s1">&#39;=&#39;</span><span class="p">):</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">ijchange</span><span class="o">==</span><span class="s1">&#39;=?&#39;</span><span class="p">):</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ijdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">ijcertain</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">ijdir</span> <span class="o">*=</span> <span class="n">irxn_coefs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">irxn_phases</span><span class="o">==</span><span class="n">ijphs</span><span class="p">)]</span>
                <span class="n">irxn_dir</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ijdir</span>
                <span class="n">irxn_certain</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ijcertain</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">irxn_dir</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">irxn_certain</span><span class="p">):</span>
                    <span class="n">rxn_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;REV&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rxn_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;REV?&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">irxn_dir</span><span class="o">==+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">irxn_certain</span><span class="p">):</span>
                    <span class="n">rxn_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FWD&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rxn_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FWD?&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">irxn_dir</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">rxn_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NC&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">rxn_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;BIASED&#39;</span><span class="p">)</span>

        <span class="n">rxn_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rxn_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rxn_dir</span>






        <span class="c1"># for irxn_props in rxn_props:</span>
        <span class="c1">#     irxn_</span>
        <span class="c1">#     imask = df[&#39;rxn_studied&#39;]==irxn_eqn</span>
        <span class="c1">#     iresults = pd.DataFrame([pd.Series(df[imask][&#39;results&#39;].str.startswith(iphs),name=iphs)</span>
        <span class="c1">#                          for iphs in irxn.phase_symbols]).T</span>
        <span class="c1">#</span>
        <span class="c1">#     irxn_dir = np.dot(irxn.rxn_coefs,</span>
        <span class="c1">#                       np.array([df[imask][&#39;results&#39;].str.startswith(iphs)</span>
        <span class="c1">#                                 for iphs in irxn.phase_symbols]))</span>
        <span class="c1">#     rxn_dir[imask] = irxn_dir</span>
        <span class="c1">#</span>
        <span class="c1"># df[&#39;rxn_dir&#39;] = rxn_dir</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read_phase_rev_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filenm</span><span class="p">,</span> <span class="n">sheetname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Read file and concatenate all sheets</span>
        <span class="n">data_d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">filenm</span><span class="p">,</span><span class="n">sheetname</span><span class="o">=</span><span class="n">sheetname</span><span class="p">)</span>
        <span class="c1"># try to concatenate multiple sheets (if present)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">raw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data_d</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">raw_df</span> <span class="o">=</span> <span class="n">data_d</span>

        <span class="k">return</span> <span class="n">raw_df</span>

    <span class="nd">@classmethod</span>
    <span class="c1"># Determine which values are actually bounds</span>
    <span class="k">def</span> <span class="nf">detect_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colnm</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">msk_lo</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colnm</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">msk_hi</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colnm</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># NOTE: It is crucial that bound is a series (not a numpy array), otherwise msk indexing will fail</span>
        <span class="n">bound_ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">msk_lo</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="n">bound_ser</span><span class="p">[</span><span class="n">msk_lo</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span>
        <span class="n">bound_ser</span><span class="p">[</span><span class="n">msk_hi</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;upper&#39;</span>


        <span class="n">bound_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">bound_df</span><span class="p">[</span><span class="n">colnm</span><span class="o">+</span><span class="s1">&#39;_Bound&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">bound_ser</span>

        <span class="n">bound_df</span><span class="p">[</span><span class="n">colnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">colnm</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bound_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">msk_lo</span><span class="p">,</span><span class="n">colnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">msk_lo</span><span class="p">,</span><span class="n">colnm</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">bound_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">msk_hi</span><span class="p">,</span><span class="n">colnm</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">msk_hi</span><span class="p">,</span><span class="n">colnm</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bound_df</span>

    <span class="k">def</span> <span class="nf">filter_phase_rev_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_df</span><span class="p">,</span> <span class="n">mask_phs_l</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">P_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_bound</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="n">raw_df</span><span class="p">)</span>
        <span class="n">T_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_bound</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="n">raw_df</span><span class="p">)</span>
        <span class="n">time_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_bound</span><span class="p">(</span><span class="s1">&#39;equil_time&#39;</span><span class="p">,</span><span class="n">raw_df</span><span class="p">)</span>

        <span class="n">rxn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># rxn_df[&#39;RxnPhases&#39;] = raw_df[[&#39;rxn_studied&#39;]].applymap(get_reaction_str)</span>
        <span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;RxnPhases&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_df</span><span class="p">[[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Database</span><span class="o">.</span><span class="n">_get_reaction_phase_str</span><span class="p">)</span>


        <span class="c1"># Set Rxn equation as the most common string representaton in the raw database</span>
        <span class="n">RxnPhases_uniq</span> <span class="o">=</span> <span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;RxnPhases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rxn_phs_str</span> <span class="ow">in</span> <span class="n">RxnPhases_uniq</span><span class="p">:</span>
            <span class="n">this_reaction</span> <span class="o">=</span> <span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">][</span><span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;RxnPhases&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">rxn_phs_str</span><span class="p">]</span>
            <span class="n">this_reaction</span> <span class="o">=</span> <span class="n">this_reaction</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Store eqn only as most common variant</span>
            <span class="c1">#NOTE iloc crucial to obtain just value (not series object)</span>
            <span class="n">rxn_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;RxnPhases&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">rxn_phs_str</span><span class="p">,</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_reaction</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">rxn_d_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">phs_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rxn_eqn_uniq</span> <span class="o">=</span> <span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rxn_eqn_str</span> <span class="ow">in</span> <span class="n">rxn_eqn_uniq</span><span class="p">:</span>
            <span class="n">rxn_d</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Database</span><span class="o">.</span><span class="n">parse_rxn</span><span class="p">(</span> <span class="n">rxn_eqn_str</span> <span class="p">)</span>
            <span class="c1">#Rewrite Rxn equation using adopted rxn direction</span>
            <span class="n">rxn_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">rxn_eqn_str</span><span class="p">,</span><span class="s1">&#39;rxn_studied&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;rxn_eqn&#39;</span><span class="p">]</span>

            <span class="c1"># Remove masked phases</span>
            <span class="k">if</span> <span class="n">mask_phs_l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">curr_rxn_phs_l</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">curr_rxn_phs_l</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;reac_l&#39;</span><span class="p">])</span>
                <span class="n">curr_rxn_phs_l</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;prod_l&#39;</span><span class="p">])</span>
                <span class="n">disallowed_phs_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span> <span class="n">curr_rxn_phs_l</span><span class="p">,</span> <span class="n">mask_phs_l</span> <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disallowed_phs_l</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">phs_l</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;reac_l&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">phs_l</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">rxn_d</span><span class="p">[</span><span class="s1">&#39;prod_l&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">rxn_d_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">rxn_d</span> <span class="p">)</span>


        <span class="c1"># Remove masked phases</span>
        <span class="n">trust_ser</span> <span class="o">=</span> <span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;trust&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;Yes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_phs_l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Remove from phase list</span>
            <span class="n">phs_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span> <span class="n">phs_l</span><span class="p">,</span> <span class="n">mask_phs_l</span> <span class="p">)</span>

            <span class="c1"># set Trust variable to No for rxns involving masked phase</span>
            <span class="k">for</span> <span class="n">mask_phs</span> <span class="ow">in</span> <span class="n">mask_phs_l</span><span class="p">:</span>
                <span class="n">trust_ser</span><span class="p">[</span><span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;RxnPhases&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">mask_phs</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>



        <span class="n">phs_uniq_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span> <span class="n">phs_l</span> <span class="p">)</span>

        <span class="c1"># Determine Reaction Direction: [&#39;FWD&#39;,&#39;REV&#39;,&#39;NC&#39;,&#39;FWD?&#39;,&#39;REV?&#39;,&#39;INV&#39;]</span>
        <span class="n">rxn_dir_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">rxn_phs_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span><span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;RxnPhases&#39;</span><span class="p">]):</span>
            <span class="n">rxn_dir_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Database</span><span class="o">.</span><span class="n">_get_rxn_dir</span><span class="p">(</span><span class="n">rxn_phs_str</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>



        <span class="c1"># rxn_uniq = rxn_df[&#39;Rxn&#39;].unique()</span>
        <span class="c1"># print(rxn_uniq)</span>
        <span class="n">rxn_df</span><span class="p">[</span><span class="s1">&#39;rxn_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rxn_dir_l</span><span class="p">)</span>
        <span class="c1"># rxn_df[&#39;results&#39;] = raw_df[&#39;results&#39;]</span>

        <span class="c1"># result = rxn_df[[&#39;Rxn&#39;]].applymap(get_reaction_phase_str)</span>
        <span class="c1"># print(get_reaction_phases(result.loc[0,&#39;Rxn&#39;]))</span>

        <span class="c1"># print(result)</span>
        <span class="c1">#  print(result[&#39;Rxn&#39;].unique())</span>
        <span class="c1">#  rxn_df = pd.concat((rxn_df,pd.DataFrame(result[&#39;Rxn&#39;].tolist(),columns=[&#39;Reac_l&#39;,&#39;Prod_l&#39;])),axis=1)</span>

        <span class="c1"># print(result.tolist())</span>
        <span class="c1"># print(pd.DataFrame(result,columns=[&#39;Reac&#39;,&#39;Prod&#39;]))</span>

        <span class="n">dat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;pub_id&#39;</span><span class="p">],</span><span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">],</span>
                            <span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;run_id&#39;</span><span class="p">],</span>
                            <span class="n">time_df</span><span class="p">,</span><span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;flux_amt&#39;</span><span class="p">],</span>
                            <span class="n">P_df</span><span class="p">,</span><span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;P_err&#39;</span><span class="p">],</span><span class="n">T_df</span><span class="p">,</span><span class="n">raw_df</span><span class="p">[</span><span class="s1">&#39;T_err&#39;</span><span class="p">],</span>
                            <span class="n">rxn_df</span><span class="p">,</span><span class="n">trust_ser</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dat_df</span><span class="p">,</span> <span class="n">rxn_d_l</span><span class="p">,</span> <span class="n">phs_uniq_l</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_rxn_coefs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rxn_eqn_str</span><span class="p">):</span>
        <span class="n">eqn_split</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">rxn_eqn_str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">eqn_split</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;rxn_eqn_str must have exactly one = sign&#39;</span>
            <span class="p">)</span>
        <span class="n">reac_str</span><span class="p">,</span> <span class="n">prod_str</span> <span class="o">=</span> <span class="n">eqn_split</span>
        <span class="n">reac_str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">reac_str</span><span class="p">)</span>
        <span class="n">prod_str</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">prod_str</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">extract_coefs</span><span class="p">(</span><span class="n">eqn_side_str</span><span class="p">):</span>
            <span class="n">eqn_terms_str</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[ +=]&#39;</span><span class="p">,</span> <span class="n">eqn_side_str</span><span class="p">)))</span>

            <span class="n">coefs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">phases_str</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">iterm_str</span> <span class="ow">in</span> <span class="n">eqn_terms_str</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;^[0-9]&#39;</span><span class="p">,</span> <span class="n">iterm_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">icoef</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">icoef</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>

                <span class="n">coefs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">icoef</span><span class="p">)</span>
                <span class="n">phases_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;^[0-9]&#39;</span><span class="p">,</span> <span class="n">iterm_str</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">phases_str</span><span class="p">,</span> <span class="n">coefs</span>

        <span class="n">phases_str_reac</span><span class="p">,</span> <span class="n">coefs_reac</span> <span class="o">=</span> <span class="n">extract_coefs</span><span class="p">(</span><span class="n">reac_str</span><span class="p">)</span>
        <span class="n">phases_str_prod</span><span class="p">,</span> <span class="n">coefs_prod</span> <span class="o">=</span> <span class="n">extract_coefs</span><span class="p">(</span><span class="n">prod_str</span><span class="p">)</span>

        <span class="n">phases_str</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">phases_str_reac</span><span class="p">,</span> <span class="n">phases_str_prod</span><span class="p">))</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">coefs_reac</span><span class="p">,</span> <span class="o">+</span><span class="n">coefs_prod</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">phases_str</span><span class="p">,</span> <span class="n">coefs</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_rxn_results</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">result_terms</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">iresult</span><span class="p">)</span> <span class="k">for</span> <span class="n">iresult</span> <span class="ow">in</span> <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s1">&#39;;&#39;</span><span class="p">)]</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">iterm</span> <span class="ow">in</span> <span class="n">result_terms</span><span class="p">:</span>
            <span class="n">term_split</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">iterm</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">term_split</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;phase and result symbols must be separated by a space.&#39;</span>
            <span class="p">)</span>
            <span class="n">iphs</span><span class="p">,</span> <span class="n">ichange</span> <span class="o">=</span> <span class="n">term_split</span>

            <span class="k">assert</span> <span class="n">ichange</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">RESULT_OPTS</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;result is invalid. Every result must be selected from &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">RESULT_OPTS</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iphs</span><span class="p">)</span>
            <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ichange</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">phases</span><span class="p">,</span> <span class="n">changes</span>
<span class="c1">#===================================================</span>
<span class="k">class</span> <span class="nc">ParamModel</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="c1">#===================================================</span>
</pre></div>

          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2020, ENKI.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.4.0.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>