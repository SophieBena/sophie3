<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>core &mdash; Thermoengine 1.0.1 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../None"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="Thermoengine 1.0.1 documentation" href="../index.html" >
    <link rel="up" title="Module code" href="index.html" > 
  </head>
  <body>

<div class="container">
  <div class="top-scipy-org-logo-header">
    <a href="../index.html">
      <img style="border: 0;" alt="ENKI" src="../_static/img/ENKI_header.png"></a>
    </div>
  </div>
</div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="http://enki-portal.org">ENKI Web</a></li>
        <li class="active"><a href="https://enki.ofm-research.org">ENKI Server</a></li>
	
        <li class="active"><a href="../index.html">Thermoengine 1.0.1 documentation</a></li>
	
          <li class="active"><a href="index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Enki.png" alt="Logo">
            </a></p>
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The Core package implements general Python functions</span>
<span class="sd">required by the thermoengine package. Typically, these are focused on interfacing</span>
<span class="sd">with Objective-C vectors, arrays, matrices, etc.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="c1"># Objective-C imports</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">cdll</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">rubicon.objc</span> <span class="kn">import</span> <span class="n">ObjCClass</span><span class="p">,</span> <span class="n">NSObject</span><span class="p">,</span> <span class="n">objc_method</span>
<span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s1">&#39;/usr/local/lib/libphaseobjc.dylib&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s1">&#39;/usr/local/lib/libphaseobjc.dylib&#39;</span><span class="p">))</span>
<span class="k">elif</span> <span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s1">&#39;/usr/local/lib/libphaseobjc.so&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s1">&#39;/usr/local/lib/libphaseobjc.so&#39;</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="c1"># __all__ flag does not work in module file</span>

<span class="n">__all__</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fill_array&#39;</span><span class="p">,</span>
            <span class="s1">&#39;double_vector_to_array&#39;</span><span class="p">,</span>
            <span class="s1">&#39;array_to_double_vector&#39;</span><span class="p">,</span>
            <span class="s1">&#39;double_matrix_to_array&#39;</span><span class="p">,</span>
            <span class="s1">&#39;make_scale_matrix&#39;</span><span class="p">,</span>
            <span class="s1">&#39;get_src_object&#39;</span><span class="p">,</span>
            <span class="s1">&#39;chem&#39;</span><span class="p">]</span>

<span class="c1">##################</span>
<span class="c1"># Array Handling #</span>
<span class="c1">##################</span>
<div class="viewcode-block" id="fill_array"><a class="viewcode-back" href="../core.html#core.fill_array">[docs]</a><span class="k">def</span> <span class="nf">fill_array</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Equilizes the dimension (shape) of two arrays or an array/scalar pair.</span>

<span class="sd">    This function is not normally called outside the equilibratepy module.</span>

<span class="sd">    On input ``var1`` and ``var2`` are either scalar/array pairs or arrays of the same shape.</span>
<span class="sd">    On output, the function returns a tuple with both arrays of the same shape.  A scalar is extended with</span>
<span class="sd">    contant entries if that action is required to match the dimension of a scalar/array pair. Two scalars</span>
<span class="sd">    are converted to two single dimension numpy arrays of length one.</span>

<span class="sd">    Uses the ``numpy.full_like`` function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var1 : scalar or array</span>
<span class="sd">        If ``var1`` is an array, ``var2`` must be either a scalar or an array of the same shape.</span>
<span class="sd">    var2 : scalar or array</span>
<span class="sd">        If ``var2`` is an array, ``var1`` must be either a scalar or an array of the same shape.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : tuple, (numpy array, numpy array)</span>
<span class="sd">        ``var1`` and ``var2`` converted to numpy arrays</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; t = [500.0, 600.0]</span>
<span class="sd">    &gt;&gt;&gt; p = 1000.0</span>
<span class="sd">    &gt;&gt;&gt; t_a, p_a = fill_array(t, p)</span>
<span class="sd">    &gt;&gt;&gt; print (t_a)</span>
<span class="sd">    [500.0, 600.0]</span>
<span class="sd">    &gt;&gt;&gt; print (p_a)</span>
<span class="sd">    [1000.0, 1000.0]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var1_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">var1</span> <span class="p">)</span>
    <span class="n">var2_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">var2</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">var1_a</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">():</span>
        <span class="n">var1_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="p">[</span><span class="n">var1</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">var2_a</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">():</span>
        <span class="n">var2_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="p">[</span><span class="n">var2</span><span class="p">]</span> <span class="p">)</span>

    <span class="c1"># Begin try/except block to handle all cases for filling an array</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">var1_a</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">var2_a</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var1_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span> <span class="n">var2_a</span><span class="p">,</span> <span class="n">var1_a</span> <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">var2_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span> <span class="n">var1_a</span><span class="p">,</span> <span class="n">var2_a</span> <span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

        <span class="c1"># If none of the cases properly handle it, throw error</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;var1 and var2 must both be equal shape or size=1&#39;</span>

    <span class="k">return</span> <span class="n">var1_a</span><span class="p">,</span> <span class="n">var2_a</span></div>

<span class="c1">################</span>
<span class="c1">#  Phase ObjC  #</span>
<span class="c1">################</span>
<div class="viewcode-block" id="double_vector_to_array"><a class="viewcode-back" href="../core.html#core.double_vector_to_array">[docs]</a><span class="k">def</span> <span class="nf">double_vector_to_array</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a DoubleVector Objective-C instance into a numpy 1-D array.</span>

<span class="sd">    This function is not normally called outside the equilibratepy module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vec : an instance of the Objective-C class DoubleVector</span>
<span class="sd">        Contents of ``vec`` are a sequence of double precision entries.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array</span>
<span class="sd">        Contents of ``vec`` as a 1-D numpy array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">size</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">pointerToDouble</span><span class="p">()</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">array</span></div>

<div class="viewcode-block" id="array_to_double_vector"><a class="viewcode-back" href="../core.html#core.array_to_double_vector">[docs]</a><span class="k">def</span> <span class="nf">array_to_double_vector</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a 1-D numpy array into an instance of a DoubleVector Objective-C class.</span>

<span class="sd">    This function is not normally called outside the equilibratepy module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : an instance of a 1-D numpy array</span>
<span class="sd">        Contents of ``array`` must be a sequence of double precision entries.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vec : an instance of the Objective-C class DoubleVector</span>
<span class="sd">        Contents of ``array`` as a pointer to an instance of DoubleVector</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doublevec_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;DoubleVector&#39;</span><span class="p">)</span>
    <span class="c1"># vec = (ctypes.c_double*array.size)()</span>
    <span class="c1"># ctypes.cast(vec, ctypes.POINTER(ctypes.c_double))</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">doublevec_cls</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">initWithSize_</span><span class="p">(</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span> <span class="p">)</span>
    <span class="n">vec_pointer</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">pointerToDouble</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
        <span class="n">vec_pointer</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">vec</span></div>

<span class="k">def</span> <span class="nf">array_to_ctype_array</span><span class="p">(</span><span class="n">np_array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a 1-D numpy array into a c-type array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    np_array : an instance of a 1-D numpy array</span>
<span class="sd">        Contents of ``array`` must be a sequence of double precision entries.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ctype_array : a c-type array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np_array</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="o">*</span><span class="n">nc</span><span class="p">)()</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np_array</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">ctype_array_to_array</span><span class="p">(</span><span class="n">ctype_array</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a c-type array into a numpy array</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ctype_array : a c-type array</span>
<span class="sd">        Contents of ``array`` must be a sequence of double precision entries</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np_array : an instance of a 1-D numpy array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">ctype_array</span><span class="o">.</span><span class="n">size</span>
    <span class="n">np_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">np_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctype_array</span><span class="o">.</span><span class="n">valueAtIndex_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np_array</span>

<div class="viewcode-block" id="double_matrix_to_array"><a class="viewcode-back" href="../core.html#core.double_matrix_to_array">[docs]</a><span class="k">def</span> <span class="nf">double_matrix_to_array</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a DoubleMatrix Objective-C instance into a numpy 2-D array.</span>

<span class="sd">    This function is not normally called outside the equilibratepy module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mat : an instance of the Objective-C class DoubleMatrix</span>
<span class="sd">        Contents of ``mat`` are a sequence of double precision entries organized as a matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array</span>
<span class="sd">        Contents of ``mat`` as a 2-D numpy array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Nrow</span><span class="p">,</span> <span class="n">Ncol</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">rowSize</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">colSize</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">Nrow</span><span class="p">,</span><span class="n">Ncol</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">pointerToPointerToDouble</span><span class="p">()</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nrow</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncol</span><span class="p">):</span>
            <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">array</span></div>

<span class="k">def</span> <span class="nf">double_tensor_to_array</span><span class="p">(</span><span class="n">ten</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a DoubleTensor Objective-C instance into a numpy 3-D array.</span>

<span class="sd">    This function is not normally called outside the phases.py module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ten : an instance of the Objective-C class DoubleTensor</span>
<span class="sd">        Contents of ``ten`` are a sequence of double precision entries organized as a 3x3 tensor</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array : numpy array</span>
<span class="sd">        Contents of ``ten`` as a 3-D numpy array</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N1st</span><span class="p">,</span> <span class="n">N2nd</span><span class="p">,</span> <span class="n">N3rd</span> <span class="o">=</span> <span class="n">ten</span><span class="o">.</span><span class="n">firstSize</span><span class="p">,</span> <span class="n">ten</span><span class="o">.</span><span class="n">secondSize</span><span class="p">,</span> <span class="n">ten</span><span class="o">.</span><span class="n">thirdSize</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N1st</span><span class="p">,</span><span class="n">N2nd</span><span class="p">,</span><span class="n">N3rd</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ten</span><span class="o">.</span><span class="n">pointerToPointerToPointerToDouble</span><span class="p">()</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">))))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N1st</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N2nd</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N3rd</span><span class="p">):</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">array</span>

<div class="viewcode-block" id="get_src_object"><a class="viewcode-back" href="../core.html#core.get_src_object">[docs]</a><span class="k">def</span> <span class="nf">get_src_object</span><span class="p">(</span><span class="n">classnm</span><span class="p">,</span> <span class="n">return_class</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize object from underlying source code.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    classnm: str</span>
<span class="sd">        Name of src class</span>
<span class="sd">    return_class: bool, default False</span>
<span class="sd">        If True, return both src object and class as a tuple</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    src_obj: initialized src object</span>
<span class="sd">    src_cls: (if return_class is True) src class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="n">classnm</span><span class="p">)</span>
    <span class="n">src_obj</span> <span class="o">=</span> <span class="n">src_cls</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_class</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">src_obj</span><span class="p">,</span> <span class="n">src_cls</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">src_obj</span></div>

<span class="c1">########</span>
<span class="c1"># Math #</span>
<span class="c1">########</span>
<span class="k">def</span> <span class="nf">make_scale_matrix</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="n">scl_mat_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">scl_mat_a</span>

<span class="c1">#############</span>
<span class="c1"># Chemistry #</span>
<span class="c1">#############</span>

<span class="k">class</span> <span class="nc">_Chem</span><span class="p">:</span>
    <span class="n">OXIDE_ORDER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="s1">&#39;SiO2&#39;</span><span class="p">,</span><span class="s1">&#39;TiO2&#39;</span><span class="p">,</span><span class="s1">&#39;Al2O3&#39;</span><span class="p">,</span><span class="s1">&#39;Fe2O3&#39;</span><span class="p">,</span><span class="s1">&#39;Cr2O3&#39;</span><span class="p">,</span><span class="s1">&#39;FeO&#39;</span><span class="p">,</span><span class="s1">&#39;MnO&#39;</span><span class="p">,</span><span class="s1">&#39;MgO&#39;</span><span class="p">,</span><span class="s1">&#39;NiO&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CoO&#39;</span><span class="p">,</span><span class="s1">&#39;CaO&#39;</span><span class="p">,</span><span class="s1">&#39;Na2O&#39;</span><span class="p">,</span><span class="s1">&#39;K2O&#39;</span><span class="p">,</span><span class="s1">&#39;P2O5&#39;</span><span class="p">,</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span><span class="s1">&#39;CO2&#39;</span><span class="p">])</span>
    <span class="n">PERIODIC_ORDER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Be&#39;</span><span class="p">,</span>  <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mg&#39;</span><span class="p">,</span> <span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span>   <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Ca&#39;</span><span class="p">,</span> <span class="s1">&#39;Sc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Zn&#39;</span><span class="p">,</span> <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;Rb&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span>  <span class="s1">&#39;Zr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mo&#39;</span><span class="p">,</span> <span class="s1">&#39;Tc&#39;</span><span class="p">,</span> <span class="s1">&#39;Ru&#39;</span><span class="p">,</span> <span class="s1">&#39;Rh&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="s1">&#39;Sn&#39;</span><span class="p">,</span> <span class="s1">&#39;Sb&#39;</span><span class="p">,</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Xe&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs&#39;</span><span class="p">,</span> <span class="s1">&#39;Ba&#39;</span><span class="p">,</span> <span class="s1">&#39;La&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ce&#39;</span><span class="p">,</span> <span class="s1">&#39;Pr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nd&#39;</span><span class="p">,</span> <span class="s1">&#39;Pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Sm&#39;</span><span class="p">,</span> <span class="s1">&#39;Eu&#39;</span><span class="p">,</span> <span class="s1">&#39;Gd&#39;</span><span class="p">,</span> <span class="s1">&#39;Tb&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy&#39;</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">,</span> <span class="s1">&#39;Er&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Yb&#39;</span><span class="p">,</span> <span class="s1">&#39;Lu&#39;</span><span class="p">,</span> <span class="s1">&#39;Hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Os&#39;</span><span class="p">,</span> <span class="s1">&#39;Ir&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="s1">&#39;Hg&#39;</span><span class="p">,</span> <span class="s1">&#39;Tl&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pb&#39;</span><span class="p">,</span> <span class="s1">&#39;Bi&#39;</span><span class="p">,</span> <span class="s1">&#39;Po&#39;</span><span class="p">,</span> <span class="s1">&#39;At&#39;</span><span class="p">,</span> <span class="s1">&#39;Rn&#39;</span><span class="p">,</span> <span class="s1">&#39;Fr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ra&#39;</span><span class="p">,</span> <span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;Th&#39;</span><span class="p">,</span> <span class="s1">&#39;Pa&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Np&#39;</span><span class="p">,</span> <span class="s1">&#39;Pu&#39;</span><span class="p">,</span> <span class="s1">&#39;Am&#39;</span><span class="p">,</span> <span class="s1">&#39;Cm&#39;</span><span class="p">,</span> <span class="s1">&#39;Bk&#39;</span><span class="p">,</span> <span class="s1">&#39;Cf&#39;</span><span class="p">,</span> <span class="s1">&#39;Es&#39;</span><span class="p">,</span> <span class="s1">&#39;Fm&#39;</span><span class="p">,</span> <span class="s1">&#39;Md&#39;</span><span class="p">,</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="s1">&#39;Lr&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Rf&#39;</span><span class="p">,</span> <span class="s1">&#39;Db&#39;</span><span class="p">,</span> <span class="s1">&#39;Sg&#39;</span> <span class="p">])</span>
    <span class="n">PERIODIC_NAMES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;hydrogen&#39;</span><span class="p">,</span> <span class="s1">&#39;helium&#39;</span><span class="p">,</span> <span class="s1">&#39;lithium&#39;</span><span class="p">,</span>  <span class="s1">&#39;beryllium&#39;</span><span class="p">,</span> <span class="s1">&#39;boron&#39;</span><span class="p">,</span>
        <span class="s1">&#39;carbon&#39;</span><span class="p">,</span> <span class="s1">&#39;nitrogen&#39;</span><span class="p">,</span> <span class="s1">&#39;oxygen&#39;</span><span class="p">,</span> <span class="s1">&#39;fluorine&#39;</span><span class="p">,</span> <span class="s1">&#39;neon&#39;</span><span class="p">,</span> <span class="s1">&#39;sodium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;magnesium&#39;</span><span class="p">,</span> <span class="s1">&#39;aluminum&#39;</span><span class="p">,</span> <span class="s1">&#39;silicon&#39;</span><span class="p">,</span> <span class="s1">&#39;phosphorous&#39;</span><span class="p">,</span> <span class="s1">&#39;sulfur&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chlorine&#39;</span><span class="p">,</span> <span class="s1">&#39;argon&#39;</span><span class="p">,</span> <span class="s1">&#39;potassium&#39;</span><span class="p">,</span> <span class="s1">&#39;calcium&#39;</span><span class="p">,</span> <span class="s1">&#39;scandium&#39;</span><span class="p">,</span> <span class="s1">&#39;titanium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;vanadium&#39;</span><span class="p">,</span> <span class="s1">&#39;chromium&#39;</span><span class="p">,</span> <span class="s1">&#39;manganese&#39;</span><span class="p">,</span> <span class="s1">&#39;iron&#39;</span><span class="p">,</span> <span class="s1">&#39;cobalt&#39;</span><span class="p">,</span> <span class="s1">&#39;nickel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;copper&#39;</span><span class="p">,</span> <span class="s1">&#39;zinc&#39;</span><span class="p">,</span> <span class="s1">&#39;gallium&#39;</span><span class="p">,</span> <span class="s1">&#39;germanium&#39;</span><span class="p">,</span> <span class="s1">&#39;arsenic&#39;</span><span class="p">,</span> <span class="s1">&#39;selenium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bromine&#39;</span><span class="p">,</span> <span class="s1">&#39;krypton&#39;</span><span class="p">,</span> <span class="s1">&#39;rubidium&#39;</span><span class="p">,</span> <span class="s1">&#39;strontium&#39;</span><span class="p">,</span> <span class="s1">&#39;yttrium&#39;</span><span class="p">,</span> <span class="s1">&#39;zirconium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;niobium&#39;</span><span class="p">,</span> <span class="s1">&#39;molybdenum&#39;</span><span class="p">,</span> <span class="s1">&#39;technetium&#39;</span><span class="p">,</span> <span class="s1">&#39;ruthenium&#39;</span><span class="p">,</span> <span class="s1">&#39;rhodium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;palladium&#39;</span><span class="p">,</span> <span class="s1">&#39;silver&#39;</span><span class="p">,</span> <span class="s1">&#39;cadmium&#39;</span><span class="p">,</span> <span class="s1">&#39;indium&#39;</span><span class="p">,</span> <span class="s1">&#39;tin&#39;</span><span class="p">,</span> <span class="s1">&#39;antimony&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tellurium&#39;</span><span class="p">,</span> <span class="s1">&#39;iodine&#39;</span><span class="p">,</span> <span class="s1">&#39;xenon&#39;</span><span class="p">,</span> <span class="s1">&#39;cesium&#39;</span><span class="p">,</span> <span class="s1">&#39;barium&#39;</span><span class="p">,</span> <span class="s1">&#39;lantahnum&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cerium&#39;</span><span class="p">,</span> <span class="s1">&#39;praseodymium&#39;</span><span class="p">,</span> <span class="s1">&#39;neodymium&#39;</span><span class="p">,</span> <span class="s1">&#39;promethium&#39;</span><span class="p">,</span> <span class="s1">&#39;samarium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;europium&#39;</span><span class="p">,</span> <span class="s1">&#39;gadolinium&#39;</span><span class="p">,</span> <span class="s1">&#39;terbium&#39;</span><span class="p">,</span> <span class="s1">&#39;dysprosium&#39;</span><span class="p">,</span> <span class="s1">&#39;holmium&#39;</span><span class="p">,</span> <span class="s1">&#39;erbium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;thulium&#39;</span><span class="p">,</span> <span class="s1">&#39;ytterbium&#39;</span><span class="p">,</span> <span class="s1">&#39;lutetium&#39;</span><span class="p">,</span> <span class="s1">&#39;hafnium&#39;</span><span class="p">,</span> <span class="s1">&#39;tantalum&#39;</span><span class="p">,</span> <span class="s1">&#39;tungsten&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rhenium&#39;</span><span class="p">,</span> <span class="s1">&#39;osmium&#39;</span><span class="p">,</span> <span class="s1">&#39;iridium&#39;</span><span class="p">,</span> <span class="s1">&#39;platinum&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">,</span> <span class="s1">&#39;mercury&#39;</span><span class="p">,</span>
        <span class="s1">&#39;thallium&#39;</span><span class="p">,</span> <span class="s1">&#39;lead&#39;</span><span class="p">,</span> <span class="s1">&#39;bismuth&#39;</span><span class="p">,</span> <span class="s1">&#39;polonium&#39;</span><span class="p">,</span> <span class="s1">&#39;astatine&#39;</span><span class="p">,</span> <span class="s1">&#39;radon&#39;</span><span class="p">,</span>
        <span class="s1">&#39;francium&#39;</span><span class="p">,</span> <span class="s1">&#39;radium&#39;</span><span class="p">,</span> <span class="s1">&#39;actinium&#39;</span><span class="p">,</span> <span class="s1">&#39;thorium&#39;</span><span class="p">,</span> <span class="s1">&#39;protactinium&#39;</span><span class="p">,</span> <span class="s1">&#39;uranium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;neptunium&#39;</span><span class="p">,</span> <span class="s1">&#39;plutonium&#39;</span><span class="p">,</span> <span class="s1">&#39;americium&#39;</span><span class="p">,</span> <span class="s1">&#39;curium&#39;</span><span class="p">,</span> <span class="s1">&#39;berkelium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;californium&#39;</span><span class="p">,</span> <span class="s1">&#39;einsteinium&#39;</span><span class="p">,</span> <span class="s1">&#39;fermium&#39;</span><span class="p">,</span> <span class="s1">&#39;mendelevium&#39;</span><span class="p">,</span> <span class="s1">&#39;nobelium&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lawrencium&#39;</span><span class="p">,</span> <span class="s1">&#39;ruferfordium&#39;</span><span class="p">,</span> <span class="s1">&#39;dubnium&#39;</span><span class="p">,</span> <span class="s1">&#39;seaborgium&#39;</span> <span class="p">])</span>
    <span class="n">PERIODIC_WEIGHTS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0079</span><span class="p">,</span> <span class="mf">4.00260</span><span class="p">,</span> <span class="mf">6.94</span><span class="p">,</span> <span class="mf">9.01218</span><span class="p">,</span> <span class="mf">10.81</span><span class="p">,</span> <span class="mf">12.011</span><span class="p">,</span> <span class="mf">14.0067</span><span class="p">,</span> <span class="mf">15.9994</span><span class="p">,</span>
        <span class="mf">18.998403</span><span class="p">,</span> <span class="mf">20.179</span><span class="p">,</span> <span class="mf">22.98977</span><span class="p">,</span> <span class="mf">24.305</span><span class="p">,</span> <span class="mf">26.98154</span><span class="p">,</span> <span class="mf">28.0855</span><span class="p">,</span> <span class="mf">30.97376</span><span class="p">,</span> <span class="mf">32.06</span><span class="p">,</span>
        <span class="mf">35.453</span><span class="p">,</span> <span class="mf">39.948</span><span class="p">,</span> <span class="mf">39.102</span><span class="p">,</span> <span class="mf">40.08</span><span class="p">,</span> <span class="mf">44.9559</span><span class="p">,</span> <span class="mf">47.90</span><span class="p">,</span> <span class="mf">50.9415</span><span class="p">,</span> <span class="mf">51.996</span><span class="p">,</span> <span class="mf">54.9380</span><span class="p">,</span>
        <span class="mf">55.847</span><span class="p">,</span> <span class="mf">58.9332</span><span class="p">,</span> <span class="mf">58.71</span><span class="p">,</span> <span class="mf">63.546</span><span class="p">,</span> <span class="mf">65.38</span><span class="p">,</span> <span class="mf">69.735</span><span class="p">,</span> <span class="mf">72.59</span><span class="p">,</span> <span class="mf">74.9216</span><span class="p">,</span> <span class="mf">78.96</span><span class="p">,</span>
        <span class="mf">79.904</span><span class="p">,</span> <span class="mf">83.80</span><span class="p">,</span> <span class="mf">85.4678</span><span class="p">,</span> <span class="mf">87.62</span><span class="p">,</span> <span class="mf">88.9059</span><span class="p">,</span> <span class="mf">91.22</span><span class="p">,</span> <span class="mf">92.9064</span><span class="p">,</span> <span class="mf">95.94</span><span class="p">,</span> <span class="mf">98.9062</span><span class="p">,</span>
        <span class="mf">101.07</span><span class="p">,</span> <span class="mf">102.9055</span><span class="p">,</span> <span class="mf">106.4</span><span class="p">,</span> <span class="mf">107.868</span><span class="p">,</span> <span class="mf">112.41</span><span class="p">,</span> <span class="mf">114.82</span><span class="p">,</span> <span class="mf">118.69</span><span class="p">,</span> <span class="mf">121.75</span><span class="p">,</span>
        <span class="mf">127.60</span><span class="p">,</span> <span class="mf">126.9045</span><span class="p">,</span> <span class="mf">131.30</span><span class="p">,</span> <span class="mf">132.9054</span><span class="p">,</span> <span class="mf">137.33</span><span class="p">,</span> <span class="mf">138.9055</span><span class="p">,</span> <span class="mf">140.12</span><span class="p">,</span> <span class="mf">140.9077</span><span class="p">,</span>
        <span class="mf">144.24</span><span class="p">,</span> <span class="mf">145.</span><span class="p">,</span> <span class="mf">150.4</span><span class="p">,</span> <span class="mf">151.96</span><span class="p">,</span> <span class="mf">157.25</span><span class="p">,</span> <span class="mf">158.9254</span><span class="p">,</span> <span class="mf">162.50</span><span class="p">,</span> <span class="mf">164.9304</span><span class="p">,</span> <span class="mf">167.26</span><span class="p">,</span>
        <span class="mf">168.9342</span><span class="p">,</span> <span class="mf">173.04</span><span class="p">,</span> <span class="mf">174.967</span><span class="p">,</span> <span class="mf">178.49</span><span class="p">,</span> <span class="mf">180.9479</span><span class="p">,</span> <span class="mf">183.85</span><span class="p">,</span> <span class="mf">186.207</span><span class="p">,</span> <span class="mf">190.2</span><span class="p">,</span>
        <span class="mf">192.22</span><span class="p">,</span> <span class="mf">195.09</span><span class="p">,</span> <span class="mf">196.9665</span><span class="p">,</span> <span class="mf">200.59</span><span class="p">,</span> <span class="mf">204.37</span><span class="p">,</span> <span class="mf">207.2</span><span class="p">,</span> <span class="mf">208.9804</span><span class="p">,</span> <span class="mf">209.</span><span class="p">,</span> <span class="mf">210.</span><span class="p">,</span>
        <span class="mf">222.</span><span class="p">,</span> <span class="mf">223.</span><span class="p">,</span> <span class="mf">226.0254</span><span class="p">,</span> <span class="mf">227.</span><span class="p">,</span> <span class="mf">232.0381</span><span class="p">,</span> <span class="mf">231.0359</span><span class="p">,</span> <span class="mf">238.029</span><span class="p">,</span> <span class="mf">237.0482</span><span class="p">,</span> <span class="mf">244.</span><span class="p">,</span>
        <span class="mf">243.</span><span class="p">,</span> <span class="mf">247.</span><span class="p">,</span> <span class="mf">247.</span><span class="p">,</span> <span class="mf">251.</span><span class="p">,</span> <span class="mf">254.</span><span class="p">,</span> <span class="mf">257.</span><span class="p">,</span> <span class="mf">258.</span><span class="p">,</span> <span class="mf">259.</span><span class="p">,</span> <span class="mf">260.</span><span class="p">,</span> <span class="mf">260.</span><span class="p">,</span> <span class="mf">260.</span><span class="p">,</span> <span class="mf">263.</span><span class="p">])</span>
    <span class="c1"># These entropy values are from Robie, Hemingway and Fisher (1979) USGS</span>
    <span class="c1"># Bull 1452 as stipulated by Berman (1988).  They are NOT the most recent</span>
    <span class="c1"># values (e.g.NIST)</span>
    <span class="n">DBL_MAX</span> <span class="o">=</span> <span class="mf">999999.0</span>
    <span class="n">PERIODIC_ENTROPES</span> <span class="o">=</span> <span class="p">([</span>
        <span class="mf">0.0</span><span class="p">,</span> <span class="mf">130.68</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">126.15</span><span class="p">,</span> <span class="mf">29.12</span><span class="p">,</span> <span class="mf">9.54</span><span class="p">,</span> <span class="mf">5.90</span><span class="p">,</span> <span class="mf">5.74</span><span class="p">,</span> <span class="mf">191.61</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="mf">205.15</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">202.79</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">146.32</span><span class="p">,</span> <span class="mf">51.30</span><span class="p">,</span> <span class="mf">32.68</span><span class="p">,</span> <span class="mf">28.35</span><span class="p">,</span> <span class="mf">18.81</span><span class="p">,</span> <span class="mf">22.85</span><span class="p">,</span>
        <span class="mf">31.80</span><span class="p">,</span> <span class="mf">223.08</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">154.84</span><span class="p">,</span> <span class="mf">64.68</span><span class="p">,</span> <span class="mf">41.63</span><span class="p">,</span> <span class="mf">34.64</span><span class="p">,</span> <span class="mf">30.63</span><span class="p">,</span> <span class="mf">28.91</span><span class="p">,</span> <span class="mf">23.64</span><span class="p">,</span>
        <span class="mf">32.01</span><span class="p">,</span> <span class="mf">27.28</span><span class="p">,</span> <span class="mf">30.04</span><span class="p">,</span> <span class="mf">29.87</span><span class="p">,</span> <span class="mf">33.15</span><span class="p">,</span> <span class="mf">41.63</span><span class="p">,</span> <span class="mf">40.83</span><span class="p">,</span> <span class="mf">31.09</span><span class="p">,</span> <span class="mf">35.69</span><span class="p">,</span> <span class="mf">42.27</span><span class="p">,</span>
        <span class="mf">245.46</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">164.08</span><span class="p">,</span> <span class="mf">76.78</span><span class="p">,</span> <span class="mf">55.40</span><span class="p">,</span> <span class="mf">44.43</span><span class="p">,</span> <span class="mf">38.99</span><span class="p">,</span> <span class="mf">36.40</span><span class="p">,</span> <span class="mf">28.66</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span>
        <span class="mf">28.53</span><span class="p">,</span> <span class="mf">31.54</span><span class="p">,</span> <span class="mf">37.82</span><span class="p">,</span> <span class="mf">42.55</span><span class="p">,</span> <span class="mf">51.80</span><span class="p">,</span> <span class="mf">57.84</span><span class="p">,</span> <span class="mf">51.20</span><span class="p">,</span> <span class="mf">45.52</span><span class="p">,</span> <span class="mf">49.50</span><span class="p">,</span>
        <span class="mf">116.15</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">169.68</span><span class="p">,</span> <span class="mf">85.23</span><span class="p">,</span> <span class="mf">62.42</span><span class="p">,</span> <span class="mf">56.90</span><span class="p">,</span> <span class="mf">69.46</span><span class="p">,</span> <span class="mf">73.93</span><span class="p">,</span> <span class="mf">71.09</span><span class="p">,</span>
        <span class="n">DBL_MAX</span><span class="p">,</span> <span class="mf">69.50</span><span class="p">,</span> <span class="mf">80.79</span><span class="p">,</span> <span class="mf">68.45</span><span class="p">,</span> <span class="mf">73.30</span><span class="p">,</span> <span class="mf">74.89</span><span class="p">,</span> <span class="mf">75.02</span><span class="p">,</span> <span class="mf">73.18</span><span class="p">,</span> <span class="mf">74.01</span><span class="p">,</span>
        <span class="mf">59.83</span><span class="p">,</span> <span class="mf">50.96</span><span class="p">,</span> <span class="mf">43.56</span><span class="p">,</span> <span class="mf">41.51</span><span class="p">,</span> <span class="mf">32.64</span><span class="p">,</span> <span class="mf">36.53</span><span class="p">,</span> <span class="mf">32.64</span><span class="p">,</span> <span class="mf">35.48</span><span class="p">,</span> <span class="mf">41.63</span><span class="p">,</span> <span class="mf">47.49</span><span class="p">,</span>
        <span class="mf">75.90</span><span class="p">,</span> <span class="mf">64.18</span><span class="p">,</span> <span class="mf">65.06</span><span class="p">,</span> <span class="mf">56.74</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="mf">176.23</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span>
        <span class="n">DBL_MAX</span><span class="p">,</span> <span class="mf">53.39</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="mf">50.29</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="mf">51.46</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span>
        <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span><span class="p">,</span>
        <span class="n">DBL_MAX</span><span class="p">,</span> <span class="n">DBL_MAX</span> <span class="p">])</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mole oxide to element conversion matrix</span>
<span class="sd">        - rows = oxides in standard OXIDE_ORDER</span>
<span class="sd">        - columns = elements in same order as they appear in OXIDE_ORDER matrix;</span>
<span class="sd">        thus, conversion matrix only valid for elements present in OXIDE_ORDER</span>
<span class="sd">        matrix; all Fe is converted to total Fe in column 4</span>
<span class="sd">        - column order = Si, Ti, Al, Fe, Cr, Mn, Mg, Ni, Co, Ca, Na, K, P, H, C, O</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MOL_OXIDE_TO_ELEM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>

    <span class="n">LEPR_phase_symbols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Liquid&#39;</span><span class="p">:</span><span class="s1">&#39;Liq&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Clinopyroxene&#39;</span><span class="p">:</span><span class="s1">&#39;Cpx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Garnet&#39;</span><span class="p">:</span><span class="s1">&#39;Grt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Olivine&#39;</span><span class="p">:</span><span class="s1">&#39;Ol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Orthopyroxene&#39;</span><span class="p">:</span><span class="s1">&#39;Opx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Biotite&#39;</span><span class="p">:</span><span class="s1">&#39;Bt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Fluid&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Corundum&#39;</span><span class="p">:</span><span class="s1">&#39;Crn&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Rutile&#39;</span><span class="p">:</span><span class="s1">&#39;Rt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Plagioclase&#39;</span><span class="p">:</span><span class="s1">&#39;Fsp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Amphibole&#39;</span><span class="p">:</span><span class="s1">&#39;Cam&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Zoisite&#39;</span><span class="p">:</span><span class="s1">&#39;Zo&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cordierite&#39;</span><span class="p">:</span><span class="s1">&#39;Crd&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Muscovite&#39;</span><span class="p">:</span><span class="s1">&#39;Ms&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Quartz&#39;</span><span class="p">:</span><span class="s1">&#39;Qz&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Kyanite&#39;</span><span class="p">:</span><span class="s1">&#39;Ky&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Potassium feldspar&#39;</span><span class="p">:</span><span class="s1">&#39;Fsp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sillimanite&#39;</span><span class="p">:</span><span class="s1">&#39;Sil&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Spinel&#39;</span><span class="p">:</span><span class="s1">&#39;SplS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Staurolite&#39;</span><span class="p">:</span><span class="kc">None</span> <span class="p">,</span>
        <span class="s1">&#39;Melilite&#39;</span><span class="p">:</span><span class="s1">&#39;Mll&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Carbonate melt&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Nepheline&#39;</span><span class="p">:</span><span class="s1">&#39;NphS&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ilmenite&#39;</span><span class="p">:</span><span class="s1">&#39;Ilm&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Eskolaite&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Anorthite&#39;</span><span class="p">:</span><span class="s1">&#39;An&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cc-dol&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_oxide_props</span><span class="p">()</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_init_oxide_props</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of oxide properties</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        oxide_data: dict with keys</span>
<span class="sd">            `oxides` : list of oxide strings</span>
<span class="sd">            `cations` : list of cation strings</span>
<span class="sd">            `molwt` : array of molecular weights</span>
<span class="sd">            `cat_num` : array of cation numbers</span>
<span class="sd">            `oxy_num` : array of oxygen numbers</span>
<span class="sd">            `oxycat_ratio` : array of oxygen/cation ratios</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">make_oxide_dat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cation</span><span class="p">,</span> <span class="n">molwt</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">catnum</span><span class="p">,</span> <span class="n">oxynum</span><span class="p">):</span>
            <span class="n">oxycat_ratio</span> <span class="o">=</span> <span class="n">oxynum</span><span class="o">/</span><span class="n">catnum</span>
            <span class="n">oxide_dat</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;cation&#39;</span><span class="p">:</span><span class="n">cation</span><span class="p">,</span> <span class="s1">&#39;molwt&#39;</span><span class="p">:</span><span class="n">molwt</span><span class="p">,</span>
                         <span class="s1">&#39;charge&#39;</span><span class="p">:</span><span class="n">charge</span><span class="p">,</span> <span class="s1">&#39;catnum&#39;</span><span class="p">:</span><span class="n">catnum</span><span class="p">,</span> <span class="s1">&#39;oxynum&#39;</span><span class="p">:</span><span class="n">oxynum</span><span class="p">,</span>
                         <span class="s1">&#39;oxycat_ratio&#39;</span><span class="p">:</span> <span class="n">oxycat_ratio</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">oxide_dat</span>

        <span class="n">oxide_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;SiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="mf">60.0848</span><span class="p">,</span> <span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;TiO2&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="mf">79.8988</span><span class="p">,</span> <span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;Al2O3&#39;</span><span class="p">,</span> <span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="mf">101.96128</span><span class="p">,</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;Fe2O3&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="mf">159.6922</span><span class="p">,</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;Cr2O3&#39;</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="mf">151.9902</span><span class="p">,</span> <span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;FeO&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="mf">71.8464</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;MnO&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="mf">70.9374</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;MgO&#39;</span><span class="p">,</span> <span class="s1">&#39;Mg&#39;</span><span class="p">,</span> <span class="mf">40.3044</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;NiO&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="mf">74.7094</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;CoO&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="mf">74.9326</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;CaO&#39;</span><span class="p">,</span> <span class="s1">&#39;Ca&#39;</span><span class="p">,</span> <span class="mf">56.0794</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;Na2O&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="mf">61.97894</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;K2O&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="mf">94.1954</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;P2O5&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="mf">141.94452</span><span class="p">,</span> <span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mf">18.0152</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">oxide_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_oxide_dat</span><span class="p">(</span><span class="s1">&#39;CO2&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="mf">44.0098</span><span class="p">,</span> <span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


        <span class="n">oxide_props</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxide_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxide_data</span><span class="p">)</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxides&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;cations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;cation&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;cat_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;catnum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxy_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;oxynum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>
        <span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxycat_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">idat</span><span class="p">[</span><span class="s1">&#39;oxycat_ratio&#39;</span><span class="p">]</span>
                                               <span class="k">for</span> <span class="n">idat</span> <span class="ow">in</span> <span class="n">oxide_data</span><span class="p">])</span>

        <span class="c1"># for idat in oxide_data:</span>
        <span class="c1">#     oxide = idat[&#39;name&#39;]</span>
        <span class="c1">#     oxide_props[oxide] = idat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_oxide_props</span> <span class="o">=</span> <span class="n">oxide_props</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">oxide_props</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oxide_props</span>

    <span class="k">def</span> <span class="nf">select_oxides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxide_names</span><span class="p">,</span> <span class="n">oxide_values</span><span class="p">):</span>
        <span class="c1"># oxide_molwt = chem.oxide_props[&#39;molwt&#39;]</span>
        <span class="n">oxides</span> <span class="o">=</span> <span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxides&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">oxname</span> <span class="ow">in</span> <span class="n">oxides</span> <span class="k">for</span> <span class="n">oxname</span> <span class="ow">in</span> <span class="n">oxide_names</span><span class="p">]),(</span>
            <span class="s1">&#39;oxide_names must all be valid oxide names&#39;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">oxide_values</span><span class="p">[</span><span class="n">oxides</span><span class="o">==</span><span class="n">iname</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">iname</span> <span class="ow">in</span> <span class="n">oxide_names</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">calc_mol_oxide_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_comp</span><span class="p">):</span>
        <span class="n">major_cations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;cations&#39;</span><span class="p">]</span>

        <span class="c1"># NOTE: not necessarily actually monovalent, but where we consider only one valence state</span>
        <span class="n">monovalent_oxide_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;cations&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;Fe&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">FeO_oxide_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxides&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;FeO&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Fe2O3_oxide_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxides&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Fe2O3&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_atomic_indices</span><span class="p">(</span><span class="n">monovalent_cations</span><span class="p">):</span>
            <span class="n">monovalent_elem_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elems</span><span class="o">==</span><span class="n">icat</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                           <span class="k">for</span> <span class="n">icat</span> <span class="ow">in</span> <span class="n">monovalent_cations</span><span class="p">])</span>
            <span class="n">oxy_elem_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elems</span><span class="o">==</span><span class="s1">&#39;O&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Fe_elem_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elems</span><span class="o">==</span><span class="s1">&#39;Fe&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">monovalent_elem_ind</span><span class="p">,</span> <span class="n">oxy_elem_ind</span><span class="p">,</span> <span class="n">Fe_elem_ind</span>

        <span class="k">def</span> <span class="nf">calc_Fe_oxides</span><span class="p">(</span><span class="n">Fe_remain</span><span class="p">,</span> <span class="n">oxy_remain</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Fe_remain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mol_FeO</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mol_Fe2O3</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#ratio = oxy_remain/Fe_remain</span>
                <span class="c1">#frac_Fe2O3 = (ratio-1)/(1.5-1)</span>
                <span class="c1">#frac_FeO = 1-frac_Fe2O3</span>

                <span class="c1">#mol_Fe_oxide = Fe_remain/(2*frac_Fe2O3 + 1*frac_FeO)</span>
                <span class="c1">#mol_FeO = mol_Fe_oxide*frac_FeO</span>
                <span class="c1">#mol_Fe2O3 = mol_Fe_oxide*frac_Fe2O3</span>

                <span class="n">mol_Fe2O3</span> <span class="o">=</span> <span class="n">oxy_remain</span> <span class="o">-</span> <span class="n">Fe_remain</span>
                <span class="n">mol_FeO</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">Fe_remain</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">oxy_remain</span>

            <span class="k">return</span> <span class="n">mol_FeO</span><span class="p">,</span> <span class="n">mol_Fe2O3</span>

        <span class="n">monovalent_oxides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxides&#39;</span><span class="p">][</span><span class="n">monovalent_oxide_ind</span><span class="p">]</span>
        <span class="n">monovalent_cations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;cations&#39;</span><span class="p">][</span><span class="n">monovalent_oxide_ind</span><span class="p">]</span>
        <span class="n">monovalent_cat_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;cat_num&#39;</span><span class="p">][</span><span class="n">monovalent_oxide_ind</span><span class="p">]</span>
        <span class="n">monovalent_oxy_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxy_num&#39;</span><span class="p">][</span><span class="n">monovalent_oxide_ind</span><span class="p">]</span>

        <span class="n">elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PERIODIC_ORDER</span>

        <span class="n">monovalent_elem_ind</span><span class="p">,</span> <span class="n">oxy_elem_ind</span><span class="p">,</span> <span class="n">Fe_elem_ind</span> <span class="o">=</span>     <span class="n">get_atomic_indices</span><span class="p">(</span><span class="n">monovalent_cations</span><span class="p">)</span>


        <span class="c1"># extract array of all major elements from the composition</span>
        <span class="n">monovalent_element_comp</span> <span class="o">=</span> <span class="n">element_comp</span><span class="p">[</span><span class="n">monovalent_elem_ind</span><span class="p">]</span>
        <span class="n">monovalent_mol_oxide_comp</span> <span class="o">=</span> <span class="n">monovalent_element_comp</span><span class="o">/</span><span class="n">monovalent_cat_num</span>

        <span class="n">monovalent_mol_oxy_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">monovalent_oxy_num</span><span class="o">*</span><span class="n">monovalent_mol_oxide_comp</span><span class="p">)</span>


        <span class="n">oxy_remain</span> <span class="o">=</span> <span class="n">element_comp</span><span class="p">[</span><span class="n">oxy_elem_ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">monovalent_mol_oxy_tot</span>
        <span class="n">Fe_remain</span> <span class="o">=</span> <span class="n">element_comp</span><span class="p">[</span><span class="n">Fe_elem_ind</span><span class="p">]</span>

        <span class="n">mol_FeO</span><span class="p">,</span> <span class="n">mol_Fe2O3</span> <span class="o">=</span> <span class="n">calc_Fe_oxides</span><span class="p">(</span><span class="n">Fe_remain</span><span class="p">,</span> <span class="n">oxy_remain</span><span class="p">)</span>

        <span class="n">mol_oxide_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxide_num&#39;</span><span class="p">])</span>
        <span class="n">mol_oxide_comp</span><span class="p">[</span><span class="n">monovalent_oxide_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">monovalent_mol_oxide_comp</span>
        <span class="n">mol_oxide_comp</span><span class="p">[</span><span class="n">FeO_oxide_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_FeO</span>
        <span class="n">mol_oxide_comp</span><span class="p">[</span><span class="n">Fe2O3_oxide_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_Fe2O3</span>

        <span class="k">return</span> <span class="n">mol_oxide_comp</span>

    <span class="k">def</span> <span class="nf">format_mol_oxide_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_oxides</span><span class="p">,</span> <span class="n">convert_grams_to_moles</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert mol_oxide dictionary to mol_oxide array</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ==========</span>
<span class="sd">        mol_oxides: Dictionary</span>
<span class="sd">            Dictionary of molar oxide compositions with oxide</span>
<span class="sd">            names as keys</span>

<span class="sd">        convert_grams_to_moles: False, default</span>
<span class="sd">            boolean flag indicating weight input in grams</span>

<span class="sd">        Returns:</span>
<span class="sd">        ========</span>
<span class="sd">        mol_oxide_comp: np array</span>
<span class="sd">            Molar oxide array in standard oxide order</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">OXIDE_ORDER</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OXIDE_ORDER</span>
        <span class="n">mol_oxide_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">OXIDE_ORDER</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">oxide</span> <span class="ow">in</span> <span class="n">OXIDE_ORDER</span>
                       <span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">mol_oxides</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">mol_oxides</span><span class="p">:</span>
            <span class="n">mol_oxide</span> <span class="o">=</span> <span class="n">mol_oxides</span><span class="p">[</span><span class="n">oxide</span><span class="p">]</span>
            <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">OXIDE_ORDER</span><span class="o">==</span><span class="n">oxide</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">convert_grams_to_moles</span><span class="p">:</span>
                <span class="n">mol_oxide_comp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_oxide</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mol_oxide_comp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_oxide</span>

        <span class="k">return</span> <span class="n">mol_oxide_comp</span>

    <span class="k">def</span> <span class="nf">mol_oxide_to_elem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_oxides</span><span class="p">,</span> <span class="n">oxide_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert mole oxide composition to mole element composition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mol_oxides : array</span>
<span class="sd">            mole oxide composition defined in standard OXIDE_ORDER</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mol_elem : array</span>
<span class="sd">            mole element composition with elements in same order as oxide array;</span>
<span class="sd">            only functions for elements present in OXIDE_ORDER; Fe given as total Fe</span>
<span class="sd">            elem order is Si, Ti, Al, Fe, Cr, Mn, Mg, Ni, Co, Ca, Na, K, P, H, C, O</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># MOL_OXIDE_TO_ELEM = self.MOL_OXIDE_TO_ELEM</span>


        <span class="n">MOL_OXIDE_TO_ELEM</span><span class="p">,</span> <span class="n">oxide_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_oxides_list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MOL_OXIDE_TO_ELEM</span><span class="p">,</span> <span class="n">oxide_names</span><span class="p">)</span>

        <span class="c1"># oxide_molecular_wts = self.oxide_props[&#39;molwt&#39;]</span>
        <span class="c1"># oxide_molecular_wts = self.get_molwt(oxide_names)</span>
        <span class="c1"># MOL_OXIDE_TO_ELEM = self.select_oxides(oxide_names, self.MOL_OXIDE_TO_ELEM)</span>


        <span class="n">mol_elem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mol_oxides</span><span class="p">,</span> <span class="n">MOL_OXIDE_TO_ELEM</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mol_elem</span>

    <span class="k">def</span> <span class="nf">get_Berman_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get chemical formula in Berman form (e.g., H(2.0)O(1.0)).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        element_comp : double array</span>
<span class="sd">            Element composition defined in standard PERIODIC_ORDER</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        formula : str</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">amt</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">element_comp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PERIODIC_ORDER</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">amt</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">formula</span> <span class="o">+=</span> <span class="n">sym</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">return</span> <span class="n">formula</span>

    <span class="k">def</span> <span class="nf">elem_to_oxide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># %el x (oxide molecular weight/el weight) = wt% oxide</span>

        <span class="k">raise</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">oxide_to_elem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxide_names</span><span class="p">,</span> <span class="n">oxide_wts</span><span class="p">):</span>
        <span class="c1">#oxide_names = np.array([oxide_names])</span>
        <span class="c1">#oxide_wts = np.array([oxide_wts])</span>
        <span class="c1">#oxide_molecular_wts = self.oxide_props[&#39;molwt&#39;]</span>
        <span class="c1">#wt% oxide to el% is -- wt% oxide x (el weight/oxide molecular weight)=el%</span>

        <span class="k">raise</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">get_comp_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">_validate_oxides_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxide_values</span><span class="p">,</span> <span class="n">oxide_names</span><span class="p">):</span>
        <span class="n">oxide_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">oxide_values</span><span class="p">)</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">oxide_values</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">noxides</span> <span class="o">=</span> <span class="n">oxide_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">noxides</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxide_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">oxide_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">oxide_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OXIDE_ORDER</span>

        <span class="n">oxide_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">oxide_names</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxide_names</span><span class="p">)</span><span class="o">==</span><span class="n">noxides</span><span class="p">,</span> <span class="p">(</span>
            <span class="s1">&#39;Num. of oxide names must match oxide wts.&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">oxide_values</span><span class="p">,</span> <span class="n">oxide_names</span>

    <span class="k">def</span> <span class="nf">_normalize_oxide_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxide_values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">oxide_values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">oxide_values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">totals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">oxide_values</span><span class="p">)</span>

        <span class="n">oxide_values</span> <span class="o">=</span> <span class="n">oxide_values</span><span class="o">/</span><span class="n">totals</span>

        <span class="k">return</span> <span class="n">oxide_values</span>

    <span class="k">def</span> <span class="nf">wt_to_mol_oxide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxide_wts</span><span class="p">,</span> <span class="n">oxide_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">oxide_wts</span><span class="p">,</span> <span class="n">oxide_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_oxides_list</span><span class="p">(</span>
            <span class="n">oxide_wts</span><span class="p">,</span> <span class="n">oxide_names</span><span class="p">)</span>

        <span class="c1"># oxide_molecular_wts = self.oxide_props[&#39;molwt&#39;]</span>
        <span class="c1"># oxide_molecular_wts = self.get_molwt(oxide_names)</span>
        <span class="n">oxide_molecular_wts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_oxides</span><span class="p">(</span><span class="n">oxide_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">])</span>

        <span class="n">mol_oxides</span> <span class="o">=</span> <span class="n">oxide_wts</span><span class="o">/</span><span class="n">oxide_molecular_wts</span>
        <span class="n">mol_oxides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_oxide_comp</span><span class="p">(</span><span class="n">mol_oxides</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mol_oxides</span>

    <span class="k">def</span> <span class="nf">mol_to_wt_oxide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_oxides</span><span class="p">,</span> <span class="n">oxide_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">mol_oxides</span><span class="p">,</span> <span class="n">oxide_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_oxides_list</span><span class="p">(</span>
            <span class="n">mol_oxides</span><span class="p">,</span> <span class="n">oxide_names</span><span class="p">)</span>

        <span class="n">oxide_molecular_wts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">]</span>

        <span class="n">wt_oxides</span> <span class="o">=</span> <span class="n">mol_oxides</span><span class="o">*</span><span class="n">oxide_molecular_wts</span>
        <span class="n">wt_oxides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_oxide_comp</span><span class="p">(</span><span class="n">wt_oxides</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wt_oxides</span>

    <span class="k">def</span> <span class="nf">get_phase_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rxn_data</span><span class="p">[</span><span class="s1">&#39;phase_symbols&#39;</span><span class="p">][</span><span class="s1">&#39;phase_symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">format_meas_mineral_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_comp</span><span class="p">,</span> <span class="n">o_site_total</span><span class="p">):</span>
        <span class="n">mineral_mol_elem_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_oxide_to_elem</span><span class="p">(</span><span class="n">mineral_comp</span><span class="p">)</span>
        <span class="n">meas_elem_comp</span> <span class="o">=</span> <span class="n">mineral_mol_elem_comp</span><span class="o">*</span><span class="n">o_site_total</span><span class="o">/</span><span class="n">mineral_mol_elem_comp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">meas_elem_comp</span>

    <span class="k">def</span> <span class="nf">_validate_site_occ_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single_value_index</span><span class="p">,</span> <span class="n">site_id_index</span><span class="p">,</span> <span class="n">endmember_site_occ</span><span class="p">,</span>
                                 <span class="n">site_totals</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">ival</span> <span class="ow">in</span> <span class="n">single_value_index</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">site_id_index</span><span class="p">[</span><span class="n">ival</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">iendmem</span> <span class="ow">in</span> <span class="n">endmember_site_occ</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">iendmem</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span><span class="n">site_totals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span>
                             <span class="s1">&#39;The last column of the site occupancy matrix and last element &#39;</span>
                             <span class="s1">&#39;of the site totals array must be equal. Recall, the last column &#39;</span>
                             <span class="s1">&#39;of the site_occupancy matrix must be oxygen and must have &#39;</span>
                             <span class="s1">&#39;values equal to the last element of the site totals array.&#39;</span><span class="p">)</span>

                <span class="k">assert</span> <span class="n">iendmem</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==</span><span class="n">site_totals</span><span class="p">[</span><span class="n">ival</span><span class="p">],</span> <span class="p">(</span>
                             <span class="s1">&#39;Invariant sites in the site occ matrix are not equal to&#39;</span>
                             <span class="s1">&#39;the site totals.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_success_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residual</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residual</span><span class="p">))</span><span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="s1">&#39;minimization successful&#39;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="s1">&#39;minimization failed; residual greater than threshold value&#39;</span>

        <span class="k">return</span> <span class="n">success</span>

    <span class="k">def</span> <span class="nf">lstsqr_endmember_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_oxide_comp</span><span class="p">,</span> <span class="n">mol_oxide_comp_endmembers</span><span class="p">,</span> <span class="n">decimals</span><span class="p">):</span>
        <span class="c1">#mol_oxide_comp_endmembers = phases.props[&#39;mol_oxide_comp&#39;]</span>
        <span class="c1">#mol_oxide_comp_endmembers = modelDB.phases[abbrev].props[&#39;mol_oxide_comp&#39;]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
            <span class="n">mol_oxide_comp_endmembers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mol_oxide_comp</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">endmember_comp</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">endmember_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">endmember_comp</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">)</span>

        <span class="n">mol_oxide_comp_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mol_oxide_comp_endmembers</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">endmember_comp</span><span class="p">)</span>
        <span class="n">mol_oxide_comp_residual</span> <span class="o">=</span> <span class="p">(</span><span class="n">mol_oxide_comp</span> <span class="o">-</span> <span class="n">mol_oxide_comp_model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">endmember_comp</span><span class="p">,</span> <span class="n">mol_oxide_comp_model</span><span class="p">,</span> <span class="n">mol_oxide_comp_residual</span>

    <span class="k">def</span> <span class="nf">site_spec_lstsq_endmember_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">endmember_elem_stoic</span><span class="p">,</span>
                             <span class="n">endmember_site_occ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer endmember composition using least squares method.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ==========</span>
<span class="sd">        meas_elem_comp: array</span>
<span class="sd">            measured mole element composition for specific phase</span>
<span class="sd">            elements must be in the order (Si, Ti, Al, Fe, Cr, Mn,</span>
<span class="sd">            Mg, Ni, Co, Ca, Na, K, P, H, C, O))</span>

<span class="sd">        endmember_elem_stoic: array</span>
<span class="sd">            stoichiometry of endmembers in terms of elements</span>
<span class="sd">            rows = individual endmembers</span>
<span class="sd">            columns = elements (following the order Si, Ti, Al, Fe, Cr, Mn,</span>
<span class="sd">            Mg, Ni, Co, Ca, Na, K, P, H, C, O)</span>

<span class="sd">        endmember_site_occ: array</span>
<span class="sd">            site occupancies for each endmember</span>
<span class="sd">            rows = individual endmembers</span>
<span class="sd">            columns = site occupancies in the order of elements on X site,</span>
<span class="sd">            elements on Y site, T site, followed by oxygen.</span>

<span class="sd">        Returns:</span>
<span class="sd">        ========</span>
<span class="sd">        endmember_comp_lsq: np array</span>
<span class="sd">            endmember proportions from least squares fit</span>

<span class="sd">        site_occ_lsq: array</span>
<span class="sd">            site occupancy proportions from least squares fit</span>

<span class="sd">        resid_lsq: array</span>
<span class="sd">            least squares residual</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endmember_comp_lsq</span><span class="p">,</span> <span class="n">resid_lsq</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">sing_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lingalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">endmember_elem_stoic</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">)</span>
        <span class="n">site_occ_lsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">endmember_site_occ</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">endmember_comp_lsq</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">endmember_comp_lsq</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">resid_lsq</span>

    <span class="k">def</span> <span class="nf">nnls_endmember_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">endmember_elem_stoic</span><span class="p">,</span> <span class="n">endmember_site_occ</span><span class="p">):</span>

        <span class="n">endmember_comp_nnls</span><span class="p">,</span> <span class="n">resid_nnls</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">nnls</span><span class="p">(</span><span class="n">endmember_elem_stoic</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">)</span>
        <span class="n">site_occ_nnls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">endmember_site_occ</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">endmember_comp_nnls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">endmember_comp_nnls</span><span class="p">,</span> <span class="n">site_occ_nnls</span><span class="p">,</span> <span class="n">resid_nnls</span>


    <span class="k">def</span> <span class="nf">_null_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endmember_site_occ_dev</span><span class="p">):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">endmember_site_occ_dev</span><span class="p">)</span>

        <span class="n">null_vectors</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1e-10</span>
        <span class="k">for</span> <span class="n">ivh</span> <span class="ow">in</span> <span class="n">vh</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">endmember_site_occ_dev</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ivh</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">):</span>
                <span class="n">null_vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ivh</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">null_vectors</span>

    <span class="k">def</span> <span class="nf">_site_occ_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endmember_comp_lsq</span><span class="p">,</span> <span class="n">site_occ_stoic</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">,</span>
                              <span class="n">endmember_site_occ</span><span class="p">,</span> <span class="n">null_vectors</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span>
                              <span class="n">avg_endmember_site_occ</span><span class="p">,</span> <span class="n">site_totals</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">uniq_site_id</span><span class="p">,</span>
                              <span class="n">single_value_index</span><span class="p">):</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">endmember_comp_lsq</span><span class="p">,</span> <span class="n">site_occ_stoic</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">site_occ_stoic</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">endmember_comp_lsq</span><span class="p">)</span> <span class="o">-</span> <span class="n">meas_elem_comp</span><span class="p">))</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">endmember_site_occ</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inull_vec</span> <span class="ow">in</span> <span class="n">null_vectors</span><span class="p">:</span>
            <span class="n">con</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">con</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;eq&#39;</span>
            <span class="n">con</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">avg_endmember_site_occ</span><span class="o">=</span><span class="n">avg_endmember_site_occ</span><span class="p">,</span> <span class="n">inull_vec</span><span class="o">=</span><span class="n">inull_vec</span><span class="p">:</span> <span class="p">(</span>
                                <span class="n">inull_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site_occ_lsq</span><span class="o">-</span><span class="n">avg_endmember_site_occ</span><span class="p">))</span>

            <span class="n">cons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ivalue</span> <span class="ow">in</span> <span class="n">single_value_index</span><span class="p">:</span>
            <span class="n">uniq_site_id</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ivalue</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">isite</span> <span class="ow">in</span> <span class="n">uniq_site_id</span><span class="p">:</span>
            <span class="n">imask</span> <span class="o">=</span> <span class="n">site_id</span> <span class="o">==</span><span class="n">isite</span>
            <span class="n">isite_dev</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">imask</span><span class="o">=</span><span class="n">imask</span><span class="p">,</span> <span class="n">site_totals</span><span class="o">=</span><span class="n">site_totals</span><span class="p">,</span><span class="n">isite</span><span class="o">=</span><span class="n">isite</span><span class="p">:</span> <span class="p">(</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">site_occ_lsq</span><span class="p">[</span><span class="n">imask</span><span class="p">])</span><span class="o">-</span><span class="n">site_totals</span><span class="p">[</span><span class="n">isite</span><span class="p">])</span>
            <span class="n">cons</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="n">isite_dev</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">fn</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cons</span>

    <span class="k">def</span> <span class="nf">_constrained_minimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">site_occ_stoic</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span>
                                    <span class="n">endmember_site_occ</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">site_occ_stoic</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span>
                       <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">)</span>

        <span class="n">site_occ_constr</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span>

        <span class="n">endmember_comp_constr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">endmember_site_occ</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site_occ_constr</span><span class="p">)</span>
        <span class="n">resid_constr</span> <span class="o">=</span> <span class="n">site_occ_stoic</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">site_occ_constr</span><span class="p">)</span> <span class="o">-</span> <span class="n">meas_elem_comp</span>
        <span class="n">rms_resid_constr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">resid_constr</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success_test</span><span class="p">(</span><span class="n">resid_constr</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">site_occ_constr</span><span class="p">,</span> <span class="n">endmember_comp_constr</span><span class="p">,</span> <span class="n">resid_constr</span><span class="p">,</span> <span class="n">rms_resid_constr</span><span class="p">,</span> <span class="n">success</span>

    <span class="k">def</span> <span class="nf">infer_endmember_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">endmember_elem_stoic</span><span class="p">,</span>
                             <span class="n">endmember_site_occ</span><span class="p">,</span> <span class="n">site_totals</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span>
                             <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span> <span class="n">lstsq_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Infer endmember composition using minimization method.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        * This method is not currently being used in calibration code; there</span>
<span class="sd">        is an analogous function in phases.py called &quot;calc_endmember_comp&quot;</span>

<span class="sd">        * This function implements a complex mechanism of calculating endmember</span>
<span class="sd">        compositions in which it involves detailed site occupancy constraints</span>
<span class="sd">        not inherent in either the intrinsic or least squares minimizations to</span>
<span class="sd">        get endmember compositions</span>

<span class="sd">        * This function has a more extensive output and will spit out site</span>
<span class="sd">        occupanices under least squares and constrained minimizations as well</span>
<span class="sd">        as residuals and success statements</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ==========</span>
<span class="sd">        meas_elem_comp: array</span>
<span class="sd">            measured mole element composition for specific phase</span>

<span class="sd">        endmember_elem_stoic: array</span>
<span class="sd">            stoichiometry of endmembers in terms of elements</span>
<span class="sd">            rows = individual endmembers</span>
<span class="sd">            columns = elements (following the order Si, Ti, Al, Fe, Cr, Mn,</span>
<span class="sd">            Mg, Ni, Co, Ca, Na, K, P, H, C, O)</span>

<span class="sd">        endmember_site_occ: array</span>
<span class="sd">            site occupancies for each endmember</span>
<span class="sd">            rows = individual endmembers</span>
<span class="sd">            columns = site occupancies in the order of elements on X site,</span>
<span class="sd">            elements on Y site, T site, followed by oxygen.</span>

<span class="sd">        site_totals: array</span>
<span class="sd">            total atoms allowed on each site</span>

<span class="sd">        output: True, default</span>
<span class="sd">            boolean flag indicating whether full output dictionary is returned;</span>
<span class="sd">            if False, function will return endmember proportions only</span>

<span class="sd">        Returns:</span>
<span class="sd">        ========</span>
<span class="sd">        output: dict</span>
<span class="sd">            dictionary contents are as follows:</span>
<span class="sd">                endmember_comp_lsq: array</span>
<span class="sd">                    endmember proportions from least squares fit</span>

<span class="sd">                site_occ_lsq: array</span>
<span class="sd">                    site occupancie proportions from least squares fit</span>

<span class="sd">                site_occ_constr: array</span>
<span class="sd">                    final site occupancy proportions from minimization function</span>

<span class="sd">                endmember_comp_constr: array</span>
<span class="sd">                    final endmember proportions after minimization</span>

<span class="sd">                resid_lsq: array</span>
<span class="sd">                    least squares residual</span>

<span class="sd">                resid_constr: array</span>
<span class="sd">                    residual using site proportions from minimization</span>
<span class="sd">                    (minimizes Ax-b=0)</span>

<span class="sd">                rms_resid_constr: int</span>
<span class="sd">                    root mean square of resid_constr array</span>

<span class="sd">        OR</span>

<span class="sd">        endmember_comp_constr: array</span>
<span class="sd">            final endmember proportions after minimization</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">site_id_info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">site_id</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">uniq_site_id</span> <span class="o">=</span> <span class="n">site_id_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">uniq_site_id</span> <span class="o">=</span> <span class="n">uniq_site_id</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">site_id_index</span> <span class="o">=</span> <span class="n">site_id_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">site_id_count</span> <span class="o">=</span> <span class="n">site_id_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">single_value_index</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">site_id_count</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_site_occ_input</span><span class="p">(</span><span class="n">single_value_index</span><span class="p">,</span> <span class="n">site_id_index</span><span class="p">,</span> <span class="n">endmember_site_occ</span><span class="p">,</span>
                                     <span class="n">site_totals</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lstsq_fit</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

            <span class="n">endmember_comp_lsq</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">resid_lsq</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lstsq_endmember_comp</span><span class="p">(</span><span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">endmember_elem_stoic</span><span class="p">,</span>
                                        <span class="n">endmember_site_occ</span><span class="p">))</span>

            <span class="n">endmember_site_occ_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">endmember_site_occ</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">site_occ_stoic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">endmember_elem_stoic</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">endmember_site_occ_inv</span><span class="p">)</span>

            <span class="n">avg_endmember_site_occ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">endmember_site_occ</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">endmember_site_occ_dev</span> <span class="o">=</span> <span class="n">endmember_site_occ</span><span class="o">-</span><span class="n">avg_endmember_site_occ</span>

            <span class="n">null_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_null_vectors</span><span class="p">(</span><span class="n">endmember_site_occ_dev</span><span class="p">)</span>

            <span class="n">fn</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_occ_constraints</span><span class="p">(</span><span class="n">endmember_comp_lsq</span><span class="p">,</span> <span class="n">site_occ_stoic</span><span class="p">,</span> <span class="n">meas_elem_comp</span><span class="p">,</span>
                                                     <span class="n">endmember_site_occ</span><span class="p">,</span> <span class="n">null_vectors</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span>
                                                     <span class="n">avg_endmember_site_occ</span><span class="p">,</span> <span class="n">site_totals</span><span class="p">,</span> <span class="n">site_id</span><span class="p">,</span> <span class="n">uniq_site_id</span><span class="p">,</span>
                                                     <span class="n">single_value_index</span><span class="p">)</span>

            <span class="n">site_occ_constr</span><span class="p">,</span> <span class="n">endmember_comp_constr</span><span class="p">,</span> <span class="n">resid_constr</span><span class="p">,</span> <span class="n">rms_resid_constr</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_constrained_minimization</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">site_occ_lsq</span><span class="p">,</span> <span class="n">site_occ_stoic</span><span class="p">,</span><span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span>
                                               <span class="n">endmember_site_occ</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">success</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;endmember_comp_lsq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endmember_comp_lsq</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;site_occ_lsq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_occ_lsq</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;resid_lsq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resid_lsq</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;site_occ_constr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_occ_constr</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;endmember_comp_constr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endmember_comp_constr</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;resid_constr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resid_constr</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;rms_resid_constr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rms_resid_constr</span>

                <span class="k">return</span> <span class="n">output</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">endmember_comp_constr</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">endmember_comp_nnls</span><span class="p">,</span> <span class="n">site_occ_nnls</span><span class="p">,</span> <span class="n">resid_nnls</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">nnls_endmember_comp</span><span class="p">(</span><span class="n">meas_elem_comp</span><span class="p">,</span> <span class="n">endmember_elem_stoic</span><span class="p">,</span>
                                                         <span class="n">endmember_site_occ</span><span class="p">))</span>

            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success_test</span><span class="p">(</span><span class="n">resid_nnls</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">success</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;endmember_comp_nnls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endmember_comp_nnls</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;site_occ_nnls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_occ_nnls</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;resid_nnls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resid_nnls</span>

                <span class="k">return</span> <span class="n">output</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">endmember_comp_nnls</span>

    <span class="k">def</span> <span class="nf">calc_reaction_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_symbols</span><span class="p">,</span> <span class="n">TOLsvd</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">modelDB</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain svd of valid set of reactions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase_symbols : list of strings</span>
<span class="sd">            list of phases (according to Berman abbreviations) that are</span>
<span class="sd">            allowed to participate in any given reaction</span>
<span class="sd">        TOL :</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        rxn_svd: array</span>
<span class="sd">            set of linearly independent reactions with variance minimized and</span>
<span class="sd">            orthogonality maximized</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">modelDB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">model</span>
            <span class="n">modelDB</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Database</span><span class="p">()</span>

        <span class="n">oxide_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxide_num&#39;</span><span class="p">]</span>
        <span class="n">all_mol_oxide_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">oxide_num</span><span class="p">))</span>
        <span class="n">all_phase_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_phase_symbol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_endmember_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_endmember_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">all_phase_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">all_atom_num</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">ind_phs</span><span class="p">,</span> <span class="n">iabbrev</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_symbols</span><span class="p">):</span>
            <span class="c1">#iphs_props = modelDB.phase_attributes[iabbrev][&#39;props&#39;]</span>
            <span class="n">iphs_props</span> <span class="o">=</span> <span class="n">modelDB</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="n">iabbrev</span><span class="p">]</span><span class="o">.</span><span class="n">props</span>
            <span class="n">iall_mol_oxide_comp</span> <span class="o">=</span> <span class="n">iphs_props</span><span class="p">[</span><span class="s1">&#39;mol_oxide_comp&#39;</span><span class="p">]</span>
            <span class="n">iphase_name</span> <span class="o">=</span> <span class="n">iphs_props</span><span class="p">[</span><span class="s1">&#39;phase_name&#39;</span><span class="p">]</span>
            <span class="n">iendmember_name</span> <span class="o">=</span> <span class="n">iphs_props</span><span class="p">[</span><span class="s1">&#39;endmember_name&#39;</span><span class="p">]</span>
            <span class="n">iendmember_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iendmember_name</span><span class="p">)</span>
            <span class="n">iendmember_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">iendmember_num</span><span class="p">)</span>
            <span class="n">iatom_num</span> <span class="o">=</span> <span class="n">iphs_props</span><span class="p">[</span><span class="s1">&#39;atom_num&#39;</span><span class="p">]</span>

            <span class="c1">#iphase_name_tile = np.tile(np.array([iphs_props[&#39;phase_name&#39;]]), iendmember_num)</span>
            <span class="n">all_phase_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">all_phase_ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">ind_phs</span><span class="p">,(</span><span class="n">iendmember_num</span><span class="p">))))</span>
            <span class="n">all_mol_oxide_comp</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">all_mol_oxide_comp</span><span class="p">,</span> <span class="n">iall_mol_oxide_comp</span><span class="p">))</span>
            <span class="n">all_phase_name</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">iphase_name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iendmember_num</span><span class="p">)])</span>
            <span class="n">all_phase_symbol</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">iabbrev</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iendmember_num</span><span class="p">)])</span>
            <span class="n">all_endmember_name</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">iendmember_name</span><span class="p">)</span>
            <span class="n">all_endmember_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">all_endmember_id</span><span class="p">,</span> <span class="n">iendmember_id</span><span class="p">))</span>
            <span class="n">all_atom_num</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">iatom_num</span><span class="p">)</span>


        <span class="n">endmember_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_endmember_name</span><span class="p">)</span>
        <span class="n">all_atom_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_atom_num</span><span class="p">)</span>
        <span class="c1"># oxide_atom_num = self.oxide_props[&#39;cat_num&#39;]+self.oxide_props[&#39;oxy_num&#39;]</span>
        <span class="c1"># oxide_comp_per_atom = all_mol_oxide_comp/np.tile(oxide_atom_num[np.newaxis,:],(endmember_num,1))</span>
        <span class="c1"># oxide_comp_per_atom /= np.tile(np.sum(oxide_comp_per_atom, axis=1)[:,np.newaxis],(1,oxide_atom_num.size))</span>
        <span class="c1"># np.sum(oxide_comp_per_atom, axis=1)</span>
        <span class="c1"># Nendmember, Noxide = oxide_comp_per_atom.shape</span>
        <span class="c1"># u, s, vh =np.linalg.svd(oxide_comp_per_atom.T)</span>

        <span class="c1"># convert all_mol_oxide comp to moles of atoms for each oxide; divide by oxide num and norm</span>
        <span class="c1"># to 1;</span>
        <span class="n">Nendmember</span><span class="p">,</span> <span class="n">Noxide</span> <span class="o">=</span> <span class="n">all_mol_oxide_comp</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">all_mol_oxide_comp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>


        <span class="n">TOL</span> <span class="o">=</span> <span class="n">TOLsvd</span>
        <span class="n">N_nonrxn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;=</span> <span class="n">TOL</span><span class="p">)</span>
        <span class="n">N_rxn</span> <span class="o">=</span> <span class="n">Nendmember</span><span class="o">-</span><span class="n">Noxide</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&lt;</span> <span class="n">TOL</span><span class="p">)</span>
        <span class="n">non_rxn</span> <span class="o">=</span> <span class="n">vh</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N_nonrxn</span><span class="p">]</span>
        <span class="n">rxn_svd0</span> <span class="o">=</span> <span class="n">vh</span><span class="p">[</span><span class="n">N_nonrxn</span><span class="p">:]</span>

        <span class="n">scl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">irxn</span><span class="p">)</span> <span class="k">for</span> <span class="n">irxn</span> <span class="ow">in</span> <span class="n">rxn_svd0</span><span class="p">])</span>
        <span class="n">rxn_svd0</span> <span class="o">=</span> <span class="n">rxn_svd0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">scl</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],(</span><span class="mi">1</span><span class="p">,</span><span class="n">endmember_num</span><span class="p">))</span>

        <span class="c1"># Describe code below; add to documentation</span>
        <span class="n">reac_atom_num</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rxn_svd0</span><span class="p">)</span><span class="o">*</span><span class="n">all_atom_num</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rxn_svd</span> <span class="o">=</span> <span class="n">rxn_svd0</span><span class="o">*</span><span class="n">all_atom_num</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span><span class="o">/</span><span class="p">(</span>
            <span class="n">reac_atom_num</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

        <span class="n">rxn_svd_props</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;rxn_svd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn_svd</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;oxide_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oxide_num</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_mol_oxide_comp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_mol_oxide_comp</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_phase_name&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">all_phase_name</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_phase_symbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_phase_symbol</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_endmember_name&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">all_endmember_name</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_endmember_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_endmember_id</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_phase_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_phase_ind</span>
        <span class="n">rxn_svd_props</span><span class="p">[</span><span class="s1">&#39;all_atom_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_atom_num</span>
        <span class="c1">#self._rxn_svd_props = rxn_svd_props #TK: What is the purpose of this?</span>

        <span class="k">return</span> <span class="n">rxn_svd_props</span>

    <span class="c1">#rxn_svd, rxn_svd_props = get_reaction_svd(phase_symbols, TOLsvd=1e-4)</span>

    <span class="k">def</span> <span class="nf">get_wtcoefs_ortho</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wtcoefs</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">apply_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">wts_ortho</span> <span class="o">=</span> <span class="n">wtcoefs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iwtcoefs_ortho</span> <span class="ow">in</span> <span class="n">wtcoefs_ortho</span><span class="p">:</span>
            <span class="n">wts_ortho</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">iwtcoefs_ortho</span><span class="p">,</span> <span class="n">wts_ortho</span><span class="p">)</span><span class="o">*</span><span class="n">iwtcoefs_ortho</span>

        <span class="k">if</span> <span class="n">apply_norm</span><span class="p">:</span>
            <span class="n">wts_ortho</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wts_ortho</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wts_ortho</span>

    <span class="k">def</span> <span class="nf">random_rxn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="mi">36</span><span class="p">):</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">Nbasis</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">wts</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wts</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wtcoefs_ortho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wtcoefs_ortho</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wts</span>

    <span class="k">def</span> <span class="nf">_ortho_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wts</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wtcoefs_ortho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wts_ortho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wtcoefs_ortho</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">apply_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wts_ortho</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wts</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cost</span>

    <span class="k">def</span> <span class="nf">rxn_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>

        <span class="n">irxn_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rxn_svd</span><span class="p">)</span>
        <span class="n">xlogx</span> <span class="o">=</span> <span class="n">irxn_abs</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">irxn_abs</span><span class="p">)</span>
        <span class="n">xlogx</span><span class="p">[</span><span class="n">irxn_abs</span><span class="o">&lt;</span><span class="n">TOL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xlogx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">complexity</span>

    <span class="k">def</span> <span class="nf">lasso_rxn_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">,</span> <span class="n">scl</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">irxn_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rxn_svd</span><span class="p">)</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">irxn_abs</span><span class="o">/</span><span class="n">scl</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">scl</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">complexity</span>

    <span class="k">def</span> <span class="nf">linear_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wts</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">return_scl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wts</span><span class="p">)</span>
        <span class="n">endmember_num</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">wts</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],(</span><span class="mi">1</span><span class="p">,</span><span class="n">endmember_num</span><span class="p">))</span>
        <span class="n">rxn_wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scl</span><span class="o">*</span><span class="n">rxn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">scl_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rxn_wt</span><span class="p">)</span>
        <span class="n">rxn_wt</span> <span class="o">/=</span> <span class="n">scl_tot</span>

        <span class="k">if</span> <span class="n">return_scl</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rxn_wt</span><span class="p">,</span> <span class="n">wts</span><span class="o">/</span><span class="n">scl_tot</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rxn_wt</span>
    <span class="k">def</span> <span class="nf">rxn_costfun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wts</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
        <span class="n">rxn_wt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_combo</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">rxn</span><span class="p">)</span>
        <span class="c1"># complexity = self.rxn_complexity(rxn_wt, TOL=TOL)</span>
        <span class="n">complexity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lasso_rxn_complexity</span><span class="p">(</span>
            <span class="n">rxn_wt</span><span class="p">,</span> <span class="n">scl</span><span class="o">=</span><span class="n">lasso_scale</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">complexity</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ortho_penalty</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wtcoefs_ortho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">wts_ortho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wtcoefs_ortho</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">apply_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;norm(wts) = </span><span class="si">{wts_norm}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wts_norm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wts</span><span class="p">)))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;norm(ortho) = </span><span class="si">{ortho_norm}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ortho_norm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">wts_ortho</span><span class="p">)))</span>
                <span class="n">ortho_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ortho_penalty</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ortho_cost = &#39;</span><span class="p">,</span> <span class="n">ortho_cost</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cost</span>


    <span class="k">def</span> <span class="nf">_draw_basic_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
        <span class="n">Nbasis</span> <span class="o">=</span> <span class="n">rxn_svd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Nendmem</span> <span class="o">=</span> <span class="n">rxn_svd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">wtcoefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ndraw</span><span class="p">,</span> <span class="n">Nbasis</span><span class="p">))</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Ndraw</span><span class="p">)</span>
        <span class="n">rxn_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ndraw</span><span class="p">,</span> <span class="n">Nendmem</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ndraw</span><span class="p">):</span>
            <span class="n">iwts0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_rxn</span><span class="p">(</span><span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="n">Nbasis</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">costfun</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">rxn</span><span class="o">=</span><span class="n">rxn_svd</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span><span class="n">lasso_scale</span><span class="o">=</span><span class="n">lasso_scale</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_costfun</span><span class="p">(</span><span class="n">wts</span><span class="p">,</span> <span class="n">rxn</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="n">lasso_scale</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="n">TOL</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ind_fit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>

                <span class="n">ifit</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">costfun</span><span class="p">,</span> <span class="n">iwts0</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
                <span class="n">iwts0</span> <span class="o">=</span> <span class="n">ifit</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>


            <span class="n">iwt_fit</span> <span class="o">=</span> <span class="n">ifit</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rxn_costfun</span><span class="p">(</span><span class="n">iwt_fit</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="n">lasso_scale</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="n">TOL</span><span class="p">)</span>

            <span class="n">irxn_coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_combo</span><span class="p">(</span><span class="n">iwt_fit</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">)</span>
            <span class="n">wtcoefs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwt_fit</span>
            <span class="n">rxn_coefs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">irxn_coefs</span>
            <span class="n">cost</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifit</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">wtcoefs</span><span class="p">,</span> <span class="n">rxn_coefs</span><span class="p">,</span> <span class="n">cost</span>

    <span class="k">def</span> <span class="nf">next_basic_rxn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
        <span class="n">wtcoefs</span><span class="p">,</span> <span class="n">rxn_coefs</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_basic_rxns</span><span class="p">(</span><span class="n">rxn_svd</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="n">Ndraw</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">,</span>
                                                         <span class="n">lasso_scale</span><span class="o">=</span><span class="n">lasso_scale</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="n">Nbasis</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="n">TOL</span><span class="p">)</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wtcoefs</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">rxn_coefs</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">cost</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">get_rxns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_svd</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        filter rxn_svd based on cost analysis and get basic reactions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        rxn_svd : double array</span>
<span class="sd">            set of linearly independent reactions</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Nbasis</span> <span class="o">=</span> <span class="n">rxn_svd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Nendmem</span> <span class="o">=</span> <span class="n">rxn_svd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="n">wtcoefs_ortho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nbasis</span><span class="p">,</span> <span class="n">Nbasis</span><span class="p">))</span>
        <span class="n">wtcoefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nbasis</span><span class="p">,</span> <span class="n">Nbasis</span><span class="p">))</span>
        <span class="n">rxn_coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nbasis</span><span class="p">,</span> <span class="n">Nendmem</span><span class="p">))</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nbasis</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nbasis</span><span class="p">):</span>
            <span class="n">iwtcoefs</span><span class="p">,</span> <span class="n">irxn_coefs</span><span class="p">,</span> <span class="n">icost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_basic_rxn</span><span class="p">(</span><span class="n">rxn_svd</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="o">=</span><span class="n">wtcoefs_ortho</span><span class="p">,</span> <span class="n">Ndraw</span><span class="o">=</span><span class="n">Ndraw</span><span class="p">,</span> <span class="n">ortho_scale</span><span class="o">=</span><span class="n">ortho_scale</span><span class="p">,</span> <span class="n">lasso_scale</span><span class="o">=</span><span class="n">lasso_scale</span><span class="p">,</span> <span class="n">Nbasis</span><span class="o">=</span><span class="n">Nbasis</span><span class="p">,</span> <span class="n">TOL</span><span class="o">=</span><span class="n">TOL</span><span class="p">)</span>

            <span class="n">iwtcoefs_ortho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wtcoefs_ortho</span><span class="p">(</span><span class="n">iwtcoefs</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span><span class="p">)</span>

            <span class="n">wtcoefs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwtcoefs</span>
            <span class="n">wtcoefs_ortho</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwtcoefs_ortho</span>
            <span class="n">rxn_coefs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">irxn_coefs</span>
            <span class="n">costs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">icost</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;icost(</span><span class="si">{ind}</span><span class="s1">) = </span><span class="si">{icost}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span><span class="n">icost</span><span class="o">=</span><span class="n">icost</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=====&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wtcoefs</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span> <span class="n">rxn_coefs</span><span class="p">,</span> <span class="n">wtcoefs_ortho</span>




<span class="n">chem</span> <span class="o">=</span> <span class="n">_Chem</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2020, ENKI.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.4.0.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>