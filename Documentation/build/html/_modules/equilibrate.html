<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>equilibrate &mdash; Thermoengine 1.0.1 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../None"></script>
    <script type="text/javascript" src="../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" >
    <link rel="search" title="Search" href="../search.html" >
    <link rel="top" title="Thermoengine 1.0.1 documentation" href="../index.html" >
    <link rel="up" title="Module code" href="index.html" > 
  </head>
  <body>

<div class="container">
  <div class="top-scipy-org-logo-header">
    <a href="../index.html">
      <img style="border: 0;" alt="ENKI" src="../_static/img/ENKI_header.png"></a>
    </div>
  </div>
</div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="http://enki-portal.org">ENKI Web</a></li>
        <li class="active"><a href="https://enki.ofm-research.org">ENKI Server</a></li>
	
        <li class="active"><a href="../index.html">Thermoengine 1.0.1 documentation</a></li>
	
          <li class="active"><a href="index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/Enki.png" alt="Logo">
            </a></p>
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for equilibrate</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">The equilibrate module implements a Python interface to the Equilibrate and</span>
<span class="sd">EquilState classes. It also implements a Python class called MELTSmodel that</span>
<span class="sd">wraps the objective-C classes: EquilibrateUsingMELTSv102,</span>
<span class="sd">EquilibrateUsingMELTSv110, EquilibrateUsingMELTSv120,</span>
<span class="sd">EquilibrateUsingpMELTSv561, EquilibrateUsingMELTSwithDEW,</span>
<span class="sd">and EquilibrateUsingStixrude.</span>

<span class="sd">The Equilibrate class provides methods to calculate an equilibrium phase</span>
<span class="sd">assemblage given a list of Phase class instances.</span>

<span class="sd">You can calculate equilibrium in closed thermodynamic systems under a</span>
<span class="sd">variety of constraints:</span>

<span class="sd">- Temperature and pressure (Gibbs free energy minimization)</span>

<span class="sd">- Entropy and pressure (enthalpy minimization)</span>

<span class="sd">- Temperature and volume (Helmholtz free energy minimization)</span>

<span class="sd">- Entropy and volume (internal energy minimization)</span>

<span class="sd">You can also calculate equilibrium under constraints of fixed temperature and</span>
<span class="sd">pressure in open thermodynamic systems by specifying one or more fixed elemental</span>
<span class="sd">chemical potentials.</span>

<span class="sd">For details of the underlying theory and algorithms implemented in the Equilibrate</span>
<span class="sd">class, see the notebooks in the PublicNotebooks/Equilibrate folder on</span>
<span class="sd">the `ENKI server &lt;https://enki.ofm-research.org/hub/login&gt;`_.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sym</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
	<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
	<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">chem</span>
<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">phases</span>

<span class="c1"># Objective-C imports</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">cdll</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">rubicon.objc</span> <span class="kn">import</span> <span class="n">ObjCClass</span><span class="p">,</span> <span class="n">ObjCProtocol</span><span class="p">,</span> <span class="n">NSObject</span><span class="p">,</span> <span class="n">objc_method</span>
<span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">find_library</span><span class="p">(</span><span class="s1">&#39;phaseobjc&#39;</span><span class="p">))</span>

<span class="c1"># Excel imports</span>
<span class="kn">from</span> <span class="nn">openpyxl</span> <span class="kn">import</span> <span class="n">Workbook</span>
<span class="kn">from</span> <span class="nn">openpyxl.utils</span> <span class="kn">import</span> <span class="n">get_column_letter</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Equilibrate&#39;</span><span class="p">,</span> <span class="s1">&#39;EquilState&#39;</span><span class="p">,</span> <span class="s1">&#39;MELTSmodel&#39;</span><span class="p">]</span>

<span class="c1"># array length for elements</span>
<span class="n">NE</span> <span class="o">=</span> <span class="mi">106</span>

<div class="viewcode-block" id="EquilState"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState">[docs]</a><span class="k">class</span> <span class="nc">EquilState</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;Class for holding the phase state for an equilibrium model determined by Equilibrate</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	elements_l : []</span>
<span class="sd">		A list of strings identifying the chemical elements present in the</span>
<span class="sd">		system</span>
<span class="sd">	phases_l : []</span>
<span class="sd">		A list of class instances for phases that are in the system.  These</span>
<span class="sd">		instances must derive from the *PurePhase* or *SolutionPhase* classes,</span>
<span class="sd">		which are defined in the *phases* module.</span>

<span class="sd">	Attributes</span>
<span class="sd">	----------</span>
<span class="sd">	c_matrix</span>
<span class="sd">	c_omni</span>
<span class="sd">	c_omni_qr</span>
<span class="sd">	c_qr_decomp</span>
<span class="sd">	element_l</span>
<span class="sd">	phase_d</span>
<span class="sd">	pressure</span>
<span class="sd">	temperature</span>

<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements_l</span><span class="p">,</span> <span class="n">phases_l</span><span class="p">):</span>
		<span class="n">elements_present</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NE</span><span class="p">)]</span>
		<span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elements_l</span><span class="p">:</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">PERIODIC_ORDER</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">elm</span><span class="p">)</span>
			<span class="n">elements_present</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_element_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elements_present</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span><span class="p">]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_phase_d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases_l</span><span class="p">:</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span>
			<span class="n">nc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;endmember_num&#39;</span><span class="p">])</span> \
				<span class="k">if</span> <span class="s1">&#39;endmember_num&#39;</span> <span class="ow">in</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span> <span class="k">else</span> <span class="mi">1</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;phase_name&#39;</span><span class="p">]</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;abbrev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;abbrev&#39;</span><span class="p">]</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;endmember_name&#39;</span><span class="p">]</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_formula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_molwts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">]</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_nz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;grams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;affinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="c1"># create a list of length nc where each entry is a numpy array</span>
			<span class="c1"># that contains stoichiometric coefficients converting each</span>
			<span class="c1"># endmember to system elements (in the order _element_l)</span>
			<span class="n">conv_to_elm</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">conv_to_elm_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_l</span><span class="p">))</span>
			<span class="n">conv_to_oxd</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
				<span class="n">mol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
				<span class="n">mol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">mol_elm</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;element_comp&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">mol_elm</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">covert_endmember_comp</span><span class="p">(</span>
						<span class="n">mol</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;moles_elements&#39;</span><span class="p">)</span>
				<span class="n">conv_entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_l</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">NE</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">mol_elm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
						<span class="n">conv_entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mol_elm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">conv_to_elm_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">conv_to_elm_sum</span><span class="p">,</span> <span class="n">conv_entry</span><span class="p">)</span>
				<span class="n">conv_to_elm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv_entry</span><span class="p">)</span>
				<span class="n">conv_to_oxd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">calc_mol_oxide_comp</span><span class="p">(</span><span class="n">mol_elm</span><span class="p">))</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;conv_to_elm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_to_elm</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;conv_to_oxd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conv_to_oxd</span>
			<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;omnicomponent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span>
				<span class="n">conv_to_elm_sum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv_to_elm_sum</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>

			<span class="n">name</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;phase_name&#39;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_phase_d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

		<span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;conv_to_elm&#39;</span><span class="p">]:</span>
				<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
					<span class="n">c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
					<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">c_matrix</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
						<span class="n">row</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">))))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_c_matrix</span> <span class="o">=</span> <span class="n">c_matrix</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_c_qr_decomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_matrix</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_c_omni</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_c_omni_qr</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span> <span class="o">=</span> <span class="mf">1000.0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_pressure</span> <span class="o">=</span> <span class="mf">1000.0</span>

	<span class="c1">############################</span>
	<span class="c1"># Properties of the system #</span>
	<span class="c1">############################</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">phase_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A dictionary of dictionaries that holds properties of system phases</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Dictionary of phases in the system (dict)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_d</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">element_l</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		List of atomic numbers of elements in the system</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		A Python list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_l</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">c_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Numpy matrix that maps elements to moles of endmembers</span>

<span class="sd">		Moles of endmembers are indexed by row, and moles of elements</span>
<span class="sd">		are indexed by column.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Numpy 2-D array</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_matrix</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">c_qr_decomp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tuple of Numpy matrices of the Q,R decomposition of the c_matrix</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		tuple</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_qr_decomp</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">c_omni</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Numpy conversion matrix for the omnicomponent phase (if one exists)</span>

<span class="sd">		Moles of endmembers are indexed by row, and moles of elements</span>
<span class="sd">		are indexed by column.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		np 2-D array</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_omni</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">c_omni_qr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tuple of Numpy matrices of the Q,R decomposition of c_omni</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		tuple</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_c_omni_qr</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Temperature of the assemblage, in Kelvins</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span>

	<span class="nd">@temperature</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_temperature</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Pressure of the assemblage, in bars</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pressure</span>

	<span class="nd">@pressure</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_pressure</span> <span class="o">=</span> <span class="n">value</span>

	<span class="c1">################################</span>
	<span class="c1"># Methods for phases in system #</span>
	<span class="c1">################################</span>

<div class="viewcode-block" id="EquilState.omni_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.omni_phase">[docs]</a>	<span class="k">def</span> <span class="nf">omni_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns first omnicomponent phase in the phase dictionary</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;omnicomponent&#39;</span><span class="p">]:</span>
				<span class="k">return</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
		<span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="EquilState.c_matrix_for_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.c_matrix_for_phase">[docs]</a>	<span class="k">def</span> <span class="nf">c_matrix_for_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns a slice of c_matrix relevant to the specified phase_name</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str</span>
<span class="sd">			Name of a system phase</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">row_min</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">phase_name</span><span class="p">:</span>
				<span class="n">row_max</span> <span class="o">=</span> <span class="n">row_min</span> <span class="o">+</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">break</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">row_min</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_matrix</span><span class="p">[</span><span class="n">row_min</span><span class="p">:</span><span class="n">row_max</span><span class="p">,:]</span></div>

<div class="viewcode-block" id="EquilState.set_phase_comp"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.set_phase_comp">[docs]</a>	<span class="k">def</span> <span class="nf">set_phase_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="nb">cmp</span><span class="p">,</span> <span class="n">input_as_elements</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sets the endmember moles and total moles a phase in the system</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str</span>
<span class="sd">			Name of a system phase</span>
<span class="sd">		cmp : ndarray</span>
<span class="sd">			1-D Numpy array with compositional data</span>
<span class="sd">		input_as_elements : bool, def False</span>
<span class="sd">			If True, convert input array from moles of elements to moles of</span>
<span class="sd">			endmember components.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		valid : bool</span>
<span class="sd">			True if input composition is valid for phase</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">False</span>
		<span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="nb">cmp</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> \
			<span class="s1">&#39;bulk_comp must be set to an numpy array&#39;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">input_as_elements</span><span class="p">:</span>
			<span class="k">assert</span> <span class="nb">cmp</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span> \
				<span class="s1">&#39;cmp array must have length &#39;</span> \
				<span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;nc&#39;</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">assert</span> <span class="nb">cmp</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_l</span><span class="p">),</span> \
				<span class="s1">&#39;cmp array must have length &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_l</span><span class="p">))</span>
			<span class="n">cT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
			<span class="n">cTinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cT</span><span class="p">)</span> <span class="k">if</span> <span class="n">cT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span>  <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cT</span><span class="p">)</span>
			<span class="nb">cmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cTinv</span><span class="p">,</span> <span class="nb">cmp</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">cmp</span>
		<span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;mole_nz&#39;</span><span class="p">],</span>
			<span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="nb">cmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span><span class="nb">cmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="EquilState.tot_moles_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.tot_moles_phase">[docs]</a>	<span class="k">def</span> <span class="nf">tot_moles_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns total moles of phase</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str</span>
<span class="sd">			Name of a system phase</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mf">0.0</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="EquilState.tot_grams_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.tot_grams_phase">[docs]</a>	<span class="k">def</span> <span class="nf">tot_grams_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns total grams of phase</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str</span>
<span class="sd">			Name of a system phase</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mf">0.0</span>
		<span class="n">grams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;end_molwts&#39;</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grams</span><span class="p">)</span></div>

<div class="viewcode-block" id="EquilState.moles_elements"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.moles_elements">[docs]</a>	<span class="k">def</span> <span class="nf">moles_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns array of moles of elements in phase</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str</span>
<span class="sd">			Name of a system phase</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : np_array</span>
<span class="sd">			Numpy array of mole numbers of the reduced set of elements in the</span>
<span class="sd">			phase</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">elm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_l</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">moles</span><span class="p">,</span><span class="n">coeff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;conv_to_elm&#39;</span><span class="p">]):</span>
			<span class="k">if</span> <span class="n">moles</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">elm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span><span class="n">moles</span><span class="o">*</span><span class="n">coeff</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">elm</span></div>

<div class="viewcode-block" id="EquilState.tot_moles_elements"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.tot_moles_elements">[docs]</a>	<span class="k">def</span> <span class="nf">tot_moles_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns array of moles of elements in system</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : np_array</span>
<span class="sd">			Numpy array of mole numbers of the reduced set of elements in the</span>
<span class="sd">			system</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">elm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_l</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">elm</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moles_elements</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">elm</span></div>

<div class="viewcode-block" id="EquilState.oxide_comp"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.oxide_comp">[docs]</a>	<span class="k">def</span> <span class="nf">oxide_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;wt%&#39;</span><span class="p">,</span> <span class="n">prune_list</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns a dictionary of concentrations of oxides in phase</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str</span>
<span class="sd">			Name of a system phase</span>
<span class="sd">		output : str, default &quot;wt%&quot;</span>
<span class="sd">			Units of output: &#39;wt%&#39; (default), &#39;moles&#39;, &#39;grams&#39;</span>
<span class="sd">		prune_list : bool, default True</span>
<span class="sd">			Remove zeroed valued entries</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : collections.OrderedDict</span>
<span class="sd">			Dictionary of oxide concentration values, keyed by oxide</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">oxd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxide_num&#39;</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">moles</span><span class="p">,</span><span class="n">coeff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;conv_to_oxd&#39;</span><span class="p">]):</span>
			<span class="k">if</span> <span class="n">moles</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">oxd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">oxd</span><span class="p">,</span><span class="n">moles</span><span class="o">*</span><span class="n">coeff</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;oxides&#39;</span><span class="p">],</span><span class="n">oxd</span><span class="p">):</span>
			<span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;wt%&#39;</span> <span class="ow">or</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;grams&#39;</span><span class="p">:</span>
			<span class="n">mod_result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
			<span class="n">sum_oxd</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">for</span> <span class="n">index</span><span class="p">,(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
				<span class="n">mod_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">*</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
				<span class="n">sum_oxd</span> <span class="o">+=</span> <span class="n">mod_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">mod_result</span>
			<span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;wt%&#39;</span> <span class="ow">and</span> <span class="n">sum_oxd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">mod_result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">mod_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">value</span><span class="o">/</span><span class="n">sum_oxd</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">mod_result</span>
		<span class="k">if</span> <span class="n">prune_list</span><span class="p">:</span>
			<span class="n">mod_result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">mod_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">mod_result</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.properties"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.properties">[docs]</a>	<span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns properties of phases in the system</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str, default None</span>
<span class="sd">			Name of phase in system. If None, returns a dictionary of system</span>
<span class="sd">			phases, with names as keys and &#39;stable&#39; or &#39;unstable&#39; as values.</span>
<span class="sd">		props : str, default None</span>
<span class="sd">			Name of property to be retrieved. If None, a list of valid properties</span>
<span class="sd">			is returned.</span>
<span class="sd">		units : bool, default False</span>
<span class="sd">			Property units are provided as the second entry of a returned tuple.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">prop_d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span> <span class="p">(</span><span class="s1">&#39;Mass&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;GibbsFreeEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">),</span>
			<span class="p">(</span><span class="s1">&#39;Enthalpy&#39;</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Entropy&#39;</span><span class="p">,</span><span class="s1">&#39;J/K&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HeatCapacity&#39;</span><span class="p">,</span><span class="s1">&#39;J/K&#39;</span><span class="p">),</span>
			<span class="p">(</span><span class="s1">&#39;DcpDt&#39;</span><span class="p">,</span><span class="s1">&#39;J/K^2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span><span class="s1">&#39;J/bar&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;DvDt&#39;</span><span class="p">,</span><span class="s1">&#39;J/bar-K&#39;</span><span class="p">),</span>
			<span class="p">(</span><span class="s1">&#39;DvDp&#39;</span><span class="p">,</span><span class="s1">&#39;J/bar^2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;D2vDt2&#39;</span><span class="p">,</span><span class="s1">&#39;J/bar-K^2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;D2vDtDp&#39;</span><span class="p">,</span><span class="s1">&#39;J/bar^2-K&#39;</span><span class="p">),</span>
			<span class="p">(</span><span class="s1">&#39;D2vDp2&#39;</span><span class="p">,</span><span class="s1">&#39;J/bar^3&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span><span class="s1">&#39;g/cm^3&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Alpha&#39;</span><span class="p">,</span><span class="s1">&#39;1/K&#39;</span><span class="p">),</span>
			<span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span><span class="s1">&#39;1/bar&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;GPa&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;K&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;none&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Gamma&#39;</span><span class="p">,</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="p">])</span>

		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">phase_d</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">phase_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stable&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span>
					<span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;unstable&#39;</span>
			<span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;System&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stable&#39;</span>
			<span class="k">return</span> <span class="n">phase_d</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span> <span class="ow">and</span> <span class="n">phase_name</span> <span class="o">!=</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">prop_d</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">prop_d</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">prop_d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="k">if</span> <span class="n">props</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prop_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">props</span> <span class="o">+</span> <span class="s1">&#39; is not a valid property.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>

		<span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span>
		<span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="o">!=</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result</span>
			<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
			<span class="n">sys</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">sys</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Mass&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">for</span> <span class="n">phs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">grams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phs</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phs</span><span class="p">][</span><span class="s1">&#39;end_molwts&#39;</span><span class="p">])</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grams</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">grams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;end_molwts&#39;</span><span class="p">])</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grams</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;GibbsFreeEnergy&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;GibbsFreeEnergy&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Enthalpy&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dGdT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
						<span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
						<span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Enthalpy&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Entropy&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dGdT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Entropy&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;HeatCapacity&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;HeatCapacity&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;DcpDt&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d3GdT3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;DcpDt&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dGdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;DvDt&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2GdTdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;DvDt&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;DvDp&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;DvDp&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;D2vDt2&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3GdT2dP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;D2vDt2&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;D2vDtDp&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3GdTdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;D2vDtDp&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;D2vDp2&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">sys</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d3GdP3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;D2vDp2&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Density&#39;</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Mass&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">m</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="mf">10.0</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Density&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">dvdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;DvDt&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">*</span><span class="n">dvdt</span><span class="o">/</span><span class="n">v</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Alpha&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Beta&#39;</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">dvdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;DvDp&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span><span class="o">*</span><span class="n">dvdp</span><span class="o">/</span><span class="n">v</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>
			<span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">beta</span><span class="o">/</span><span class="mf">10000.0</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s2">&quot;K&#39;&quot;</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">dvdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;DvDp&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">d2vdp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;D2vDp2&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="n">d2vdp2</span><span class="o">/</span><span class="n">dvdp</span><span class="o">/</span><span class="n">dvdp</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s2">&quot;K&#39;&quot;</span><span class="p">])</span>
		<span class="k">elif</span> <span class="n">props</span> <span class="o">==</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span>
			<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">dvdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;DvDp&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">dvdt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;DvDt&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;HeatCapacity&#39;</span><span class="p">,</span>
				<span class="n">units</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="n">dvdt</span><span class="o">/</span><span class="n">dvdp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">dvdt</span><span class="o">*</span><span class="n">dvdt</span><span class="o">/</span><span class="n">dvdp</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">units</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">prop_d</span><span class="p">[</span><span class="s1">&#39;Gamma&#39;</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.compositions"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.compositions">[docs]</a>	<span class="k">def</span> <span class="nf">compositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;components&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;moles&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns compositions of phases in the system</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str, default None</span>
<span class="sd">			Name of phase in system</span>
<span class="sd">		ctype : str, default &#39;components&#39;</span>
<span class="sd">			Compositional descriptor. Permitted: &#39;components&#39;, &#39;oxides&#39;,</span>
<span class="sd">			&#39;elements&#39;</span>
<span class="sd">		units : str, default &#39;moles&#39;</span>
<span class="sd">			Units of composition. Permitted: &#39;moles&#39;, &#39;mole_frac&#39;, &#39;wt%&#39;</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : numpy array</span>
<span class="sd">			One dimensional vector</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		If units is set to &#39;oxides&#39; or &#39;elements&#39;, results are returned in an</span>
<span class="sd">		array of standard length and order.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Error: Method requires a phase_name.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">ctype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;components&#39;</span><span class="p">,</span> <span class="s1">&#39;oxides&#39;</span><span class="p">,</span> <span class="s1">&#39;elements&#39;</span><span class="p">]:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">ctype</span> <span class="o">+</span> <span class="s1">&#39; is not permitted. See doc string.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">,</span> <span class="s1">&#39;mole_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;wt%&#39;</span><span class="p">]:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">units</span> <span class="o">+</span> <span class="s1">&#39; is not permitted. See doc string.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s1">&#39;components&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;moles&#39;</span> <span class="ow">or</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mole_frac&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mole_frac&#39;</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;wt%&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_molwts&#39;</span><span class="p">]</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">result</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s1">&#39;oxides&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;moles&#39;</span> <span class="ow">or</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mole_frac&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_comp</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;moles&#39;</span><span class="p">,</span>
					<span class="n">prune_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
				<span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mole_frac&#39;</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;wt%&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_comp</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;wt%&#39;</span><span class="p">,</span>
					<span class="n">prune_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
		<span class="k">elif</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s1">&#39;elements&#39;</span><span class="p">:</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;element_comp&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NE</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
					<span class="n">mol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">])</span>
					<span class="n">mol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
					<span class="n">mol_elm</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">covert_endmember_comp</span><span class="p">(</span>
						<span class="n">mol</span><span class="p">,</span><span class="n">output</span><span class="o">=</span><span class="s1">&#39;moles_elements&#39;</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">NE</span><span class="p">):</span>
						<span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">mol_elm</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;mole_frac&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;wt%&#39;</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">NE</span><span class="p">):</span>
					<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span><span class="n">chem</span><span class="o">.</span><span class="n">PERIODIC_WEIGHTS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">result</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">result</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.affinities"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.affinities">[docs]</a>	<span class="k">def</span> <span class="nf">affinities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns affinity of phases in the system</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name : str, default None</span>
<span class="sd">			Name of phase in system. If None, returns a dictionary of system</span>
<span class="sd">			phases, with names as keys and &#39;stable&#39; or &#39;unstable&#39; as values.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Error: Please specify a phase name.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: &#39;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39; is not in phase dictionary.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">tot_mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tot_mol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="mf">0.0</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;affinity&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="EquilState.print_state"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.print_state">[docs]</a>	<span class="k">def</span> <span class="nf">print_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="n">wt_as_oxides</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Prints results about the system state</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		level : str</span>
<span class="sd">			Level of detail to be printed</span>
<span class="sd">		wt_as_oxides : bool, default True</span>
<span class="sd">			Print wt% values on an oxide basis; otherwise print wt% of</span>
<span class="sd">			endmember components.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
		<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;T = </span><span class="si">{0:10.2f}</span><span class="s1"> °C, P = </span><span class="si">{1:10.1f}</span><span class="s1"> MPa&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="o">-</span><span class="mf">273.15</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="o">/</span><span class="mf">10.0</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">tot_mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">tot_mol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">tot_grm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_grams_phase</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&lt;15s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;moles: </span><span class="si">{0:10.6f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tot_mol</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;grams: </span><span class="si">{0:7.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tot_grm</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">wt_as_oxides</span><span class="p">:</span>
					<span class="n">oxd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_comp</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
					<span class="n">oxd_s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">oxd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
					<span class="n">oxd_v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">oxd</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
					<span class="n">n_oxd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxd</span><span class="p">)</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
						<span class="n">gram</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_molwts&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;15s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
							<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_name&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:</span><span class="mi">15</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;form:  </span><span class="si">{0:&lt;10s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
							<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_formula&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:</span><span class="mi">10</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;     &#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;X: </span><span class="si">{0:7.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
							<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">tot_mol</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">wt_as_oxides</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_oxd</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;wt% </span><span class="si">{0:&gt;7s}</span><span class="s1"> </span><span class="si">{1:7.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
									<span class="n">oxd_s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">oxd_v</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;wt% </span><span class="si">{0:7.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">100.0</span><span class="o">*</span><span class="n">gram</span><span class="o">/</span><span class="n">tot_grm</span><span class="p">))</span>
					<span class="k">if</span> <span class="n">wt_as_oxides</span> <span class="ow">and</span> <span class="n">nc</span> <span class="o">&lt;</span> <span class="n">n_oxd</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span><span class="n">n_oxd</span><span class="p">):</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:49s}</span><span class="s1"> wt% </span><span class="si">{1:&gt;7s}</span><span class="s1"> </span><span class="si">{2:7.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
									<span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">oxd_s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">oxd_v</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&lt;15s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;affn: </span><span class="si">{0:10.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;affinity&#39;</span><span class="p">]))</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:&gt;15s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_name&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:</span><span class="mi">15</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;form:  </span><span class="si">{0:&lt;10s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
							<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;end_formula&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:</span><span class="mi">10</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;     &#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;X: </span><span class="si">{0:7.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_frac&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span></div>

	<span class="c1">###################################################</span>
	<span class="c1"># System potentials and compositional derivatives #</span>
	<span class="c1">###################################################</span>

<div class="viewcode-block" id="EquilState.moles_v"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.moles_v">[docs]</a>	<span class="k">def</span> <span class="nf">moles_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_v</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Computes of a reaction product</span>

<span class="sd">		moles (scalar) = (mole vector of all endmembers of all active phases</span>
<span class="sd">		in the system) x (input mole vector of reaction coefficients)</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		reaction_v : ndarray</span>
<span class="sd">			Array of reaction coefficients</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		moles : float</span>
<span class="sd">			Moles of reaction product</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">moles</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]:</span>
					<span class="n">moles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span>
		<span class="n">moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">reaction_v</span><span class="p">,</span> <span class="n">moles</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">moles</span></div>

<div class="viewcode-block" id="EquilState.G"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.G">[docs]</a>	<span class="k">def</span> <span class="nf">G</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns Gibbs free energy of the system; a scalar</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.dGdT"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.dGdT">[docs]</a>	<span class="k">def</span> <span class="nf">dGdT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the temperature derivative of the Gibbs free energy of the</span>
<span class="sd">		system; a scalar, and the negative of the system entropy</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="o">-</span><span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.dGdP"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.dGdP">[docs]</a>	<span class="k">def</span> <span class="nf">dGdP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the pressure derivative of the Gibbs free energy of the</span>
<span class="sd">		system; a scalar, and the system volume</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.dGdn"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.dGdn">[docs]</a>	<span class="k">def</span> <span class="nf">dGdn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
		<span class="n">use_omni_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the first molar derivative of G of the system; a 1-D numpy array</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		element_basis : bool, def True</span>
<span class="sd">			If True, returns a projected array of element chemical potentials</span>
<span class="sd">		full_output : bool, def False</span>
<span class="sd">			If True, returns a tuple with full output from numpy lstlq method</span>
<span class="sd">		use_omni_phase : bool, def False</span>
<span class="sd">			If True, returns a projected array of element chemical potentials</span>
<span class="sd">			using the omnicomponent phase as a basis.  The system must have</span>
<span class="sd">			an omnicomponent phase, and element_basis must be set to True for</span>
<span class="sd">			this keyword to have effect.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">use_omni_phase</span><span class="p">:</span>
			<span class="n">omni_phase_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">omni_phase_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">assert</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
					<span class="s1">&#39;ERROR in dGdn method: use omni_phase keyword specified&#39;</span> <span class="o">+</span>
					<span class="s1">&#39; when the system has no omnicomponent phase&#39;</span><span class="p">)</span>
			<span class="n">element_basis</span> <span class="o">=</span> <span class="kc">True</span>

		<span class="k">if</span> <span class="n">use_omni_phase</span> <span class="ow">and</span> <span class="n">element_basis</span><span class="p">:</span>
			<span class="c1"># computes chemical potentials for all component endmembers</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">omni_phase_name</span><span class="p">]</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
				<span class="n">row</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
					<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_nz&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
			<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># computes chemical potentials for all component endmembers in a</span>
			<span class="c1"># system phase if the total moles of that phase is &gt; 0</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
					<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
						<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)])</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
						<span class="n">row</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
							<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

		<span class="k">if</span> <span class="ow">not</span> <span class="n">element_basis</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">result</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">use_omni_phase</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_omni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_c_omni</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">omni_phase_name</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_c_omni_qr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_omni</span><span class="p">)</span>
				<span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_omni_qr</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
						<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
						<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;conv_to_elm&#39;</span><span class="p">]:</span>
							<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
								<span class="n">c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
								<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="n">c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">c_matrix</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
									<span class="n">row</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">))))</span>
				<span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">c_matrix</span><span class="p">)</span>
			<span class="n">Qb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
			<span class="n">result</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Qb</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">full_output</span> <span class="k">else</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span></div>

<div class="viewcode-block" id="EquilState.d2GdT2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d2GdT2">[docs]</a>	<span class="k">def</span> <span class="nf">d2GdT2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the second temperature derivative of the Gibbs free energy of</span>
<span class="sd">		the system; a scalar, and the negative of the temperature times the</span>
<span class="sd">		system heat capacity</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="o">-</span><span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span><span class="o">/</span><span class="n">t</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d2GdTdP"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d2GdTdP">[docs]</a>	<span class="k">def</span> <span class="nf">d2GdTdP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the cross temperature-pressure derivative of the Gibbs free</span>
<span class="sd">		energy of the system; a scalar, and the volume times the system&#39;s</span>
<span class="sd">		coefficient of isothermal expansion</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d2GdP2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d2GdP2">[docs]</a>	<span class="k">def</span> <span class="nf">d2GdP2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the second pressure derivative of the Gibbs free energy of</span>
<span class="sd">		the system; a scalar, and the negative of the volume times the</span>
<span class="sd">		system&#39;s coefficient of isothermal compressibility</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d2GdTdn"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d2GdTdn">[docs]</a>	<span class="k">def</span> <span class="nf">d2GdTdn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the second derivative of G of the system with respect to</span>
<span class="sd">		temperature and mole numbers; a 1-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">row</span> <span class="o">=</span> <span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d2GdPdn"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d2GdPdn">[docs]</a>	<span class="k">def</span> <span class="nf">d2GdPdn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the second derivative of G of the system with respect to</span>
<span class="sd">		pressure and mole numbers; a 1-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">result</span></div>

	<span class="k">def</span> <span class="nf">_sym_to_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sym_m</span><span class="p">):</span>
		<span class="n">den_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
		<span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
				<span class="n">entry</span> <span class="o">=</span> <span class="n">sym_m</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
				<span class="n">den_m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
				<span class="n">den_m</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
				<span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">return</span> <span class="n">den_m</span>


<div class="viewcode-block" id="EquilState.d2Gdn2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d2Gdn2">[docs]</a>	<span class="k">def</span> <span class="nf">d2Gdn2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the second molar derivative of G of system; a 2-D numpy array</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		element_basis : bool, def True</span>
<span class="sd">			If True, returns a projected Hessian on an element basis</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">mat</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
						<span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym_to_dense</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span> <span class="n">mat</span><span class="p">)</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">element_basis</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">result</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
					<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;conv_to_elm&#39;</span><span class="p">]:</span>
						<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
							<span class="n">c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
							<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">c_matrix</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
								<span class="n">row</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="n">row</span><span class="o">.</span><span class="n">size</span><span class="p">))))</span>
			<span class="n">Q</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">c_matrix</span><span class="p">)</span>
			<span class="c1">#Qb = np.matmul(Q.T, np.matmul(result, Q))</span>
			<span class="n">Qb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
			<span class="n">result</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Qb</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdT2dn"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdT2dn">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdT2dn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third derivative of G of the system twice with respect to</span>
<span class="sd">		temperature and once with respect to mole numbers; a 1-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">t</span><span class="p">])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">row</span> <span class="o">=</span> <span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">t</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdP2dn"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdP2dn">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdP2dn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third derivative of G of the system with respect to</span>
<span class="sd">		pressure twice and mole numbers once; a 1-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdTdPdn"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdTdPdn">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdTdPdn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third derivative of G of the system with respect to</span>
<span class="sd">		temperature, pressure and mole numbers; a 1-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">row</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">row</span><span class="p">,(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdTdn2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdTdn2">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdTdn2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the first temperature and second molar derivative of G of</span>
<span class="sd">		system; a 2-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">mat</span> <span class="o">=</span> <span class="o">-</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">entropy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
						<span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym_to_dense</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span> <span class="n">mat</span><span class="p">)</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdPdn2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdPdn2">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdPdn2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the first pressure and second molar derivative of G of system;</span>
<span class="sd">		a 2-D numpy array</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">mat</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
						<span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym_to_dense</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span> <span class="n">mat</span><span class="p">)</span>
				<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdT3"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdT3">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdT3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third temperature derivative of the Gibbs free energy of</span>
<span class="sd">		the system; a scalar</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">cp</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
					<span class="n">dcpdt</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cp</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="n">t</span> <span class="o">-</span> <span class="n">dcpdt</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">cp</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
					<span class="n">dcpdt</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">heat_capacity</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
						<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">cp</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="n">t</span> <span class="o">-</span> <span class="n">dcpdt</span><span class="o">/</span><span class="n">t</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdT2dP"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdT2dP">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdT2dP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third pressure derivative of the Gibbs free energy of</span>
<span class="sd">		the system; a scalar</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdTdP2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdTdP2">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdTdP2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third pressure derivative of the Gibbs free energy of</span>
<span class="sd">		the system; a scalar</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dT&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EquilState.d3GdP3"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3GdP3">[docs]</a>	<span class="k">def</span> <span class="nf">d3GdP3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third pressure derivative of the Gibbs free energy of</span>
<span class="sd">		the system; a scalar</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">})</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span>
						<span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span><span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dP&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">})</span>
		<span class="k">return</span> <span class="n">result</span></div>

	<span class="k">def</span> <span class="nf">_sym_ten_to_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">sym_t</span><span class="p">):</span>
		<span class="n">den_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
		<span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
					<span class="n">entry</span> <span class="o">=</span> <span class="n">sym_m</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
					<span class="n">den_t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
					<span class="n">den_t</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
					<span class="n">den_t</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
					<span class="n">den_t</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
					<span class="n">den_t</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
					<span class="n">den_t</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
					<span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">return</span> <span class="n">den_t</span>


<div class="viewcode-block" id="EquilState.d3Gdn3"><a class="viewcode-back" href="../equilibrate.html#equilibrate.EquilState.d3Gdn3">[docs]</a>	<span class="k">def</span> <span class="nf">d3Gdn3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the third molar derivative of G system for the cmp component</span>
<span class="sd">		of the phase named phase as a 2-D numpy array</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase : str, def None</span>
<span class="sd">		cmp : int, def None</span>
<span class="sd">			for the phase named phase d3Gdn3[cmp][*][*] is returned</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">cmp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
			<span class="n">mat</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span>
				<span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sym_ten_to_dense</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">],</span> <span class="n">mat</span><span class="p">)</span>
		<span class="n">nc</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nc</span><span class="p">,</span> <span class="n">nc</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">cmp</span><span class="p">:</span>
						<span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
						<span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
					<span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">cmp</span><span class="p">:</span>
						<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
						<span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
					<span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">cmp</span><span class="p">:</span>
						<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
						<span class="n">result</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">result</span></div></div>

<div class="viewcode-block" id="Equilibrate"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate">[docs]</a><span class="k">class</span> <span class="nc">Equilibrate</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;Class for minimizing a generic thermodynamic potential in order to</span>
<span class="sd">	calculate an equilibrium phase assemblage.</span>

<span class="sd">	The default potential is the Gibbs free energy.</span>

<span class="sd">	Parameters</span>
<span class="sd">	----------</span>
<span class="sd">	element_l : [], default None</span>
<span class="sd">		See documentation for element_list attribute.</span>
<span class="sd">	phase_l : [], default None</span>
<span class="sd">		See documentation for phase_list attribute.</span>
<span class="sd">	lagrange_l : [], default None</span>
<span class="sd">		See documentation for lagrange_list attribute.</span>

<span class="sd">	Attributes</span>
<span class="sd">	----------</span>
<span class="sd">	A_omni_inv</span>
<span class="sd">	bulk_comp</span>
<span class="sd">	CTf</span>
<span class="sd">	element_list</span>
<span class="sd">	entropy</span>
<span class="sd">	eps_linear</span>
<span class="sd">	eps_minimal_energy</span>
<span class="sd">	eps_quad_optimal</span>
<span class="sd">	eps_quad_suboptimal</span>
<span class="sd">	eps_rank</span>
<span class="sd">	equil_cycle_max</span>
<span class="sd">	equil_linear_min</span>
<span class="sd">	lagrange_list</span>
<span class="sd">	lagrange_moles</span>
<span class="sd">	lagrange_no_mol_deriv</span>
<span class="sd">	lagrange_use_omni</span>
<span class="sd">	max_linear_iters</span>
<span class="sd">	max_quad_iters</span>
<span class="sd">	moles_in</span>
<span class="sd">	moles_out</span>
<span class="sd">	phase_list</span>
<span class="sd">	phase_separ_threshold</span>
<span class="sd">	reactions</span>
<span class="sd">	rotate_orthog_proj</span>
<span class="sd">	use_numpy_lstsq</span>
<span class="sd">	volume</span>
<span class="sd">	VT_null</span>

<span class="sd">	Notes</span>
<span class="sd">	-----</span>
<span class="sd">	Alternate potentials are specified by stipulating appropriate Lagrange</span>
<span class="sd">	transformations of the Gibbs potential.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase_l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lagrange_l</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_element_list</span> <span class="o">=</span> <span class="n">element_l</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_phase_list</span> <span class="o">=</span> <span class="n">phase_l</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_list</span> <span class="o">=</span> <span class="n">lagrange_l</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_bulk_comp</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_moles_in</span> <span class="o">=</span> <span class="mf">1.0e-5</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_moles_out</span> <span class="o">=</span> <span class="mf">1.0e-8</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_max_quad_iters</span> <span class="o">=</span> <span class="mi">100</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_max_linear_iters</span> <span class="o">=</span> <span class="mi">100</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_phase_separ_threshold</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_CTf</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_moles</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_use_omni</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_rotate_orthog_proj</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_A_omni_inv</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_no_mol_deriv</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_linear</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_quad_optimal</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> <span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_quad_suboptimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_rank</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_equil_cycle_max</span> <span class="o">=</span> <span class="mi">3</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_equil_linear_min</span> <span class="o">=</span> <span class="mi">5</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_minimal_energy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_use_numpy_lstsq</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="n">phases</span><span class="o">.</span><span class="n">Phase</span><span class="o">.</span><span class="n">MINVAL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">element_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A list of strings that identify the element basis for the system</span>

<span class="sd">		For example,[&#39;H&#39;,&#39;C&#39;,&#39;O&#39;,&#39;Na&#39;,&#39;Mg&#39;,&#39;Al&#39;,&#39;Si&#39;,&#39;P&#39;,&#39;K&#39;,&#39;Ca&#39;,&#39;Ti&#39;,&#39;Cr&#39;,</span>
<span class="sd">		&#39;Mn&#39;,&#39;Fe&#39;,&#39;Co&#39;,&#39;Ni&#39;]</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		A Python list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_list</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">phase_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A list of class instances for phases that are permitted to form</span>

<span class="sd">		These instances must derive from the *PurePhase* or *SolutionPhase* classes,</span>
<span class="sd">		which are defined in the *phases* module.</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		A Python list</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_list</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">lagrange_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A list of tuples characterizing the Lagrange transformation of the</span>
<span class="sd">		Gibbs free energy to form the operative thermodynamic potential</span>

<span class="sd">		Each tuple has two terms:</span>

<span class="sd">		1) Either of the following:</span>

<span class="sd">			- A string with content &#39;T&#39; or &#39;P&#39;</span>

<span class="sd">			- A dictionary keyed on element symbols with values corresponding to</span>
<span class="sd">			  stoichiometric coefficients of element chemical potentials.  These</span>
<span class="sd">			  linear combinations of potentials are fixed by the constraint.</span>

<span class="sd">		2) A function to compute values for the constraints specified in (1)</span>

<span class="sd">		The function has a signature func(T, P, state), where *T* is temperature</span>
<span class="sd">		in K, *P* is pressure in bars, and *state* is an instance of the EquilState</span>
<span class="sd">		class.</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		A Python list of tuples</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_list</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">bulk_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Bulk composition of the system as moles of elements</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		numpy array</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_comp</span>

	<span class="nd">@bulk_comp</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">bulk_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> \
			<span class="s1">&#39;bulk_comp must be set to an numpy array&#39;</span>
		<span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="p">),</span> \
			<span class="s1">&#39;bulk_comp array must have same length as element_list&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_bulk_comp</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">moles_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Moles of phase added to the system on detection of saturation</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Number of moles added (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moles_in</span>

	<span class="nd">@moles_in</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">moles_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: moles_in must a a number.&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_moles_in</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">moles_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Minimum total moles of phase allowed in system</span>

<span class="sd">		If there is less than this quantity, the phase is discarded.</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Minimum moles allowed (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moles_out</span>

	<span class="nd">@moles_out</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">moles_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: moles_in must a a number.&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_moles_out</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">max_quad_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Maximum number of Newton quadratic minimization steps allowed in</span>
<span class="sd">		computation</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Number of steps allowed (int)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_quad_iters</span>

	<span class="nd">@max_quad_iters</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">max_quad_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> \
			<span class="s1">&#39;ERROR: max_quad_iters must be an integer.&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_max_quad_iters</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">max_linear_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Maximum number of linear search steps associated with each quadratic</span>
<span class="sd">		iteration</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Number of linear search steps (int)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_linear_iters</span>

	<span class="nd">@max_linear_iters</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">max_linear_iters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> \
			<span class="s1">&#39;ERROR: max_linear_iters must be an integer.&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_max_linear_iters</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">phase_separ_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Minimum energy in Joules for phase separation</span>

<span class="sd">		Gibbs free energy threshold that must be attained in order to add</span>
<span class="sd">		another instance of a phase to the equilibrium assemblage. In the phase</span>
<span class="sd">		unmixing (immiscibility) algorithm, candidate compositions are tested</span>
<span class="sd">		and if one is found with a Gibbs free energy below the projected</span>
<span class="sd">		tangent plane to the input composition by this amount, then the new</span>
<span class="sd">		phase instance is added to the system. The value is in Joules and</span>
<span class="sd">		should always be negative. Values larger than the default will likely</span>
<span class="sd">		encourage the detection of false unmixing events; values more</span>
<span class="sd">		negative will likely prevent the detection of unmixing and result in</span>
<span class="sd">		metastable assemblages. Use caution when altering the default value.</span>

<span class="sd">		Default is -0.1</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Threshold value (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phase_separ_threshold</span>

	<span class="nd">@phase_separ_threshold</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">phase_separ_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_phase_separ_threshold</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Indicates if entropy is an independent variable of the minimal potential</span>
<span class="sd">		and if temperature is a dependent variable</span>

<span class="sd">		True if yes; False if reverse.</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Flag (bool)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Indicates if volume is an independent variable of the minimal potential</span>
<span class="sd">		and if pressure is a dependent variable</span>

<span class="sd">		True if yes; False if reverse.</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Flag (bool)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_volume</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">CTf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Stoichiometric vectors of element concentrations that embody the</span>
<span class="sd">		Lagrange constraints</span>

<span class="sd">		Default is None</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		np_array or None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CTf</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">VT_null</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Orthogonal projection operator obtained from constraints on chemical</span>
<span class="sd">		potentials derived from the lagrange_list entries</span>

<span class="sd">		Default is None</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		np array or None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">reactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Balanced reactions pertaining to the Lagrange constraints</span>

<span class="sd">		Default is None</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		np.array or None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">lagrange_moles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Moles of chemical potential entities stipulated in dictionaries,</span>
<span class="sd">		which are contained in the lagrange_list constraints</span>

<span class="sd">		Default is None</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		np.array or None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_moles</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">lagrange_use_omni</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		If set to True, the algorithm uses the omnicomponent phase exclusively</span>
<span class="sd">		to balance non-linear constraint reactions.</span>

<span class="sd">		Default is True</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Flag (bool)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_use_omni</span>

	<span class="nd">@lagrange_use_omni</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">lagrange_use_omni</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_use_omni</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">rotate_orthog_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Prevents creation of a search direction for potential</span>
<span class="sd">		minimization that has unwanted coupling of oxygen-bearing components</span>

<span class="sd">		The basis vectors of the orthogonal projection matrix, VT_null,</span>
<span class="sd">		generated from the lagrange_list attribute, are rotated to zero to</span>
<span class="sd">		minimize the contribution of oxygen to the null space. This flag is</span>
<span class="sd">		enabled to avoid creating a search direction for potential</span>
<span class="sd">		minimization that has unwanted coupling of oxygen-bearing components</span>
<span class="sd">		(for more information, see method _compute_null_space(...)). This</span>
<span class="sd">		option is seldom needed and can be applied only if no omnicomponent</span>
<span class="sd">		phase is present in the system.</span>

<span class="sd">		Default is False</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Flag (bool)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_orthog_proj</span>

	<span class="nd">@rotate_orthog_proj</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">rotate_orthog_proj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_rotate_orthog_proj</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">A_omni_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		A matrix that transforms an array/matrix of mole numbers of elements to</span>
<span class="sd">		an array/matrix of mole numbers of components of the omnicomponent</span>
<span class="sd">		phase</span>

<span class="sd">		This matrix is the inverse of a matrix that maps elemental</span>
<span class="sd">		abundances to component mole numbers for the omnicomponent phase.</span>
<span class="sd">		This property is available only if chemical potential constraints</span>
<span class="sd">		are specified in lagrange_list and if there is an omnicomponent phase</span>
<span class="sd">		in the system.</span>

<span class="sd">		Default is None</span>

<span class="sd">		readonly</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		2-d nd_array</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A_omni_inv</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">lagrange_no_mol_deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Produces a simplified gradient and hessian of the generalized</span>
<span class="sd">		Khorzhinskii potential</span>

<span class="sd">		Assume that the generalized Khorzhinkii potential is constructed so</span>
<span class="sd">		that the imposed chemical potential is not a function of mole numbers</span>
<span class="sd">		of any phase in the system. Alternatively, the imposed potential is</span>
<span class="sd">		stoichiometrically assembled using reaction coefficients involving</span>
<span class="sd">		equilibrium phases in the assemblage. This option produces a simplified</span>
<span class="sd">		gradient and hessian of the generalized Khorzhinskii potential, but</span>
<span class="sd">		does not affect construction of the equality constraint matrix nor the</span>
<span class="sd">		Lagrange multiplier terms in the hessian of the Lagrangian function.</span>
<span class="sd">		It is seldom necessary to set this flag to True.</span>

<span class="sd">		Default is False</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Flag (bool)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_no_mol_deriv</span>

	<span class="nd">@lagrange_no_mol_deriv</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">lagrange_no_mol_deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_no_mol_deriv</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">eps_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Convergence criteria for the norm of the linear projection phase of the</span>
<span class="sd">		equilibrium calculation</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Convergence tolerance (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps_linear</span>

	<span class="nd">@eps_linear</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">eps_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: eps_linear must be a number.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> \
			<span class="s1">&#39;The value of eps_linear should be greater than machine &#39;</span> \
			<span class="s1">&#39;precision, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_linear</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">eps_quad_optimal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Convergence criteria for the norm of the quadratic projection phase of</span>
<span class="sd">		the equilibrium calculation</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Convergence tolerance (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps_quad_optimal</span>

	<span class="nd">@eps_quad_optimal</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">eps_quad_optimal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: eps_quad_optimal must be a number.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> \
			<span class="s1">&#39;The value of eps_quad_optimal should be greater than machine &#39;</span> \
			<span class="s1">&#39;precision, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_quad_optimal</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">eps_quad_suboptimal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Relaxed convergence criteria for the norm of the quadratic projection</span>
<span class="sd">		phase of the equilibrium calculation</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Convergence tolerance (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps_quad_suboptimal</span>

	<span class="nd">@eps_quad_suboptimal</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">eps_quad_suboptimal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: eps_quad_suboptimal must be a number.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> \
			<span class="s1">&#39;The value of eps_quad_suboptimal should be greater than machine &#39;</span> \
			<span class="s1">&#39;precision, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_quad_suboptimal</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">eps_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tolerance for establishing the rank of the projected Hessian, which is</span>
<span class="sd">		needed to compute a valid quadratic search direction</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Tolerance (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps_rank</span>

	<span class="nd">@eps_rank</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">eps_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: eps_rank must be a number.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> \
			<span class="s1">&#39;The value of eps_rank should be greater than machine &#39;</span> \
			<span class="s1">&#39;precision, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_rank</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">equil_cycle_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Number of addition/removal cycles allowed for a phase before it is</span>
<span class="sd">		suppressed from the equilibrium assemblage</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Iteration limit (int)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equil_cycle_max</span>

	<span class="nd">@equil_cycle_max</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">equil_cycle_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> \
			<span class="s1">&#39;ERROR: equil_cycle_max must be an integer.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> \
			<span class="s1">&#39;The value of equil_cycle_max should be greater than zero&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_equil_cycle_max</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">equil_linear_min</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Number of successful linear minimization attempts that do not result in</span>
<span class="sd">		a subsequent dimunition of the quadratic norm after which convergence is</span>
<span class="sd">		accepted as a &quot;minimal energy&quot; condition.</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Iteration limit (int)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equil_linear_min</span>

	<span class="nd">@equil_linear_min</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">equil_linear_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> \
			<span class="s1">&#39;ERROR: equil_linear_min must be an integer.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> \
			<span class="s1">&#39;The value of equil_linear_min should be greater than zero&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_equil_linear_min</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">eps_minimal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Tolerance for establishing criteria for a minimum in the system</span>
<span class="sd">		potential.</span>

<span class="sd">		Successive linear minimization attempts (equil_linear_min) that do not</span>
<span class="sd">		result in a subsequent dimunition of the quadratic norm within this</span>
<span class="sd">		tolerance result in convergence as a &quot;minimal energy&quot; condition.</span>

<span class="sd">		readwrite</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Tolerance (number)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eps_minimal_energy</span>

	<span class="nd">@eps_minimal_energy</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">eps_minimal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)),</span> \
			<span class="s1">&#39;ERROR: eps_rank must be a number.&#39;</span>
		<span class="k">assert</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">,</span> \
			<span class="s1">&#39;The value of eps_rank should be greater than machine &#39;</span> \
			<span class="s1">&#39;precision, &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_eps_minimal_energy</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">use_numpy_lstsq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Flag to toggle method used to solve for quadratic search direction</span>

<span class="sd">		The quadratic search direction, dn, is computed by solving a system of</span>
<span class="sd">		equations given by H dn = -g, where H is the projected Hessian and g the</span>
<span class="sd">		projected gradient of the system potential (e.g., the system Gibbs free</span>
<span class="sd">		energy). If *use_numpy_lstsq* is True (default), the solution method is</span>
<span class="sd">		numpy&#39;s linalg.lstsq method. If False, a *QR* decomposition method from</span>
<span class="sd">		the Python package statsmodels is utilized. The numpy method uses SVD</span>
<span class="sd">		decomposition and is slower, but more tolerant of rank deficient</span>
<span class="sd">		solutions (e.g., near phase rule violations).</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		Flag (bool)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_numpy_lstsq</span>

	<span class="nd">@use_numpy_lstsq</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">use_numpy_lstsq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="s1">&#39;Value must be True or False.&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_use_numpy_lstsq</span> <span class="o">=</span> <span class="n">value</span>


	<span class="c1">################################</span>
	<span class="c1"># Class private helper methods #</span>
	<span class="c1">################################</span>

	<span class="k">def</span> <span class="nf">_print_matrix_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;   &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_calc_sat_state_affinities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mu_elm</span><span class="p">,</span> <span class="n">omni_phase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Determine saturation state affinities for all system phases with zero</span>
<span class="sd">		moles.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">A_min</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">max</span>
		<span class="n">A_min_name</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="n">omni_phase</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;******************************** &#39;</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Calculating saturation state for &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
				<span class="n">c_mat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
				<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="n">mu_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
					<span class="n">c_row</span> <span class="o">=</span> <span class="n">c_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
					<span class="n">c_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">not_equal</span><span class="p">(</span><span class="n">c_row</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
					<span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">c_row</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span>
						<span class="n">np</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">c_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span><span class="p">))</span>
					<span class="n">mu_end</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">c_row</span><span class="p">,</span> <span class="n">mu_elm</span><span class="p">)</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="mf">0.0</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Target chemical potentials: &#39;</span><span class="p">,</span> <span class="n">mu_end</span><span class="p">)</span>
				<span class="c1"># Now call a phase method that converts mu_elm to A and X</span>
				<span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">X</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">affinity_and_comp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mu_end</span><span class="p">,</span>
					<span class="n">debug</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">False</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;special&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Affinity, mole fraction&#39;</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
				<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;affinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span>
				<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
				<span class="k">if</span> <span class="n">A</span> <span class="o">&lt;</span> <span class="n">A_min</span><span class="p">:</span>
					<span class="n">A_min</span> <span class="o">=</span> <span class="n">A</span>
					<span class="n">A_min_name</span> <span class="o">=</span> <span class="n">name</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">A_min</span><span class="p">,</span> <span class="n">A_min_name</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_determine_phase_stability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculate if the specified phase is stable with respect to unmixing.</span>

<span class="sd">		Returns:</span>
<span class="sd">		--------</span>
<span class="sd">		result: tuple</span>
<span class="sd">			bool, ndarray - unmixing detected; None or composition of second phase</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">():</span>
			<span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
		<span class="n">moles</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">moles</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
		<span class="n">tot_moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tot_moles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Unmixing calculation for&#39;</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">moles</span><span class="o">/</span><span class="n">tot_moles</span><span class="p">)</span>

		<span class="n">mu0</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">nc</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span><span class="mf">0.000001</span><span class="p">)</span>
			<span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
			<span class="n">mu0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>
		<span class="n">gHat</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">)</span>
		<span class="n">dgdn</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">moles</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
			<span class="n">gHat</span> <span class="o">-=</span> <span class="n">mu0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">moles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">dgdn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">mu0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="n">gHat</span> <span class="o">/=</span> <span class="n">tot_moles</span>

		<span class="k">def</span> <span class="nf">deltaG</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
			<span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">moles</span><span class="p">,</span> <span class="n">gHat</span><span class="p">,</span> <span class="n">dgdn</span><span class="p">,</span> <span class="n">mu0</span> <span class="o">=</span> <span class="n">args</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gibbs_energy</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dmol&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
				<span class="n">f</span> <span class="o">-=</span> <span class="n">mu0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">mu0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">f</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
			<span class="n">f</span> <span class="o">-=</span> <span class="n">gHat</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">moles</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">moles</span><span class="p">),</span> <span class="n">dgdn</span><span class="p">)</span>
			<span class="n">df</span> <span class="o">-=</span> <span class="n">dgdn</span>
			<span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">df</span>

		<span class="n">bound_set</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
			<span class="n">bound_set</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.99</span><span class="p">))</span>

		<span class="n">lowest_fun</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="n">lowest_comp</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">debug_flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nc</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)</span>
			<span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">deltaG</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
				<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">moles</span><span class="p">,</span> <span class="n">gHat</span><span class="p">,</span> <span class="n">dgdn</span><span class="p">,</span> <span class="n">mu0</span><span class="p">),</span>
				<span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
				<span class="n">bounds</span><span class="o">=</span><span class="n">bound_set</span><span class="p">,</span>
				<span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">250</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="n">debug_flag</span><span class="p">})</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span> <span class="o">&lt;</span> <span class="n">lowest_fun</span><span class="p">:</span>
				<span class="n">lowest_fun</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>
				<span class="n">lowest_comp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
		<span class="k">if</span> <span class="n">lowest_fun</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_separ_threshold</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">lowest_comp</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>

	<span class="k">def</span> <span class="nf">_add_phase_to_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add a small amount of phase &#39;name&#39; to the system and maintain mass</span>
<span class="sd">		balance by substracting amount added from the omnicomponent phase.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">omni_phase_name</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span>
		<span class="n">omni_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">omni_phase_name</span><span class="p">]</span>
		<span class="n">new_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">new_phase</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
			<span class="n">new_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_phase</span><span class="p">[</span><span class="s1">&#39;mole_frac&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">moles_in</span>
		<span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">new_phase</span><span class="p">[</span><span class="s1">&#39;mole_nz&#39;</span><span class="p">],</span>
			<span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">new_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">),</span>
			<span class="mf">0.0</span><span class="p">)</span>
		<span class="n">c_new_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="c1"># determine elements associated with new_phase</span>
		<span class="n">elm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">c_new_phase</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">new_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">])</span>
		<span class="c1"># cast these elements into moles of the omnicomponent phase</span>
		<span class="n">cT</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">omni_phase_name</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
		<span class="n">cTinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cT</span><span class="p">)</span> <span class="k">if</span> <span class="n">cT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cT</span><span class="p">)</span>
		<span class="n">comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cTinv</span><span class="p">,</span> <span class="n">elm</span><span class="p">)</span>
		<span class="c1"># now subtract this quanity from the omnicomponent phase</span>
		<span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">_remove_phase_from_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Remove a phase &#39;name&#39; from the system and maintain mass balance by</span>
<span class="sd">		adding amount removed to the omnicomponent phase.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">omni_phase_name</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span>
		<span class="n">omni_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">omni_phase_name</span><span class="p">]</span>
		<span class="n">old_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="n">c_old_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="c1"># determine elements associated with old_phase</span>
		<span class="n">elm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">c_old_phase</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">old_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">])</span>
		<span class="c1"># cast these elements into moles of the omnicomponent phase</span>
		<span class="n">cT</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">omni_phase_name</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
		<span class="n">cTinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cT</span><span class="p">)</span> <span class="k">if</span> <span class="n">cT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cT</span><span class="p">)</span>
		<span class="n">comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">cTinv</span><span class="p">,</span> <span class="n">elm</span><span class="p">)</span>
		<span class="c1"># now add this quanity to the omnicomponent phase</span>
		<span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">],</span> <span class="n">comp</span><span class="p">)</span>
		<span class="c1"># finally, zero mole numbers of the phase removed from the system</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">old_phase</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
			<span class="n">old_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">return</span> <span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">_apply_non_linear_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tp_l</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Enforce the non-linear constraints (entropy, volume, chemical</span>
<span class="sd">		potential(s)) on the system.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">def</span> <span class="nf">linear_search</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
						<span class="n">corr</span> <span class="o">=</span> <span class="n">step</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
						<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">corr</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="n">dgdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">dgdn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">result</span> <span class="o">-=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">result</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>

		<span class="k">def</span> <span class="nf">test_bounds_for_search</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
					<span class="n">moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
						<span class="n">corr</span> <span class="o">=</span> <span class="n">step</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
						<span class="n">moles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">corr</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
							<span class="k">return</span> <span class="kc">False</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span><span class="n">moles</span><span class="p">):</span>
							<span class="k">return</span> <span class="kc">False</span>
			<span class="k">return</span> <span class="kc">True</span>

		<span class="k">def</span> <span class="nf">root_target</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
				<span class="n">Dresult</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">Dresult</span>
			<span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
				<span class="n">Dresult</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">Dresult</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

		<span class="n">t</span> <span class="o">=</span> <span class="n">tp_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">tp_l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">func_for_row</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">func_for_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
					<span class="k">continue</span>

				<span class="n">step_max</span> <span class="o">=</span> <span class="mf">0.5</span>
				<span class="k">while</span> <span class="ow">not</span> <span class="n">test_bounds_for_search</span><span class="p">(</span><span class="n">step_max</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
					<span class="n">step_max</span> <span class="o">*=</span> <span class="mf">0.9</span>
					<span class="k">if</span> <span class="n">step_max</span> <span class="o">&lt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
						<span class="k">break</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Maximum linear step search length; &#39;</span><span class="p">,</span> <span class="n">step_max</span><span class="p">)</span>

				<span class="n">step_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
				<span class="k">while</span> <span class="ow">not</span> <span class="n">test_bounds_for_search</span><span class="p">(</span><span class="n">step_min</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
					<span class="n">step_min</span> <span class="o">*=</span> <span class="mf">0.9</span>
					<span class="k">if</span> <span class="n">step_min</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
						<span class="k">break</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Minimum linear step search length; &#39;</span><span class="p">,</span> <span class="n">step_min</span><span class="p">)</span>

				<span class="n">n_ref</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
							<span class="n">n_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
				<span class="n">n_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_ref</span><span class="p">)</span>

				<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">linear_search</span><span class="p">,</span>
					<span class="n">bracket</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">step_min</span><span class="p">,</span><span class="n">step_max</span><span class="p">),</span>
					<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Bounded&#39;</span><span class="p">,</span>
					<span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">250</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="n">debug</span><span class="p">,</span> <span class="s1">&#39;xatol&#39;</span><span class="p">:</span><span class="mf">1e-8</span><span class="p">})</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Optimal linear search length:&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Imposed chemical potential constraints&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;cannot be reconciled within 1 Joule.&#39;</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Consider setting the &quot;lagrange_use_omni&quot;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;property to True.&#39;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_moles</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">+=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
				<span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
						<span class="n">tFun</span> <span class="o">=</span> <span class="n">f</span>
					<span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
						<span class="n">pFun</span> <span class="o">=</span> <span class="n">f</span>
					<span class="k">continue</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root_scalar</span><span class="p">(</span><span class="n">root_target</span><span class="p">,</span>
					<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span>
					<span class="n">method</span><span class="o">=</span><span class="s1">&#39;newton&#39;</span><span class="p">,</span>
					<span class="n">x0</span><span class="o">=</span><span class="n">t</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span> <span class="k">else</span> <span class="n">p</span><span class="p">,</span>
					<span class="n">fprime</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
					<span class="n">maxiter</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
					<span class="n">tp_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">root</span>
				<span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
					<span class="n">tp_l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">root</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
			<span class="c1"># tFun and pFun from above</span>
			<span class="c1"># TBD</span>
			<span class="k">def</span> <span class="nf">roots_fun</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">tFun</span><span class="p">,</span> <span class="n">pFun</span><span class="p">):</span>
				<span class="n">resT</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdT</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">tFun</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
				<span class="n">DresTT</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">resP</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdP</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">pFun</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
				<span class="n">DresPP</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">DresTP</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdTdP</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">return</span> <span class="p">[</span><span class="n">resT</span><span class="p">,</span><span class="n">resP</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">DresTT</span><span class="p">,</span><span class="n">DresTP</span><span class="p">],[</span><span class="n">DresTP</span><span class="p">,</span><span class="n">DresPP</span><span class="p">]])</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">roots_fun</span><span class="p">,</span>
				<span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">],</span>
				<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">tFun</span><span class="p">,</span> <span class="n">pFun</span><span class="p">),</span>
				<span class="n">method</span><span class="o">=</span><span class="s1">&#39;hybr&#39;</span><span class="p">,</span>
				<span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">tp_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">tp_l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_for_row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Solving with multiple chemical potential constraints.&#39;</span><span class="p">)</span>
			<span class="k">def</span> <span class="nf">multi_search</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">func_for_row</span><span class="p">):</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
							<span class="n">corr</span> <span class="o">=</span> <span class="mf">0.0</span>
							<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">func_for_row</span><span class="p">)):</span>
								<span class="n">corr</span> <span class="o">+=</span> <span class="n">step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
							<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">corr</span>
							<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">dgdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

				<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">row</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">func_for_row</span><span class="p">):</span>
					<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">dgdn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
						<span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">result</span>
			<span class="k">def</span> <span class="nf">test_bounds_for_multi_search</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">func_for_row</span><span class="p">):</span>
				<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
						<span class="n">moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
						<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
							<span class="n">corr</span> <span class="o">=</span> <span class="mf">0.0</span>
							<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">func_for_row</span><span class="p">)):</span>
								<span class="n">corr</span> <span class="o">+=</span> <span class="n">step</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
							<span class="n">moles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">corr</span>
							<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
								<span class="k">return</span> <span class="kc">False</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span><span class="n">moles</span><span class="p">):</span>
								<span class="k">return</span> <span class="kc">False</span>
				<span class="k">return</span> <span class="kc">True</span>

			<span class="n">n_ref</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
						<span class="n">n_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
			<span class="n">n_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_ref</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">comp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">oxide_comp</span><span class="p">(</span><span class="s1">&#39;Liquid&#39;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;6s}</span><span class="s2"> </span><span class="si">{1:6.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">multi_search</span><span class="p">,</span>
				<span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">func_for_row</span><span class="p">)),</span>
				<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">func_for_row</span><span class="p">),</span>
				<span class="n">method</span><span class="o">=</span><span class="s1">&#39;hybr&#39;</span><span class="p">,</span>
				<span class="n">jac</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">comp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">oxide_comp</span><span class="p">(</span><span class="s1">&#39;Liquid&#39;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;6s}</span><span class="s2"> </span><span class="si">{1:6.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="n">state</span><span class="o">.</span><span class="n">print_state</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">func_for_row</span><span class="p">)):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_moles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">_compute_a_and_qr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">P_nz</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		From the system state, calculate the mass balance constraint matrix and</span>
<span class="sd">		its QR decomposition.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">filtr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
		<span class="n">vfiltr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">filtr</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span>

		<span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">first</span><span class="p">:</span>
					<span class="n">c_mat</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
					<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">c_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">c_mat</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
		<span class="n">A</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">T</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A before projection and augmentation&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
			<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A after projection and before augmentation&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CTf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="p">)</span>
				<span class="n">omni_phase_name</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_use_omni</span> <span class="ow">and</span> <span class="p">(</span><span class="n">omni_phase_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
					<span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">phase</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">omni_phase_name</span><span class="p">:</span>
								<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ne</span><span class="p">,</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]))</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ne</span><span class="p">,</span><span class="n">phase</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]))</span>
							<span class="n">A_mask</span> <span class="o">=</span> <span class="n">entry</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">A_mask</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
							<span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
					<span class="n">A_react</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">A_mask</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
					<span class="n">A_react</span> <span class="o">=</span> <span class="n">A_react</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">A_react</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A reaction matrix&#39;</span><span class="p">,</span> <span class="n">A_react</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">A_react</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">A_react</span><span class="p">)</span>
				<span class="c1"># Create a mass balance constraint on constrained entity</span>
				<span class="n">react</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A_react</span><span class="p">,</span>
					<span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">CTf</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span> <span class="o">=</span> <span class="n">vfiltr</span><span class="p">(</span><span class="n">react</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;.....&quot;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Enforcing chemical potential constraints.&#39;</span><span class="p">)</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_apply_non_linear_constraints</span><span class="p">([</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">],</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;.....&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Balanced Lagrange reactions&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... residuals&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... rank&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... singular values&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">dgdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
					<span class="n">deltaG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">,</span> <span class="n">dgdn</span><span class="p">)</span>
					<span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">:</span>
						<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
							<span class="n">deltaG</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
							<span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Lagrange chemical potential constraints&#39;</span><span class="p">,</span>
						<span class="n">deltaG</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">deltaG</span><span class="p">)</span>
				<span class="c1"># Project the A  matrix into the NULL space</span>
				<span class="n">Aproj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VT_null</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Aproj&#39;</span><span class="p">,</span> <span class="n">Aproj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">Aproj</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">Aproj</span><span class="p">)</span>
				<span class="c1"># Add rows for the constraint</span>
				<span class="c1">###### d2gdn2 = state.d2Gdn2(t, p, element_basis=True)</span>
				<span class="c1">###### con_rows = np.matmul(self.CTf, d2gdn2)</span>
				<span class="n">d2gdn2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2Gdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="n">con_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span><span class="p">,</span> <span class="n">d2gdn2</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Constraint rows&#39;</span><span class="p">,</span> <span class="n">con_rows</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">con_rows</span><span class="p">)</span>
				<span class="n">Aproj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Aproj</span><span class="p">,</span> <span class="n">con_rows</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A proj augmented with constraints&#39;</span><span class="p">,</span> <span class="n">Aproj</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">Aproj</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">Aproj</span><span class="p">)</span>
				<span class="n">A</span> <span class="o">=</span> <span class="n">Aproj</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
				<span class="n">d2GdTdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdTdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">d2GdT2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">d2GdPdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdPdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">d2GdP2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">d2GdTdP</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdTdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">d2GdTdn</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">d2GdPdn</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
				<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
				<span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
				<span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2GdT2</span>
				<span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2GdP2</span>
				<span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2GdTdP</span>
				<span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2GdTdP</span>
				<span class="n">A</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
				<span class="n">d2GdTdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdTdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">d2GdT2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">d2GdTdn</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
				<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
				<span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2GdT2</span>
				<span class="n">A</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
				<span class="n">d2GdPdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdPdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">d2GdP2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">d2GdPdn</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
				<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
				<span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2GdP2</span>
				<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span><span class="n">col</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A augmented with constraints&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

		<span class="c1"># delete rows that have zero concentrations of elements in the system</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CTf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">VT_null</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
			<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">bc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
		<span class="c1"># delete columns that have zero concentrations of solution components</span>
		<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">P_nz</span><span class="p">)</span>

		<span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
		<span class="n">rref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">rref</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
		<span class="n">row_rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rref</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">row_rank</span><span class="p">:</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">col</span> <span class="o">-</span> <span class="n">row</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A matrix has reduced row space by:&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">-</span><span class="n">row_rank</span><span class="p">)</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">col</span> <span class="o">-</span> <span class="n">row_rank</span>
		<span class="n">R</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">rq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;RQ = A, R matrix&#39;</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">vfiltr</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">vfiltr</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;RQ = A, Q matrix&#39;</span><span class="p">,</span> <span class="n">Q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">vfiltr</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">vfiltr</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
		<span class="n">R11</span> <span class="o">=</span> <span class="n">vfiltr</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span><span class="n">df</span><span class="p">:])</span>
		<span class="n">Q1</span> <span class="o">=</span> <span class="n">vfiltr</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">df</span><span class="p">:,:])</span>
		<span class="n">Q2</span> <span class="o">=</span> <span class="n">vfiltr</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">df</span><span class="p">,:])</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">,</span> <span class="n">R11</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_compute_null_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Construct a projection operator to account for open system constraints</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="p">)</span>
		<span class="n">CTf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">ne</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_entropy</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_volume</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">assert</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;Legendre transform must specify &quot;T&quot;, &quot;P&quot;, &#39;</span>
						<span class="o">+</span> <span class="s1">&#39;or a dictionary of chemical potential constraints.&#39;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
				<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
					<span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
				<span class="n">CTf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">CTf</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">assert</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;Legendre transform must specify &quot;T&quot;, &quot;P&quot;, &#39;</span>
					<span class="o">+</span> <span class="s1">&#39;or a dictionary of chemical potential constraints.&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_CTf</span> <span class="o">=</span> <span class="n">CTf</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_A_omni_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span>
				<span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_A_omni_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ne</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;CTf&#39;</span><span class="p">,</span> <span class="n">CTf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="n">CTf</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;A_omni_inv&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="p">)</span>
		<span class="n">CTf_pad</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">CTf</span><span class="p">,((</span><span class="mi">0</span><span class="p">,</span><span class="n">CTf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">CTf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
		<span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">VT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">CTf_pad</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">A_omni_inv</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">U</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">S</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;VT&#39;</span><span class="p">,</span> <span class="n">VT</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">VT</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">VT</span><span class="p">)</span>
		<span class="n">rank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span> <span class="o">=</span> <span class="n">VT</span><span class="p">[</span><span class="n">rank</span><span class="p">:,:]</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;VT null space&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_orthog_proj</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">row_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;ERROR! Oxygen is not present in the system and &quot;</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;       a null-space rotation on O is specified.&quot;</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;----------&quot;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Adjusting the null space basis for oxygen.&quot;</span><span class="p">)</span>
			<span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="o">.</span><span class="n">T</span>
			<span class="n">filtr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span>
				<span class="mi">1000</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
			<span class="n">vfiltr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">filtr</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span>
			<span class="c1"># zero the null space bassis coefficient at col_ind and row_ind</span>
			<span class="k">def</span> <span class="nf">zeros</span><span class="p">(</span><span class="n">deg_a</span><span class="p">,</span> <span class="n">v_a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">col_ind_a</span><span class="p">,</span> <span class="n">row_ind</span><span class="p">,</span> <span class="n">ret_matrix</span><span class="p">):</span>
				<span class="n">ns_p</span> <span class="o">=</span> <span class="n">ns</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">deg</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">col_ind</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">deg_a</span><span class="p">,</span><span class="n">v_a</span><span class="p">,</span><span class="n">col_ind_a</span><span class="p">):</span>
					<span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">deg</span><span class="o">/</span><span class="mf">180.0</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
					<span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
						<span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">u</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">u</span><span class="p">)</span>
						<span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
					<span class="n">ns_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="n">ns_p</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">ret_matrix</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">ns_p</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="k">for</span> <span class="n">col_ind</span> <span class="ow">in</span> <span class="n">col_ind_a</span><span class="p">:</span>
						<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns_p</span><span class="p">[</span><span class="n">row_ind</span><span class="p">][</span><span class="n">col_ind</span><span class="p">])</span>
					<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">u</span><span class="p">[</span><span class="n">row_ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="n">v_a</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">col_ind_a</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
				<span class="k">if</span> <span class="n">ns</span><span class="p">[</span><span class="n">row_ind</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
					<span class="n">v_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">[:,</span><span class="n">col</span><span class="p">])</span>
					<span class="n">col_ind_a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
					<span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">zeros</span><span class="p">,</span>
				<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">v_a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">col_ind_a</span><span class="p">,</span> <span class="n">row_ind</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
				<span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;... rotation algoritm output:&quot;</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">ns_p</span> <span class="o">=</span> <span class="n">vfiltr</span><span class="p">(</span><span class="n">zeros</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">v_a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">col_ind_a</span><span class="p">,</span> <span class="n">row_ind</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span> <span class="o">=</span> <span class="n">ns_p</span><span class="o">.</span><span class="n">T</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;rotated null space basis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_VT_null</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;----------&quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_augment_gradient_hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Ammend the gradient and Hessian of the Gibbs free energy to account for</span>
<span class="sd">		the Khorzhinskii corections.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result: tuple</span>
<span class="sd">			corrected (g, H)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">dgdn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
		<span class="n">d2gdn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
		<span class="n">rank_H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
				<span class="c1"># determine molar equivalent of open system reactant</span>
				<span class="n">moles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">moles_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
				<span class="c1"># determine the first order correction to the gradient</span>
				<span class="n">gAdd_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dgdn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
				<span class="n">gAdd_1</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
				<span class="n">gAdd_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gAdd_1</span><span class="p">,</span> <span class="p">(</span><span class="n">gAdd_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;moles&#39;</span><span class="p">,</span> <span class="n">moles</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;1st gradient addition&#39;</span><span class="p">,</span> <span class="n">gAdd_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="o">-</span><span class="n">gAdd_1</span><span class="p">)</span>
				<span class="c1"># determine the second order correction to the gradient</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_no_mol_deriv</span><span class="p">:</span>
					<span class="n">gAdd_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">d2gdn2</span><span class="p">)</span>
					<span class="n">gAdd_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">gAdd_2</span><span class="p">,</span> <span class="p">(</span><span class="n">gAdd_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;2nd gradient addition&#39;</span><span class="p">,</span> <span class="n">gAdd_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="o">-</span><span class="n">moles</span><span class="o">*</span><span class="n">gAdd_2</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">gAdd_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="c1"># add contributions to gradient</span>
				<span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">-</span> <span class="n">gAdd_1</span> <span class="o">-</span> <span class="n">moles</span><span class="o">*</span><span class="n">gAdd_2</span>
				<span class="c1"># add contributions to Hessian</span>
				<span class="c1"># ... first, index the structure of the hessian</span>
				<span class="n">phase_info</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
							<span class="n">phase_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span><span class="n">offset</span><span class="p">,</span><span class="n">idx2</span><span class="p">))</span>
						<span class="n">offset</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;phase_info&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_info</span><span class="p">),</span> <span class="s1">&#39;reactions&#39;</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">phase_info</span><span class="p">)</span>
				<span class="c1"># ... second, build the Hessian additions</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_no_mol_deriv</span><span class="p">:</span>
					<span class="n">hAdd_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">gAdd_2</span><span class="p">)</span>
					<span class="n">hAdd_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">gAdd_2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
					<span class="n">hAdd_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">idx2</span><span class="p">,</span><span class="n">coeff</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">idx</span><span class="p">]):</span>
						<span class="k">if</span> <span class="n">coeff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
							<span class="n">name</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>
							<span class="n">HAdd</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3Gdn3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
							<span class="n">idx3</span> <span class="o">=</span> <span class="n">rank_H</span> <span class="o">-</span> <span class="n">HAdd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span>
							<span class="n">hAdd_3</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">HAdd</span><span class="p">,((</span><span class="n">offset</span><span class="p">,</span><span class="n">idx3</span><span class="p">),(</span><span class="n">offset</span><span class="p">,</span><span class="n">idx3</span><span class="p">)),</span>
								<span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;1st hessian addition&#39;</span><span class="p">,</span> <span class="n">hAdd_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="o">-</span><span class="n">hAdd_1</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;2nd hessian addition&#39;</span><span class="p">,</span> <span class="n">hAdd_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="o">-</span><span class="n">hAdd_2</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;3rd hessian addition&#39;</span><span class="p">,</span> <span class="n">hAdd_3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="o">-</span><span class="n">moles</span><span class="o">*</span><span class="n">hAdd_3</span><span class="p">)</span>
					<span class="n">H</span> <span class="o">+=</span> <span class="o">-</span><span class="n">hAdd_1</span> <span class="o">-</span> <span class="n">hAdd_2</span> <span class="o">-</span> <span class="n">moles</span><span class="o">*</span><span class="n">hAdd_3</span>
				<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdTdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdPdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">d2gdtdp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2GdTdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">d2gdtdp</span><span class="p">))</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">d2gdtdp</span><span class="p">))</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdTdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdPdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">d3gdt2dn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdT2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">d3gdp2dn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdP2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">d3gdtdpdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdTdPdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">colT</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="n">d3gdt2dn</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">d3gdtdpdn</span>
			<span class="n">colP</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">d3gdp2dn</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">d3gdtdpdn</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">colT</span><span class="p">,</span> <span class="n">colP</span><span class="p">))</span>
			<span class="n">d3gdt2dp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdT2dP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">d3gdtdp2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdTdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">termTT</span> <span class="o">=</span> <span class="o">-</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">d3gdt2dp</span>
			<span class="n">termPP</span> <span class="o">=</span> <span class="o">-</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">d3gdtdp2</span>
			<span class="n">termTP</span> <span class="o">=</span> <span class="o">-</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdTdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">d3gdt2dp</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">d3gdtdp2</span>
			<span class="n">rowT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">colT</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">termTT</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
				<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">termTP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">rowP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">colP</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">termTP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
				<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">termPP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">rowT</span><span class="p">,</span> <span class="n">rowP</span><span class="p">))</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdTdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdTdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
			<span class="n">term</span> <span class="o">=</span> <span class="o">-</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdT2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">row</span><span class="p">))</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdPdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)))</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">H</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdPdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>
			<span class="n">term</span> <span class="o">=</span> <span class="o">-</span><span class="n">state</span><span class="o">.</span><span class="n">d2GdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">H</span><span class="p">,</span><span class="n">row</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Augmented g&#39;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">g</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Augmented H&#39;</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">H</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_compute_lagrange_multipliers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Estimate Lagrange multipliers from the gradient and equality constraint</span>
<span class="sd">		derivative matrix.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">soln</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Lagrange multiplier solution&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... solution&#39;</span><span class="p">,</span> <span class="n">soln</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="n">soln</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... residuals&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... singular values&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="nb">print</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">soln</span>

	<span class="k">def</span> <span class="nf">_augment_hessian_return_wronskian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">l_mult</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Augment the Hessian matrix with Lagrange multiplier terms for the</span>
<span class="sd">		non-linear constraints.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rows</span><span class="p">):</span>
				<span class="n">lagrange</span> <span class="o">=</span> <span class="n">l_mult</span><span class="p">[</span><span class="n">l_mult</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">rows</span><span class="o">+</span><span class="n">row</span><span class="p">]</span>
				<span class="n">react</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Lagrange multiplier:&#39;</span><span class="p">,</span> <span class="n">lagrange</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
						<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
						<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
							<span class="n">coeff</span> <span class="o">=</span> <span class="n">react</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
							<span class="n">mat</span> <span class="o">=</span> <span class="n">coeff</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]])</span>
							<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nc</span><span class="p">,</span><span class="n">nc</span><span class="p">))</span>
							<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
								<span class="k">if</span> <span class="n">react</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
									<span class="n">coeff</span> <span class="o">=</span> <span class="n">react</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
									<span class="n">mat_r</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3Gdn3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
									<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">coeff</span><span class="o">*</span><span class="n">mat_r</span><span class="p">)</span>
								<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">lagrange</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Hessian addition:&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
				<span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
			<span class="n">lam_T</span> <span class="o">=</span> <span class="n">l_mult</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
			<span class="n">lam_P</span> <span class="o">=</span> <span class="n">l_mult</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdTdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">lam_P</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdPdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">d3gdtdpdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdTdPdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">col_T</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">lam_P</span><span class="o">*</span><span class="n">d3gdtdpdn</span>
			<span class="n">col_P</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">d3gdtdpdn</span> <span class="o">-</span> <span class="n">lam_P</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">col_T</span><span class="p">,</span> <span class="n">col_P</span><span class="p">))</span>
			<span class="n">d3gdt2dp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdT2dP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">d3gdtdp2</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d3GdTdP2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">term_TT</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">lam_P</span><span class="o">*</span><span class="n">d3gdt2dp</span>
			<span class="n">term_TP</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">d3gdt2dp</span> <span class="o">-</span> <span class="n">lam_P</span><span class="o">*</span><span class="n">d3gdtdp2</span>
			<span class="n">term_PP</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">d3gdtdp2</span> <span class="o">-</span> <span class="n">lam_P</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">row_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col_T</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term_TT</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
				<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term_TP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">row_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col_P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term_TP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
				<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term_PP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">row_T</span><span class="p">,</span> <span class="n">row_P</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Hessian addition (S,V):&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
			<span class="n">lam_T</span> <span class="o">=</span> <span class="n">l_mult</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdTdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">col_T</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">col_T</span><span class="p">))</span>
			<span class="n">term_TT</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_T</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdT3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">row_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col_T</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term_TT</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">row_T</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Hessian addition (S):&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
			<span class="n">lam_P</span> <span class="o">=</span> <span class="n">l_mult</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_P</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdPdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">col_P</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_P</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP2dn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">col_P</span><span class="p">))</span>
			<span class="n">term_PP</span> <span class="o">=</span> <span class="o">-</span><span class="n">lam_P</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">d3GdP3</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
			<span class="n">row_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">col_P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">term_PP</span><span class="p">],</span><span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">row_P</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Hessian addition (V):&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">H</span>

	<span class="c1">########################</span>
	<span class="c1"># Class public methods #</span>
	<span class="c1">########################</span>

<div class="viewcode-block" id="Equilibrate.mu0O2"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate.mu0O2">[docs]</a>	<span class="k">def</span> <span class="nf">mu0O2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the chemical potential of oxygen gas in the standard state</span>
<span class="sd">		of unit fugacity at one bar and any tenperature</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t : float</span>
<span class="sd">			Temperature in Kelvins</span>
<span class="sd">		p : float</span>
<span class="sd">			Pressure in bars</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : float</span>
<span class="sd">			standard state chemical potential in Joules/mole of O2 gas</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Algorithm from Berman (1988).</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">tr</span> <span class="o">=</span> <span class="mf">298.15</span>
		<span class="n">hs</span> <span class="o">=</span> <span class="mf">23.10248</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">tr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="mf">804.8876</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span> \
		   <span class="o">-</span> <span class="mf">1762835.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">t</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">18172.91960</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span> \
		   <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="mf">0.002676</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">-</span><span class="n">tr</span><span class="o">*</span><span class="n">tr</span><span class="p">)</span>
		<span class="n">ss</span> <span class="o">=</span> <span class="mf">205.15</span> <span class="o">+</span> <span class="mf">23.10248</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span>  \
		   <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="mf">804.8876</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span> \
		   <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="mf">1762835.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">tr</span><span class="o">*</span><span class="n">tr</span><span class="p">))</span> \
		   <span class="o">+</span> <span class="mf">18172.91960</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">t</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">tr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.002676</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">tr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hs</span> <span class="o">-</span> <span class="n">t</span><span class="o">*</span><span class="n">ss</span></div>

<div class="viewcode-block" id="Equilibrate.log10NNO"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate.log10NNO">[docs]</a>	<span class="k">def</span> <span class="nf">log10NNO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the base 10 logarithm of oxygen fugacity along the nickel-</span>
<span class="sd">		nickel oxide buffer</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t : float</span>
<span class="sd">			Temperature in Kelvins</span>
<span class="sd">		p : float</span>
<span class="sd">			Pressure in bars</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : float</span>
<span class="sd">			log (10) f O2</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Algorithm from O&#39;Neill and Pownceby (1993, Contributions to Mineralogy</span>
<span class="sd">		and Petrology, 114, 296-314) using the pressure correction suggested by</span>
<span class="sd">		Frost (1991, Mineralogical Society of America, Reviews in Mineralogy,</span>
<span class="sd">		v. 25, 1-9)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mf">25018.7</span><span class="o">/</span><span class="n">t</span> <span class="o">+</span> <span class="mf">12.981</span> <span class="o">+</span> <span class="mf">0.046</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">/</span><span class="n">t</span> <span class="o">-</span> <span class="mf">0.5117</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>

<div class="viewcode-block" id="Equilibrate.muNNO"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate.muNNO">[docs]</a>	<span class="k">def</span> <span class="nf">muNNO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates the excess chemical potential of oxygen along the nickel-</span>
<span class="sd">		nickel oxide (+ delta offset) buffer</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t : float</span>
<span class="sd">			Temperature in Kelvins</span>
<span class="sd">		p : float</span>
<span class="sd">			Pressure in bars</span>
<span class="sd">		delta : float, default 0.0</span>
<span class="sd">			Offset in base 10 log units relative to the nickel-nickel oxide</span>
<span class="sd">			oxygen buffer</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : float</span>
<span class="sd">			Excess chemical potential of oxygen in Joules/mole of O2</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		See definition of function log10NNO(t, p)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="mf">8.3144598</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log10NNO</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span></div>

<div class="viewcode-block" id="Equilibrate.kc_ferric_ferrous"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate.kc_ferric_ferrous">[docs]</a>	<span class="k">def</span> <span class="nf">kc_ferric_ferrous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mtype</span><span class="o">=</span><span class="s1">&#39;components&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;logfO2&#39;</span><span class="p">,</span>
		<span class="n">deltaNNO</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates oxygen fugacity or ferric-ferrous ratio for silicate melts</span>
<span class="sd">		using the Kress and Carmichael (1991) calibration</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t : float</span>
<span class="sd">			Temperature in Kelvins</span>
<span class="sd">		p : float</span>
<span class="sd">			Pressure in bars</span>
<span class="sd">		m : numpy ndarray</span>
<span class="sd">			An array of moles of endmember liquid components correcponding to</span>
<span class="sd">			the model of Ghiorso and Sack (1995) (m has length 15) or the</span>
<span class="sd">			model of Ghiorso and Gualda (2015) (m has length 16)</span>
<span class="sd">		mtype : str, default &#39;components&#39;</span>
<span class="sd">			Type of values in m.</span>
<span class="sd">		compute : str, default &#39;logfO2&#39;</span>
<span class="sd">			Type of output requested, see Returns.</span>
<span class="sd">		deltaNNO : float, default 0.0</span>
<span class="sd">			If ferric-ferrous computation if requested (see compute), the ratio</span>
<span class="sd">			will be computed at log 10 f O2 = nickel-nickel oxide + deltaNNO</span>
<span class="sd">		debug : int, default 0</span>
<span class="sd">			Level of detail printed by the method:</span>

<span class="sd">			- 0, no information</span>

<span class="sd">			- 1, minimal progress information</span>

<span class="sd">			- 2, normal debugint output level</span>

<span class="sd">			- 3, verbose debuging output level</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : float</span>
<span class="sd">			log 10 f O2, if compute is set to &#39;logfO2&#39; (default)</span>
<span class="sd">			excess chemical potential of O2, if compute is set to &#39;chem_pot&#39;</span>
<span class="sd">		result : numpy ndarray</span>
<span class="sd">			array of oxide values, with the computed ferric-ferrous ratio</span>
<span class="sd">			appropriate to the imposed log f O2. The oxides are in standard</span>
<span class="sd">			order: SiO2, TiO2, Al2O3, Fe2O3, Cr2O3, FeO, MnO, MgO, NiO, CoO,</span>
<span class="sd">			CaO, Na2O, K2O, P2O5, H2O, [CO2]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="s1">&#39;m must be an numpy array.&#39;</span>
		<span class="k">assert</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">15</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">16</span><span class="p">,</span> \
			<span class="s1">&#39;m must be a 1-d numpy array of length 15 or 16&#39;</span>
		<span class="k">assert</span> <span class="n">mtype</span> <span class="o">==</span> <span class="s1">&#39;components&#39;</span><span class="p">,</span> <span class="s1">&#39;the value of mtype must be &quot;components&quot;&#39;</span>
		<span class="k">assert</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;logfO2&#39;</span> <span class="ow">or</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;chem_pot&#39;</span> <span class="ow">or</span> \
			<span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;oxides&#39;</span><span class="p">,</span> \
			<span class="s1">&#39;the value of compute must be &quot;logfO2&quot; or &quot;chem_pot&quot; or &quot;oxides&quot;&#39;</span>
		<span class="n">t0</span> <span class="o">=</span> <span class="mf">1673.15</span>
		<span class="n">a</span>  <span class="o">=</span>    <span class="mf">0.196</span>
		<span class="n">b</span>  <span class="o">=</span>    <span class="mf">1.1492e4</span>
		<span class="n">c</span>  <span class="o">=</span>   <span class="o">-</span><span class="mf">6.675</span>
		<span class="n">e</span>  <span class="o">=</span>   <span class="o">-</span><span class="mf">3.364</span>
		<span class="n">f</span>  <span class="o">=</span>   <span class="o">-</span><span class="mf">7.01e-7</span>  <span class="o">*</span> <span class="mf">1.0e5</span>
		<span class="n">g</span>  <span class="o">=</span>   <span class="o">-</span><span class="mf">1.54e-10</span> <span class="o">*</span> <span class="mf">1.0e5</span>
		<span class="n">h</span>  <span class="o">=</span>    <span class="mf">3.85e-17</span> <span class="o">*</span> <span class="mf">1.0e5</span> <span class="o">*</span> <span class="mf">1.0e5</span>
		<span class="n">d</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.243</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.828</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">3.201</span><span class="p">,</span> <span class="mf">5.854</span><span class="p">,</span>
					   <span class="mf">6.215</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
		<span class="c1"># &#39;SiO2&#39;, &#39;TiO2&#39;, &#39;Al2O3&#39;, &#39;Fe2O3&#39;, &#39;MgCr2O4&#39;, &#39;Fe2SiO4&#39;, &#39;MnSi0.5O2&#39;,</span>
		<span class="c1"># &#39;Mg2SiO4&#39;, &#39;NiSi0.5O2&#39;, &#39;CoSi0.5O2&#39;, &#39;CaSiO3&#39;, &#39;Na2SiO3&#39;, &#39;KAlSiO4&#39;,</span>
		<span class="c1"># &#39;Ca3(PO4)2&#39;, &#39;H2O&#39;, &#39;CO2&#39;</span>
		<span class="n">ox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="c1"># SiO2</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>            <span class="c1"># TiO2</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>   <span class="c1"># Al2O3</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>            <span class="c1"># Fe2O3</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>            <span class="c1"># Cr2O3</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mf">2.</span><span class="p">,</span>         <span class="c1"># FeO</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>            <span class="c1"># MnO</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="mf">2.0</span><span class="p">,</span>   <span class="c1"># MgO</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>            <span class="c1"># NiO</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>            <span class="c1"># CoO</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="n">m</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="mf">3.</span><span class="p">,</span>  <span class="c1"># CaO</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>           <span class="c1"># Na2O</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>        <span class="c1"># K2O</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>           <span class="c1"># P2O5</span>
					   <span class="n">m</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>            <span class="c1"># H2O</span>
					  <span class="p">])</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;kc Fe3+/Fe2+ input grams Fe2O3, FeO&#39;</span><span class="p">,</span>
				<span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">ox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
			<span class="n">ox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
			<span class="n">ox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span> <span class="c1"># CO2</span>
		<span class="n">tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ox</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">tot</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;kc Fe3+/Fe2+ no iron in input composition.&#39;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;logfO2&#39;</span> <span class="ow">or</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;chem_pot&#39;</span><span class="p">:</span>
				<span class="k">return</span> <span class="mf">0.0</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">ox</span>
		<span class="k">if</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;logfO2&#39;</span> <span class="ow">or</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;chem_pot&#39;</span><span class="p">:</span>
			<span class="n">temp</span>  <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="n">t</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">t0</span><span class="o">/</span><span class="n">t</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">t0</span><span class="p">))</span> <span class="o">+</span> <span class="n">f</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">t</span> \
				  <span class="o">+</span> <span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">t</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">t</span>
			<span class="n">temp</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="n">tot</span>
			<span class="n">logfo2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">ox</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">-</span> <span class="n">temp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;kc Fe3+/Fe2+ log fO2&#39;</span><span class="p">,</span> <span class="n">logfo2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">logfo2</span> <span class="k">if</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;logfO2&#39;</span> \
						  <span class="k">else</span> <span class="mf">8.3144598</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span><span class="o">*</span><span class="n">logfo2</span>
		<span class="k">elif</span> <span class="n">compute</span> <span class="o">==</span> <span class="s1">&#39;oxides&#39;</span><span class="p">:</span>
			<span class="n">ox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
			<span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="n">logfO2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10NNO</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">deltaNNO</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span><span class="o">*</span><span class="n">logfO2</span> <span class="o">+</span> <span class="n">b</span><span class="o">/</span><span class="n">t</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">t0</span><span class="o">/</span><span class="n">t</span> \
				 <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">t0</span><span class="p">))</span> <span class="o">+</span> <span class="n">f</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">t</span> <span class="o">+</span> <span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">t</span> <span class="o">+</span> <span class="n">h</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">t</span>
			<span class="n">temp</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">tot</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
			<span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">temp</span><span class="o">*</span><span class="n">ox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">temp</span><span class="p">)</span>
			<span class="n">ox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;kc Fe3+/Fe2+ comp  grams Fe2O3, FeO&#39;</span><span class="p">,</span>
					<span class="n">ox</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
					<span class="n">ox</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">core</span><span class="o">.</span><span class="n">chem</span><span class="o">.</span><span class="n">oxide_props</span><span class="p">[</span><span class="s1">&#39;molwt&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">ox</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Equilibrate.kc_print_state"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate.kc_print_state">[docs]</a>	<span class="k">def</span> <span class="nf">kc_print_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Prints information about the  current system state in terms of the Kress</span>
<span class="sd">		and Carmichael (1991) ferrous-ferric equilibrium model</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		state : EquilState, default None</span>
<span class="sd">			An instance of the EquilState class generated by this method. This</span>
<span class="sd">			parameter is only specified for a sequence of equilibrium</span>
<span class="sd">			calculations where the state of the system is initialized from a</span>
<span class="sd">			previous computation.</span>
<span class="sd">		silent : bool, default False</span>
<span class="sd">			Flag to silence printing</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		result : tuple or None</span>
<span class="sd">			Returns None if state is None or the system does not contain an</span>
<span class="sd">			omnicomponent phase name &#39;Liquid&#39;, else returns a tuple with the</span>
<span class="sd">			computer log 10 fO2 of the liquid phase relative to the NNO oxygen</span>
<span class="sd">			buffer, the value of log 10 fO2 on the buffer, and the total number</span>
<span class="sd">			of moles of oxygen in the system</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Current system &quot;state&quot; must be provided.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="s1">&#39;Liquid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Current system must contain the phase &quot;Liquid&quot;.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">temperature</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pressure</span>
		<span class="n">moles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
		<span class="n">logfO2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kc_ferric_ferrous</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">moles</span><span class="p">)</span>
		<span class="n">NNOfO2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10NNO</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
		<span class="n">moles_O</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_elements</span><span class="p">()[</span><span class="n">state</span><span class="o">.</span><span class="n">element_l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;System log 10 fO2&#39;</span><span class="p">,</span> <span class="n">logfO2</span><span class="o">-</span><span class="n">NNOfO2</span><span class="p">,</span> <span class="s1">&#39;realtive to NNO.&#39;</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;System log 10 NNO&#39;</span><span class="p">,</span> <span class="n">NNOfO2</span><span class="p">)</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Moles of O in system&#39;</span><span class="p">,</span> <span class="n">moles_O</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">logfO2</span><span class="o">-</span><span class="n">NNOfO2</span><span class="p">,</span> <span class="n">NNOfO2</span><span class="p">,</span> <span class="n">moles_O</span><span class="p">)</span></div>

<div class="viewcode-block" id="Equilibrate.execute"><a class="viewcode-back" href="../equilibrate.html#equilibrate.Equilibrate.execute">[docs]</a>	<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">bulk_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">con_deltaNNO</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculates an equilibrium assemblage, returning the results as an</span>
<span class="sd">		instance of the EquilState class</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t : float, default 1000.0</span>
<span class="sd">			Temperature in Kelvins</span>
<span class="sd">		p : float, default 1000.0</span>
<span class="sd">			Pressure in bars</span>
<span class="sd">		bulk_comp : numpy array, default None</span>
<span class="sd">			Bulk composition of the system. Array of element concentrations,</span>
<span class="sd">			of the length and order of self.element_list</span>
<span class="sd">		state : EquilState, default None</span>
<span class="sd">			An instance of the EquilState class generated by this method. This</span>
<span class="sd">			parameter is only specified for a sequence of equilibrium</span>
<span class="sd">			calculations where the state of the system is initialized from a</span>
<span class="sd">			previous computation.</span>
<span class="sd">		con_deltaNNO : float or None</span>
<span class="sd">			A non-None value for this parameter is ignored unless the system</span>
<span class="sd">			contains an omnicomponnet liquid phase of either 15 or 16 endmember</span>
<span class="sd">			components modeled after Ghiorso and Sack (1995) or Ghiorso and</span>
<span class="sd">			Gualda (2015), i.e. a MELTS silicate liquid thermodynamic model. If</span>
<span class="sd">			a value is set, the liquid is constrained to follow the nickel-</span>
<span class="sd">			nickel oxide oxygen buffer plus the offset value, con_deltaNNO,</span>
<span class="sd">			which is specified in log 10 fO2 units. For example, a value of 1.0</span>
<span class="sd">			will force the system to equilibrate on the NNO+1 oxygen buffer by</span>
<span class="sd">			adjusting the ratio of ferric and ferrous iron according to the</span>
<span class="sd">			Kress and Carmichael (1991) calibration. Setting a value permits</span>
<span class="sd">			the system to be open to oxygen transfer; the bulk moles of</span>
<span class="sd">			oxygen in the system is no longer constrained by input bulk</span>
<span class="sd">			composition.</span>
<span class="sd">		debug : int, default 0</span>
<span class="sd">			Level of detail printed by the method:</span>

<span class="sd">			- 0, no information</span>

<span class="sd">			- 1, minimal progress information</span>

<span class="sd">			- 2, normal debugint output level</span>

<span class="sd">			- 3, verbose debuging output level</span>

<span class="sd">		stats : bool, default False</span>
<span class="sd">			Toggle printing of statistics associated with calculation progress</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		state: EquilState</span>
<span class="sd">			An instance of the EquilState class that contains the equilibrium</span>
<span class="sd">			state of the system</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Both the bulk_comp and state parameters cannot be set simultaneously.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bulk_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> \
				<span class="s1">&#39;Both &quot;bulk_comp&quot; and &quot;state&quot; parameters cannot be specified.&#39;</span>
		<span class="k">if</span> <span class="n">bulk_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span> <span class="o">=</span> <span class="n">bulk_comp</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Bulk composition of the system must be set.&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">None</span>

		<span class="c1"># Initialize the EquilState class instance if one is not specified</span>
		<span class="n">require_quad_pass_before_phase_addition</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">state</span> <span class="o">=</span> <span class="n">EquilState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_list</span><span class="p">)</span>
			<span class="c1"># Currently, one phase must be omnicomponent</span>
			<span class="n">omni_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">omni_phase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;There is no omnicomponent phase in the system.&quot;</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">None</span>
			<span class="c1"># Assume the system inititally has just the omnicomponent phase</span>
			<span class="n">state</span><span class="o">.</span><span class="n">set_phase_comp</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span><span class="p">,</span>
				<span class="n">input_as_elements</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">force_once_quad_pass</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="n">state</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">t</span>
			<span class="n">state</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">p</span>

			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_compute_null_space</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
				<span class="n">force_once_quad_pass</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
					<span class="c1">#imposed chemical potential constraints</span>
					<span class="n">require_quad_pass_before_phase_addition</span> <span class="o">=</span> <span class="kc">True</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="n">omni_phase</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">omni_phase</span><span class="p">()</span>
			<span class="n">force_once_quad_pass</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">state</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">t</span>
			<span class="n">state</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">p</span>
		<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="n">omni_phase</span> <span class="o">+</span> <span class="s1">&#39; is the omnicomponent phase.&#39;</span><span class="p">)</span>

		<span class="n">ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element_list</span><span class="p">)</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
			<span class="n">tp_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_apply_non_linear_constraints</span><span class="p">(</span><span class="n">tp_l</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
			<span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tp_l</span><span class="p">)</span>
			<span class="n">state</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">t</span>
			<span class="n">state</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">p</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Final corrected temperature&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Final corrected pressure&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">con_deltaNNO</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">assert</span> <span class="n">omni_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
				<span class="s1">&#39;Specifying a value for con_deltaNNO requires an &#39;</span> \
				<span class="o">+</span> <span class="s1">&#39;omnicomponent phase in the assemblage.&#39;</span>
			<span class="k">assert</span> <span class="n">omni_phase</span> <span class="o">==</span> <span class="s1">&#39;Liquid&#39;</span><span class="p">,</span> \
				<span class="s1">&#39;The omnicomponent phase must be named &quot;Liquid&quot; &#39;</span> \
				<span class="o">+</span> <span class="s1">&#39;and must inherit from the silicate liquid model of &#39;</span> \
				<span class="o">+</span> <span class="s1">&#39;Ghiorso and Sack (1995) or Ghiorso and Gualda (2015).&#39;</span>
			<span class="n">omni_nc</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">][</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
			<span class="k">assert</span> <span class="n">omni_nc</span> <span class="o">==</span> <span class="mi">15</span> <span class="ow">or</span> <span class="n">omni_nc</span> <span class="o">==</span> <span class="mi">16</span><span class="p">,</span> \
				<span class="s1">&#39;Liquid phase must have 15 or 16 endmember components.&#39;</span>

		<span class="c1">###########################</span>
		<span class="c1"># Calculation starts here #</span>
		<span class="c1">###########################</span>

		<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
			<span class="c1"># Special case: adjust ferric-ferrous of silicate liquid</span>
			<span class="k">if</span> <span class="n">con_deltaNNO</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">omni_moles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
				<span class="n">omni_oxide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kc_ferric_ferrous</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">omni_moles</span><span class="p">,</span>
					<span class="n">compute</span><span class="o">=</span><span class="s1">&#39;oxides&#39;</span><span class="p">,</span> <span class="n">deltaNNO</span><span class="o">=</span><span class="n">con_deltaNNO</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">omni_moles</span><span class="p">,</span> <span class="n">oxide_res</span> <span class="o">=</span> \
					<span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">][</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">calc_endmember_comp</span><span class="p">(</span>
						<span class="n">mol_oxide_comp</span><span class="o">=</span><span class="n">omni_oxide</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;intrinsic&#39;</span><span class="p">,</span>
						<span class="n">output_residual</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">state</span><span class="o">.</span><span class="n">set_phase_comp</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">,</span> <span class="n">omni_moles</span><span class="p">)</span>

			<span class="c1"># Obtain chemical potentials of elements in the system</span>
			<span class="n">mu_elm</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_omni_phase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

			<span class="c1"># If a phase has zero moles, calculate its chemical affinity</span>
			<span class="n">A_min</span><span class="p">,</span><span class="n">A_min_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_sat_state_affinities</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
				<span class="n">mu_elm</span><span class="p">,</span> <span class="n">omni_phase</span><span class="o">=</span><span class="n">omni_phase</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>

			<span class="c1"># if a phase is supersaturated, add it to the system</span>
			<span class="k">if</span> <span class="n">A_min</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_once_quad_pass</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Stable phase assemblage computed. Exiting.&#39;</span><span class="p">)</span>
				<span class="k">break</span>
			<span class="n">force_once_quad_pass</span> <span class="o">=</span> <span class="kc">False</span>

			<span class="k">if</span> <span class="n">A_min</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">require_quad_pass_before_phase_addition</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Adding phase &#39;</span><span class="p">,</span> <span class="n">A_min_name</span><span class="p">,</span>
						<span class="s1">&#39; to system. with affinity = &#39;</span><span class="p">,</span> <span class="n">A_min</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Add:&#39;</span><span class="p">,</span> <span class="n">A_min_name</span><span class="p">)</span>
				<span class="n">okay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_phase_to_system</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">A_min_name</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">okay</span> <span class="ow">and</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... phase successfully added.&#39;</span><span class="p">)</span>
				<span class="k">elif</span> <span class="ow">not</span> <span class="n">okay</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... phase addition unsuccessful. Exiting.&#39;</span><span class="p">)</span>
					<span class="k">break</span>

			<span class="n">require_quad_pass_before_phase_addition</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">quad_loop</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">quad_iter</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">quad_energies</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">while</span> <span class="n">quad_loop</span><span class="p">:</span>
				<span class="c1"># Deal with equality/inequality constraints</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">quad_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">					Create projection operator to strip columns from to</span>
<span class="sd">					account for missing composition variables</span>
<span class="sd">					&quot;&quot;&quot;</span>
					<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
					<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
							<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
							<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_nz&#39;</span><span class="p">],(</span><span class="n">nc</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
					<span class="n">P_nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
						<span class="n">P_nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">P_nz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
						<span class="n">P_nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">P_nz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
					<span class="n">P_nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">P_nz</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
					<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">					now remove zero columns of the projection matrix</span>
<span class="sd">					taken from: https://stackoverflow.com/questions/51769962/</span>
<span class="sd">					find-and-delete-all-zero-columns-from-numpy-array-using-fancy-indexing/51770365</span>
<span class="sd">					&quot;&quot;&quot;</span>
					<span class="n">P_nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">P_nz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">P_nz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Zero element projection matrix&#39;</span><span class="p">,</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">P_nz</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">P_nz</span><span class="p">)</span>
					<span class="n">A</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">,</span> <span class="n">R11</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_a_and_qr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
						<span class="n">P_nz</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Exit constraint matrix and RQ decomposition.&#39;</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... df&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... Q1&#39;</span><span class="p">,</span> <span class="n">Q1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="n">Q1</span><span class="p">)</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">Q1</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... Q2&#39;</span><span class="p">,</span> <span class="n">Q2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="n">Q2</span><span class="p">)</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">Q2</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... R11&#39;</span><span class="p">,</span> <span class="n">R11</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="n">R11</span><span class="p">)</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">R11</span><span class="p">)</span>

				<span class="c1"># Compute gradient and Hessian</span>
				<span class="n">g</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="n">H</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">d2Gdn2</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Gradient&#39;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">g</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Hessian&#39;</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">g</span><span class="p">,</span><span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_augment_gradient_hessian</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span>
						<span class="n">debug</span><span class="p">)</span>
					<span class="n">l_mult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_lagrange_multipliers</span><span class="p">(</span>
						<span class="n">g</span> <span class="k">if</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span>
							<span class="n">P_nz</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">g</span><span class="p">),</span> <span class="n">A</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
					<span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_augment_hessian_return_wronskian</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span>
						<span class="n">l_mult</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Final Hessian&#39;</span><span class="p">,</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
				<span class="c1"># projection gradient and Hessian into the null space</span>
				<span class="k">if</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
					<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P_nz</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
					<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P_nz</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">P_nz</span><span class="p">))</span>
				<span class="n">g_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
				<span class="n">H_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="n">Q2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Projected gradient:&#39;</span><span class="p">,</span> <span class="n">g_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">g_p</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Projected Hessian:&#39;</span><span class="p">,</span> <span class="n">H_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">H_p</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_print_matrix_repr</span><span class="p">(</span><span class="n">H_p</span><span class="p">)</span>

				<span class="c1"># Exit if the problem is trivial</span>
				<span class="k">if</span> <span class="n">H_p</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">g_p</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">quad_normal_exit</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">break</span>

				<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">				Solve the null space problem. Could use self.eps_rank here for</span>
<span class="sd">				the condition number, but the default value computed setting</span>
<span class="sd">				rcond=None in linalg.lstsq is usually optimal</span>
<span class="sd">				&quot;&quot;&quot;</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_numpy_lstsq</span><span class="p">:</span>
					<span class="n">result</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">H_p</span><span class="p">,</span> <span class="o">-</span><span class="n">g_p</span><span class="p">,</span>
						<span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Quadratic solution, SVD algorithm, rank&#39;</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... residuals:&#39;</span><span class="p">)</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... S:&#39;</span><span class="p">)</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="o">-</span><span class="n">g_p</span><span class="p">,</span> <span class="n">H_p</span><span class="p">,</span> <span class="n">hasconst</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;qr&#39;</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Quadratic solution, QR algorithm.&#39;</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
							<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
								<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">,(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">Q2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">P_nz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
					<span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P_nz</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Re-inflated delta n solution vector:&#39;</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
						<span class="k">if</span> <span class="n">n2</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:10.3e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n2</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
				<span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n2</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Norm: &#39;</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="s1">&#39;Op, sub-Op:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_quad_optimal</span><span class="p">,</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">eps_quad_suboptimal</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Quad (</span><span class="si">{0:03d}</span><span class="s1">) norm: </span><span class="si">{1:20.13e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quad_iter</span><span class="p">,</span>
						<span class="n">norm</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">norm</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_quad_optimal</span><span class="p">:</span>
					<span class="n">quad_normal_exit</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">break</span>
				<span class="k">elif</span> <span class="n">quad_iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_quad_iters</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">norm</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_quad_suboptimal</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39; Quadratic norm is acceptable, but not optimal.&#39;</span><span class="p">)</span>
						<span class="n">quad_normal_exit</span> <span class="o">=</span> <span class="kc">True</span>
						<span class="k">break</span>

				<span class="c1"># Perform a linear search along the quadratic search direction</span>
				<span class="n">n_ref</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
							<span class="n">n_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">:</span>
						<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
							<span class="n">n_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lagrange_moles</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
						<span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
							<span class="n">n_ref</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span> <span class="k">else</span> <span class="n">p</span><span class="p">)</span>
						<span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="n">n_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_ref</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Reference phase/component moles&#39;</span><span class="p">,</span> <span class="n">n_ref</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
						<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">n_ref</span><span class="p">))</span>
					<span class="nb">print</span> <span class="p">(</span><span class="n">n_ref</span><span class="p">)</span>

				<span class="c1"># Potential function to be minimized</span>
				<span class="k">def</span> <span class="nf">linear_search</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
					<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
							<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
								<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
								<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
							<span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
								<span class="k">assert</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span>
									<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]),</span> <span class="s1">&#39;Bounds failure for &#39;</span> <span class="o">+</span> <span class="n">name</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
						<span class="n">t</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
						<span class="n">p</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
						<span class="n">tp_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_apply_non_linear_constraints</span><span class="p">(</span><span class="n">tp_l</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
						<span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tp_l</span><span class="p">)</span>
					<span class="n">result</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">G</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">dgdn</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dGdn</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">element_basis</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
						<span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_list</span><span class="p">:</span>
							<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
								<span class="n">moles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">moles_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
								<span class="n">contrib</span> <span class="o">=</span> <span class="n">moles</span><span class="o">*</span><span class="p">(</span>
									<span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">dgdn</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
								<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
									<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... linear search. &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
									<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;ref = &#39;</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
									<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;index = &#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;i = &#39;</span><span class="p">,</span><span class="n">row</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
									<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;moles = &#39;</span><span class="p">,</span> <span class="n">moles</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
									<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;contrib &#39;</span><span class="p">,</span> <span class="n">contrib</span><span class="p">)</span>
								<span class="n">result</span> <span class="o">-=</span> <span class="n">contrib</span>
								<span class="bp">self</span><span class="o">.</span><span class="n">lagrange_moles</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">moles</span>
								<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
								<span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
							<span class="n">result</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">dGdT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
						<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
							<span class="n">result</span> <span class="o">-=</span> <span class="n">p</span><span class="o">*</span><span class="n">state</span><span class="o">.</span><span class="n">dGdP</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">result</span>

				<span class="c1"># Determine domain bounds on the potential linear search</span>
				<span class="k">def</span> <span class="nf">test_bounds_for_search</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
					<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
						<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
							<span class="n">nc</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]</span>
							<span class="n">moles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
							<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
								<span class="n">moles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
								<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
							<span class="k">if</span> <span class="n">nc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
								<span class="k">if</span> <span class="n">moles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
									<span class="k">return</span> <span class="kc">False</span>
							<span class="k">else</span><span class="p">:</span>
								<span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">test_endmember_comp</span><span class="p">(</span><span class="n">moles</span><span class="p">):</span>
									<span class="k">return</span> <span class="kc">False</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
						<span class="n">t_est</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">t_est</span> <span class="o">&lt;</span> <span class="mf">773.15</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t_est</span> <span class="o">&gt;</span> <span class="mf">2773.15</span><span class="p">):</span>
							<span class="k">return</span> <span class="kc">False</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
						<span class="n">p_est</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">p_est</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p_est</span> <span class="o">&gt;</span> <span class="mf">100000.0</span><span class="p">):</span>
							<span class="k">return</span> <span class="kc">False</span>
						<span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
					<span class="k">return</span> <span class="kc">True</span>

				<span class="n">step_max</span> <span class="o">=</span> <span class="mf">2.0</span>
				<span class="k">while</span> <span class="ow">not</span> <span class="n">test_bounds_for_search</span><span class="p">(</span><span class="n">step_max</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span>
					<span class="n">n2</span><span class="p">):</span>
					<span class="n">step_max</span> <span class="o">*=</span> <span class="mf">0.9</span>
					<span class="k">if</span> <span class="n">step_max</span> <span class="o">&lt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
						<span class="k">break</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Maximum linear step search length; &#39;</span><span class="p">,</span> <span class="n">step_max</span><span class="p">)</span>

				<span class="n">step_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span>
				<span class="k">while</span> <span class="ow">not</span> <span class="n">test_bounds_for_search</span><span class="p">(</span><span class="n">step_min</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span>
					<span class="n">n2</span><span class="p">):</span>
					<span class="n">step_min</span> <span class="o">*=</span> <span class="mf">0.9</span>
					<span class="k">if</span> <span class="n">step_min</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
						<span class="k">break</span>
				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Minimum linear step search length; &#39;</span><span class="p">,</span> <span class="n">step_min</span><span class="p">)</span>

				<span class="n">result</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">linear_search</span><span class="p">,</span>
					<span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">step_min</span><span class="p">,</span><span class="n">step_max</span><span class="p">),</span>
					<span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">n2</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Bounded&#39;</span><span class="p">,</span>
					<span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_linear_iters</span><span class="p">,</span>
						<span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="n">debug</span><span class="p">,</span> <span class="s1">&#39;xatol&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">eps_linear</span><span class="p">})</span>
				<span class="n">step_val</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
					<span class="p">)</span> <span class="k">else</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
				<span class="n">func_val</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
					<span class="p">)</span> <span class="k">else</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>
				<span class="n">quad_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func_val</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39; Lin (</span><span class="si">{0:03d}</span><span class="s1">) step: </span><span class="si">{1:20.13e}</span><span class="s1"> func: </span><span class="si">{2:20.13e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
						<span class="n">result</span><span class="o">.</span><span class="n">nfev</span><span class="p">,</span> <span class="n">step_val</span><span class="p">,</span> <span class="n">func_val</span><span class="p">))</span>
				<span class="c1"># insure that state is evaluated at the last estimate for step</span>
				<span class="n">linear_search</span><span class="p">(</span><span class="n">step_val</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
					<span class="n">t_est</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">step_val</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
					<span class="n">p_est</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step_val</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">t_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_est</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">t_est</span>
					<span class="n">p</span> <span class="o">=</span> <span class="n">p_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_est</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">p_est</span>
				<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
					<span class="n">t_est</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step_val</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">t_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_est</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">t_est</span>
				<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
					<span class="n">p_est</span> <span class="o">=</span> <span class="n">n_ref</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step_val</span><span class="o">*</span><span class="n">n2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
					<span class="n">p</span> <span class="o">=</span> <span class="n">p_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_est</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">p_est</span>

				<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Optimal linear search length:&#39;</span><span class="p">,</span> <span class="n">step_val</span><span class="p">)</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Optimal function value&#39;</span><span class="p">,</span> <span class="n">func_val</span><span class="p">)</span>
					<span class="n">state</span><span class="o">.</span><span class="n">print_state</span><span class="p">()</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Approximate corrected temperature&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Approximate corrected pressure&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">blk_cmp</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_elements</span><span class="p">()</span>
					<span class="n">diff</span> <span class="o">=</span> <span class="n">blk_cmp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_lagrange_moles</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CTf</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Change in bulk composition:&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">diff</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;lagrange_moles&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lagrange_moles</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lagrange_moles</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
					<span class="n">tp_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_apply_non_linear_constraints</span><span class="p">(</span><span class="n">tp_l</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
					<span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tp_l</span><span class="p">)</span>
					<span class="n">state</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">t</span>
					<span class="n">state</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="n">p</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Final corrected temperature&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Final corrected pressure&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">con_deltaNNO</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">omni_moles</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">][</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span>
					<span class="n">omni_oxide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kc_ferric_ferrous</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">omni_moles</span><span class="p">,</span>
						<span class="n">compute</span><span class="o">=</span><span class="s1">&#39;oxides&#39;</span><span class="p">,</span> <span class="n">deltaNNO</span><span class="o">=</span><span class="n">con_deltaNNO</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
					<span class="n">omni_moles</span><span class="p">,</span> <span class="n">oxide_res</span> <span class="o">=</span> \
						<span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="s1">&#39;Liquid&#39;</span><span class="p">][</span><span class="s1">&#39;obj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">calc_endmember_comp</span><span class="p">(</span>
							<span class="n">mol_oxide_comp</span><span class="o">=</span><span class="n">omni_oxide</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;intrinsic&#39;</span><span class="p">,</span>
							<span class="n">output_residual</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
					<span class="n">state</span><span class="o">.</span><span class="n">set_phase_comp</span><span class="p">(</span><span class="n">omni_phase</span><span class="p">,</span> <span class="n">omni_moles</span><span class="p">)</span>

				<span class="n">quad_iter</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="n">quad_iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_quad_iters</span><span class="p">:</span>
					<span class="n">quad_normal_exit</span> <span class="o">=</span> <span class="kc">False</span>
					<span class="k">break</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quad_energies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">equil_linear_min</span><span class="p">:</span>
					<span class="n">last_three</span> <span class="o">=</span> <span class="n">quad_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
					<span class="n">average</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_three</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">last_three</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">last_three</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mf">3.0</span>
					<span class="n">sumsqr</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_three</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">average</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">last_three</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span>
						<span class="n">average</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">last_three</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">average</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Quad pot:&#39;</span><span class="p">,</span> <span class="n">quad_energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Ave:&#39;</span><span class="p">,</span>
							<span class="n">average</span><span class="p">,</span> <span class="s1">&#39;SS:&#39;</span><span class="p">,</span> <span class="n">sumsqr</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="n">last_three</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sumsqr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">average</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">eps_minimal_energy</span><span class="p">:</span>
						<span class="n">quad_normal_exit</span> <span class="o">=</span> <span class="kc">True</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Minimal energy termination of quadratic loop.&#39;</span><span class="p">)</span>
						<span class="k">break</span>

				<span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">mol_p</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">tot_moles_phase</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">mol_p</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">mol_p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">moles_out</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">_remove_phase_from_system</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Remove:&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;----------&#39;</span><span class="p">)</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;--&gt; Phase&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;removed from the system.&#39;</span><span class="p">)</span>
							<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;----------&#39;</span><span class="p">)</span>
						<span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_1&#39;</span><span class="p">:</span>
							<span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
						<span class="n">quad_iter</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="c1"># termination of quad_loop</span>
			<span class="k">if</span> <span class="n">quad_normal_exit</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">result</span><span class="p">,</span> <span class="n">result_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_phase_stability</span><span class="p">(</span><span class="n">state</span><span class="p">,</span>
						<span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">result</span><span class="p">:</span>
						<span class="k">break</span>
				<span class="k">if</span> <span class="n">result</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Unmixing:&#39;</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Phase separation found for&#39;</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;   composition:&#39;</span><span class="p">,</span> <span class="n">result_comp</span><span class="p">)</span>
					<span class="n">new_phase</span> <span class="o">=</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39;_1&#39;</span>
					<span class="n">ident</span> <span class="o">=</span> <span class="mi">1</span>
					<span class="k">while</span> <span class="n">new_phase</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">:</span>
						<span class="n">ident</span> <span class="o">+=</span> <span class="mi">1</span>
						<span class="n">new_phase</span> <span class="o">=</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
					<span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">new_phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
					<span class="n">entry</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">new_phase</span><span class="p">]</span>
					<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;moles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">])</span>
					<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">])</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;nc&#39;</span><span class="p">]):</span>
						<span class="n">entry</span><span class="p">[</span><span class="s1">&#39;mole_frac&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_comp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
					<span class="n">state</span><span class="o">.</span><span class="n">_c_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
						<span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">_c_matrix</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">c_matrix_for_phase</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)))</span>
					<span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Old phase dictionary ...&#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">phase_name</span><span class="p">])</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;New phase dictionary ...&#39;</span><span class="p">)</span>
						<span class="nb">print</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">phase_d</span><span class="p">[</span><span class="n">new_phase</span><span class="p">])</span>
					<span class="n">okay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_phase_to_system</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">new_phase</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">okay</span> <span class="ow">and</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... phase successfully added.&#39;</span><span class="p">)</span>
					<span class="k">elif</span> <span class="ow">not</span> <span class="n">okay</span><span class="p">:</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;... phase addition unsuccessful. Exiting.&#39;</span><span class="p">)</span>
					<span class="n">force_once_quad_pass</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;No check made for phase separation.&#39;</span><span class="p">)</span>
		<span class="c1"># termination of phase saturation loop</span>
		<span class="k">return</span> <span class="n">state</span></div></div>

<div class="viewcode-block" id="MELTSmodel"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel">[docs]</a><span class="k">class</span> <span class="nc">MELTSmodel</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;Class for creating an instance of the Equilibrate PhaseObjC class that is tailored to</span>
<span class="sd">	calculate equilibrium phase assemblages using one of the MELTS calibrations.</span>

<span class="sd">	Valid initializers are version=&#39;1.0.2&#39;, &#39;1.1.0&#39;, &#39;1.2.0&#39;, &#39;5.6.1&#39;, &#39;DEW&#39;, &#39;OnlyDEW&#39;</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0.2&#39;</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;1.0.2&#39;</span><span class="p">:</span>
			<span class="n">MELTSclass</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;EquilibrateUsingMELTSv102&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;1.1.0&#39;</span><span class="p">:</span>
			<span class="n">MELTSclass</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;EquilibrateUsingMELTSv110&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;1.2.0&#39;</span><span class="p">:</span>
			<span class="n">MELTSclass</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;EquilibrateUsingMELTSv120&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;5.6.1&#39;</span><span class="p">:</span>
			<span class="n">MELTSclass</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;EquilibrateUsingpMELTSv561&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;DEW&#39;</span><span class="p">:</span>
			<span class="n">MELTSclass</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;EquilibrateUsingMELTSwithDEW&#39;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;OnlyDEW&#39;</span><span class="p">:</span>
			<span class="n">MELTSclass</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;EquilibrateUsingMELTSandOnlyDEW&#39;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Unknown version of MELTS stipulated&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span> <span class="o">=</span> <span class="n">MELTSclass</span><span class="o">.</span><span class="n">alloc</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setDebugS_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setDebugV_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

		<span class="n">oxide_names_NSArray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">oxideNames</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">noxides</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oxide_names_NSArray</span><span class="p">)</span> <span class="c1"># was .count converted to len() in going from 0.2.7 -&gt; 0.2.10</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">oxide_names_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">oxide_names_NSArray</span><span class="o">.</span><span class="n">objectAtIndex_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noxides</span><span class="p">)]</span>

		<span class="n">phase_names_NSArray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">phaseNames</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nphases</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_names_NSArray</span><span class="p">)</span> <span class="c1"># was .count converted to len() in going from 0.2.7 -&gt; 0.2.10</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase_names_NSArray</span><span class="o">.</span><span class="n">objectAtIndex_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">)]</span>

		<span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_NUMERIC</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MELTSmodel.print_default_settings"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.print_default_settings">[docs]</a>	<span class="k">def</span> <span class="nf">print_default_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Prints list of options and tolerance settings for algorithm.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">option_settings</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s1">&#39;PPOPTIONS_DISTRIBUTION&#39;</span><span class="p">:</span>     <span class="p">(</span><span class="s1">&#39;Make failure in element redistribution non-fatal&#39;</span><span class="p">,</span>       <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_DISTRIBUTION</span><span class="p">),</span>
			<span class="s1">&#39;PPOPTIONS_CHEM_POTENTIAL&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="s1">&#39;Make chemical potential recast errors non-fatal&#39;</span><span class="p">,</span>        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_CHEM_POTENTIAL</span><span class="p">),</span>
			<span class="s1">&#39;PPOPTIONS_RANK&#39;</span><span class="p">:</span>             <span class="p">(</span><span class="s1">&#39;Make rank deficient quadratic solutions fatal&#39;</span><span class="p">,</span>          <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_RANK</span><span class="p">),</span>
			<span class="s1">&#39;PPOPTIONS_ZERO_LINEAR&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="s1">&#39;Make &quot;zero&quot; steplength linear searches non-fatal&#39;</span><span class="p">,</span>       <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_ZERO_LINEAR</span><span class="p">),</span>
			<span class="s1">&#39;PPOPTIONS_QUAD_ITERS&#39;</span><span class="p">:</span>       <span class="p">(</span><span class="s1">&#39;Terminate if quadratic iterations ever exceed maximum&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_QUAD_ITERS</span><span class="p">),</span>
			<span class="s1">&#39;PPOPTIONS_FORCE_COMPONENTS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Never zero a component concentration in a system phase&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_FORCE_COMPONENTS</span><span class="p">),</span>
			<span class="s1">&#39;PPOPTIONS_DETECT_MINIMAL&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="s1">&#39;Prevent minimal energy test for convergence&#39;</span><span class="p">,</span>            <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPOPTIONS_DETECT_MINIMAL</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">option_settings</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">option_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;60.60s}</span><span class="s2"> </span><span class="si">{1:&lt;30.30s}</span><span class="s2"> </span><span class="si">{2:1d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

		<span class="n">tolerance_settings</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s1">&#39;PPPARAMETERS_CHEM_POTENTIAL&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Residual tolerance for acceptable recasting of phase chemical potentials to those of the elements&#39;</span><span class="p">,</span> \
				<span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_CHEM_POTENTIAL</span><span class="p">)),</span>
			<span class="s1">&#39;PPPARAMETERS_RANK&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Tolerance (relative to Hessian norm) for computation of pseudorank during quadratic search&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_RANK</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_QUAD_OPTIMAL&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Residual norm relative tolerance for optimal quadratic convergence&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_QUAD_OPTIMAL</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_QUAD_SUBOPTIMAL&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Residual norm relative tolerance for sub-optimal quadratic convergence&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_QUAD_SUBOPTIMAL</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_QUAD_MAX_ITERS&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Maximal number of quadratic iterations&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_QUAD_MAX_ITERS</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_LINEAR_MAX_ITERS&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Maximal number of linear search iterations&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_LINEAR_MAX_ITERS</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_LINEAR_RELTEST&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Relative convergence criteria for estimation of the minimum during a linear search step&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_LINEAR_RELTEST</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_LINEAR_MIN_STEPLENGTH&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Minimum allowed steplength in a linear search step&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_LINEAR_MIN_STEPLENGTH</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_COMPONENT_MINIMUM&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Minimum molar concentration of a component in a phase (absolute value)&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_COMPONENT_MINIMUM</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_MASSOUT&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Phase mass that triggers removal of that phase from the system&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_MASSOUT</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_MOLESIN&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Moles of phase added to system on detection of phase saturation&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_MOLESIN</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_LINEAR_MINIMAL&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Number of quadratic iterations over which to average potential for minimal energy convergence test&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_LINEAR_MINIMAL</span><span class="p">),</span>
			<span class="s1">&#39;PPPARAMETERS_CYCLES_MAX&#39;</span><span class="p">:</span> \
			<span class="p">(</span><span class="s1">&#39;Maximal number of phase inclusion/phase removal cycles permitted&#39;</span><span class="p">,</span> \
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">PPPARAMETERS_CYCLES_MAX</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tolerance_settings</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">tolerance_settings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;70.70s}</span><span class="s2"> </span><span class="si">{1:&lt;30.30s}</span><span class="s2"> </span><span class="si">{2:13.6e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="MELTSmodel.set_debug_state"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_debug_state">[docs]</a>	<span class="k">def</span> <span class="nf">set_debug_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debugS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debugV</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Sets debug output level for Equilibrate class and subclasses</span>

<span class="sd">		Parameters</span>
<span class="sd">		==========</span>
<span class="sd">		debugS : boolean, optional</span>
<span class="sd">			Sets on or off low level debug output. Default is off (False).</span>
<span class="sd">		debugV : boolean, optional</span>
<span class="sd">			Sets on or off high level debug output. Default is off (False).</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">debugS</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setDebugS_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setDebugS_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">debugV</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setDebugV_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setDebugV_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.get_oxide_names"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_oxide_names">[docs]</a>	<span class="k">def</span> <span class="nf">get_oxide_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Retrieves a list of system oxides</span>

<span class="sd">		Composition of the system can be expressed in terms of these oxides.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		array : strings</span>
<span class="sd">			An array of strings naming system components in terms of oxides</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_names_a</span></div>

<div class="viewcode-block" id="MELTSmodel.get_phase_names"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_phase_names">[docs]</a>	<span class="k">def</span> <span class="nf">get_phase_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Retrieves a list of system phases</span>

<span class="sd">		Names of phases known to the system</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		array : strings</span>
<span class="sd">			An array of strings naming system phases</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span></div>

<div class="viewcode-block" id="MELTSmodel.get_phase_inclusion_status"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_phase_inclusion_status">[docs]</a>	<span class="k">def</span> <span class="nf">get_phase_inclusion_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Retrieves a dictionary of the inclusion status of each phase</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dict : dictionary</span>
<span class="sd">			A dictionary of boolean values indicating the inclusion status of each phase</span>
<span class="sd">			(key) known to the system</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">state_NSdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">getPermissablePhasesState</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">state_NSdict</span><span class="o">.</span><span class="n">valueForKey_</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="c1">#.boolValue removed in going from 0.2.7 -&gt; 0.2.10</span>
			<span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">return</span> <span class="nb">dict</span></div>

<div class="viewcode-block" id="MELTSmodel.set_phase_inclusion_status"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_phase_inclusion_status">[docs]</a>	<span class="k">def</span> <span class="nf">set_phase_inclusion_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_d</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Sets the inclusion status of specified phases</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		status_d : dictionary</span>
<span class="sd">			A dictionary of phase name keys and boolean values. True sets inclusion, and</span>
<span class="sd">			False prevents inclusion of a phase in the equilibrium assemblage.  Note that</span>
<span class="sd">			the chemical affinity of the phase will still be calculated even if the</span>
<span class="sd">			inclusion level is set to False.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">state_NSdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">getPermissablePhasesState</span><span class="p">()</span>
		<span class="n">nsarray_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSMutableArray&#39;</span><span class="p">)</span>
		<span class="n">nsarray</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nphases</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">state_NSdict</span><span class="o">.</span><span class="n">valueForKey_</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="c1">#.boolValue removed in going from 0.2.7 -&gt; 0.2.10</span>
			<span class="k">if</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">status_d</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">status_d</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">nsarray</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool_</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setPermissablePhasesState_</span><span class="p">(</span><span class="n">nsarray</span><span class="p">)</span></div>


<div class="viewcode-block" id="MELTSmodel.set_bulk_composition"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_bulk_composition">[docs]</a>	<span class="k">def</span> <span class="nf">set_bulk_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oxide_d</span><span class="o">=</span><span class="p">{}):</span>
		<span class="sd">&quot;&quot;&quot;Sets the bulk composition of the system</span>

<span class="sd">		This function first tests if the composition is feasible before setting the bulk</span>
<span class="sd">		composition of the system.  You should check to make sure that the composition is</span>
<span class="sd">		feasible before proceeding.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		oxide_d : a python dictionary</span>
<span class="sd">			A dictionary of oxide names and values, e.g. {&#39;SiO2&#39;:77.8, &#39;Al2O3&#39;:12.0, ..., &#39;H2O&#39;:3.74}</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		boolean : True or False</span>

<span class="sd">			True if the composition is feasible, in which case the composition of the</span>
<span class="sd">			system is defined.</span>

<span class="sd">			False if the composition is infeasible, in which case the composition of the</span>
<span class="sd">			system is undefined.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Feasibility call has yet to be implemented: (Objective-C method call:)</span>
<span class="sd">		-(BOOL)compositionIsFeasible:(NSArray \*)compositionInWtPercentOxides forSolution:(id &lt;SolutionPhaseProtocol&gt;)omniComponentPhase;</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">wt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">noxides</span><span class="p">)()</span>
		<span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">wt</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noxides</span><span class="p">):</span>
			<span class="n">wt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">oxide_d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxide_names_a</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="n">wt</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setComposition_</span><span class="p">(</span><span class="n">wt</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.set_temperature"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_temperature">[docs]</a>	<span class="k">def</span> <span class="nf">set_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_c</span><span class="o">=</span><span class="mf">800.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Sets the temperature of the system and reinitializes a calculation sequence</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t_c : float optional</span>
<span class="sd">			Float value to set the system temperature in degrees centigrade. Default is 800 °C.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t_c</span> <span class="o">+</span> <span class="mf">273.15</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setTemperature_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.set_entropy"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_entropy">[docs]</a>	<span class="k">def</span> <span class="nf">set_entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Sets the entropy of the system and reinitializes a calculation sequence</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		s : float</span>
<span class="sd">			Float value to set the system entropy in J/K.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">entropy</span> <span class="o">=</span> <span class="n">s</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setEntropy_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entropy</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.set_pressure"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_pressure">[docs]</a>	<span class="k">def</span> <span class="nf">set_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_mpa</span><span class="o">=</span><span class="mf">200.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Sets the pressure of the system and reinitializes a calculation sequence</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		p_mpa : float optional</span>
<span class="sd">			Float value to set the system pressure in mega-Pascals. Default is 200 MPa.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p_mpa</span><span class="o">*</span><span class="mf">10.0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setPressure_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.set_volume"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.set_volume">[docs]</a>	<span class="k">def</span> <span class="nf">set_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Sets the volume of the system and reinitializes a calculation sequence</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		v : float</span>
<span class="sd">			Float value to set the system volume in J/bar</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">v</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setVolume_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.get_object_for_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_object_for_phase">[docs]</a>	<span class="k">def</span> <span class="nf">get_object_for_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Retrieve an object instance for the named phase.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		phase_name: string</span>
<span class="sd">			Name of phase</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		object: instance of a phase class</span>
<span class="sd">			null if the phase is not in the stable assemblage</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">phase_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">dictionaryOfPhasesInSystem</span> <span class="c1"># dictionary of EquilibrateStatePhase instances</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phase_list</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">phase_list</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">phaseClassInstance</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MELTSmodel.get_properties_of_DEWFluid"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_properties_of_DEWFluid">[docs]</a>	<span class="k">def</span> <span class="nf">get_properties_of_DEWFluid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">property_name</span><span class="o">=</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Retrieves a dictionary of properties of the specified type</span>

<span class="sd">		DEWFluid must exist in the equilibrium assemblage; otherwise an empty dictionary</span>
<span class="sd">		is returned.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		property_name: string, optional</span>
<span class="sd">			&#39;species&#39; (default) returns a dictionary of species mole fractions in the</span>
<span class="sd">			equilibrated solution.</span>

<span class="sd">			&#39;mu&#39; returns a dictionary of species chemical potentials in the equilibrated</span>
<span class="sd">			solution.</span>

<span class="sd">			&#39;activity&#39; returns a dictionary of species activities in the equilibrated</span>
<span class="sd">			solution.</span>

<span class="sd">		T : float optional</span>
<span class="sd">			Temperature in degrees centigrade (default is 1000°C)</span>
<span class="sd">		P : float optional</span>
<span class="sd">			Pressure in bars (default is 1000 bars)</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dictionary: a python dictionary</span>
<span class="sd">			Keys are species names (strings).</span>

<span class="sd">			Values are species concentrations in mole fraction, or chemical potential,</span>
<span class="sd">			or thermodynamic activity, depending on the value of ``property_name``.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">phase_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">dictionaryOfPhasesInSystem</span> <span class="c1"># dictionary of EquilibrateStatePhase instances</span>
		<span class="k">if</span> <span class="s1">&#39;DEWFluid&#39;</span> <span class="ow">in</span> <span class="n">phase_list</span><span class="p">:</span>
			<span class="n">DEW_object</span> <span class="o">=</span> <span class="n">phase_list</span><span class="p">[</span><span class="s1">&#39;DEWFluid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">phaseClassInstance</span> <span class="c1"># instantiated class</span>
			<span class="n">elements</span> <span class="o">=</span> <span class="n">phase_list</span><span class="p">[</span><span class="s1">&#39;DEWFluid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bulkCompositionInElements</span>
			<span class="n">moles</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">convertElementsToMoles_</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">pointerToDouble</span><span class="p">())</span><span class="o">.</span><span class="n">pointerToDouble</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;species&#39;</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">getSpeciesMoleFractionsForBulkComposition_aT_andP_</span><span class="p">(</span><span class="n">moles</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span>
				<span class="n">ns</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">numberOfSolutionSpecies</span><span class="p">()</span>
				<span class="n">mu</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">chemicalPotentialsOfSpeciesFromMolesOfComponents_andT_andP_</span><span class="p">(</span><span class="n">moles</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">pointerToDouble</span><span class="p">()</span>
				<span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ns</span><span class="p">):</span>
					<span class="n">name</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">nameOfSolutionSpeciesAtIndex_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
					<span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="k">return</span> <span class="n">result</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;activity&#39;</span><span class="p">:</span>
				<span class="n">ns</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">numberOfSolutionSpecies</span><span class="p">()</span>
				<span class="n">activity</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">activitiesOfSpeciesFromMolesOfComponents_andT_andP_</span><span class="p">(</span><span class="n">moles</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">pointerToDouble</span><span class="p">()</span>
				<span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ns</span><span class="p">):</span>
					<span class="n">name</span> <span class="o">=</span> <span class="n">DEW_object</span><span class="o">.</span><span class="n">nameOfSolutionSpeciesAtIndex_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
					<span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">activity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
				<span class="k">return</span> <span class="n">result</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="MELTSmodel.equilibrate_tp"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.equilibrate_tp">[docs]</a>	<span class="k">def</span> <span class="nf">equilibrate_tp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_a</span><span class="p">,</span> <span class="n">P_a</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Determines the equilibrium phase assemblage at a temperature-pressure point</span>
<span class="sd">		or along a series of T-P points.</span>

<span class="sd">		The bulk composition of the system must first be set by calling the function:</span>

<span class="sd">		``set_bulk_composition``</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		t_a : float or numpy array of floats</span>
<span class="sd">			Temperature in degrees centigrade.  Either a scaler values or a numpy array</span>
<span class="sd">			of float values must be provided.</span>
<span class="sd">		p_a : float or numpy array of floats</span>
<span class="sd">			Pressure in mega-Pascals. Either a scaler values or a numpy array of float</span>
<span class="sd">			values must be provided.</span>

<span class="sd">			NOTE: If both ``t_a`` and ``p_a`` are arrays, then they must both be the</span>
<span class="sd">			same length.</span>
<span class="sd">		initialize : bool, optional</span>
<span class="sd">			True if this is a T-, P-point that starts a sequence of calculations.</span>

<span class="sd">			False if this is a continuation T-,P-pair or series of pairs.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		output_a : an array of tuples</span>
<span class="sd">			tuple = (status, T, P, xmlout):</span>

<span class="sd">			* **status** is a string indicating the status of the calculation:</span>
<span class="sd">			  success/failiure, Reason for success/failure.</span>

<span class="sd">			* **T** is a float value corresponding to the temperature in degrees centigrade.</span>

<span class="sd">			* **P** is a float value corresponding to the pressure in mega-Pascals.</span>

<span class="sd">			* **xmlout** is an xml document tree of the type xml.etree.ElementTree. The</span>
<span class="sd">			  xml tree contains information on the masses and abundances of all phases in</span>
<span class="sd">			  the system. ``xmlout`` is utilized as input for a number of functions in this</span>
<span class="sd">			  package that retrieve properties of the equilibrium assemblage.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		The ``xmlout`` document tree will be expanded to include thermodynamic properties</span>
<span class="sd">		of the phases and chemical affinities of phases not present in the equilibrium</span>
<span class="sd">		assemblage.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">T_a</span><span class="p">,</span> <span class="n">P_a</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fill_array</span><span class="p">(</span><span class="n">T_a</span><span class="p">,</span> <span class="n">P_a</span><span class="p">)</span>
		<span class="n">output_a</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">T</span><span class="p">,</span><span class="n">P</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">T_a</span><span class="p">,</span><span class="n">P_a</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setTemperature_</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setPressure_</span><span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="mf">10.0</span><span class="p">)</span>

				<span class="n">nsarray_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSMutableArray&#39;</span><span class="p">)</span>
				<span class="n">nsarraykeys</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;ordinate&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;abscissa&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;imposeBuffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;bufferOffset&#39;</span><span class="p">))</span>

				<span class="n">nsarrayvalues</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Temperature (°C)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Pressure (MPa)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool_</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;QFM&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Double initialization does not work (?)</span>

				<span class="n">nsdict_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSDictionary&#39;</span><span class="p">)</span>
				<span class="n">nsdict</span> <span class="o">=</span> <span class="n">nsdict_cls</span><span class="o">.</span><span class="n">dictionaryWithObjects_forKeys_</span><span class="p">(</span><span class="n">nsarrayvalues</span><span class="p">,</span> <span class="n">nsarraykeys</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setCalculationOptions_</span><span class="p">(</span><span class="n">nsdict</span><span class="p">)</span>

			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementTemperature_</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementPressure_</span><span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="mf">10.0</span><span class="p">)</span>
			<span class="n">output_NSDictionary</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
			<span class="n">xmlout</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrateResultsAsXML</span><span class="p">())</span>
			<span class="n">output_a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output_NSDictionary</span><span class="o">.</span><span class="n">objectForKey_</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">output_a</span></div>

<div class="viewcode-block" id="MELTSmodel.equilibrate_sp"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.equilibrate_sp">[docs]</a>	<span class="k">def</span> <span class="nf">equilibrate_sp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S_a</span><span class="p">,</span> <span class="n">P_a</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Determines the equilibrium phase assemblage at an entropy-pressure point or</span>
<span class="sd">		along a series of S-P points.</span>

<span class="sd">		The bulk composition of the system must first be set by calling the function:</span>

<span class="sd">		``set_bulk_composition``</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		S_a : float or numpy array of floats</span>
<span class="sd">			Entropy in Joules per Kelvins.  Either a scaler values or a numpy array of</span>
<span class="sd">			float values must be provided.</span>
<span class="sd">		P_a : float or numpy array of floats</span>
<span class="sd">			Pressure in mega-Pascals. Either a scaler values or a numpy array of float</span>
<span class="sd">			values must be provided.</span>

<span class="sd">			NOTE: If both ``t_a`` and ``p_a`` are arrays, then they must both be the</span>
<span class="sd">			same length.</span>
<span class="sd">		initialize : bool, optional</span>
<span class="sd">			True if this is a S-, P-point that starts a sequence of calculations.</span>

<span class="sd">			False if this is a continuation S-,P-pair or series of pairs.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		output_a : an array of tuples</span>
<span class="sd">			tuple = (status, T, P, xmlout):</span>

<span class="sd">			* **status** is a string indicating the status of the calculation:</span>
<span class="sd">			  success/failiure, Reason for success/failure.</span>

<span class="sd">			* **T** is a float value corresponding to the temperature in degrees</span>
<span class="sd">			  centigrade.</span>

<span class="sd">			* **P** is a float value corresponding to the pressure in mega-Pascals.</span>

<span class="sd">			* **xmlout** is an xml document tree of the type xml.etree.ElementTree. The</span>
<span class="sd">			  xml tree contains information on the masses and abundances of all phases in</span>
<span class="sd">			  the system. ``xmlout`` is utilized as input for a number of functions in</span>
<span class="sd">			  this package that retrieve properties of the equilibrium assemblage.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		The ``xmlout`` document tree will be expanded to include thermodynamic properties</span>
<span class="sd">		of the phases and chemical affinities of phases not present in the equilibrium</span>
<span class="sd">		assemblage.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">S_a</span><span class="p">,</span> <span class="n">P_a</span> <span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">fill_array</span><span class="p">(</span><span class="n">S_a</span><span class="p">,</span> <span class="n">P_a</span><span class="p">)</span>
		<span class="n">output_a</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">S</span><span class="p">,</span><span class="n">P</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">S_a</span><span class="p">,</span><span class="n">P_a</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setEntropy_</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setPressure_</span><span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="mf">10.0</span><span class="p">)</span>

				<span class="n">nsarray_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSMutableArray&#39;</span><span class="p">)</span>
				<span class="n">nsarraykeys</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;ordinate&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;abscissa&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;imposeBuffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;bufferOffset&#39;</span><span class="p">))</span>

				<span class="n">nsarrayvalues</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Entropy (J/K-kg)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Pressure (MPa)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool_</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;QFM&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Double initialization does not work (?)</span>

				<span class="n">nsdict_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSDictionary&#39;</span><span class="p">)</span>
				<span class="n">nsdict</span> <span class="o">=</span> <span class="n">nsdict_cls</span><span class="o">.</span><span class="n">dictionaryWithObjects_forKeys_</span><span class="p">(</span><span class="n">nsarrayvalues</span><span class="p">,</span> <span class="n">nsarraykeys</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setCalculationOptions_</span><span class="p">(</span><span class="n">nsdict</span><span class="p">)</span>

			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementEntropy_</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementPressure_</span><span class="p">(</span><span class="n">P</span><span class="o">*</span><span class="mf">10.0</span><span class="p">)</span>
			<span class="n">output_NSDictionary</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
			<span class="n">xmlout</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrateResultsAsXML</span><span class="p">())</span>
			<span class="n">T</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">xmlout</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Temperature&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
			<span class="n">output_a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output_NSDictionary</span><span class="o">.</span><span class="n">objectForKey_</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">output_a</span></div>

<div class="viewcode-block" id="MELTSmodel.equilibrate_tv"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.equilibrate_tv">[docs]</a>	<span class="k">def</span> <span class="nf">equilibrate_tv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_a</span><span class="p">,</span> <span class="n">V_a</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Determines the equilibrium phase assemblage at a temperature-volume point</span>
<span class="sd">		or along a series of T-V points.</span>

<span class="sd">		The bulk composition of the system must first be set by calling the function:</span>

<span class="sd">		``set_bulk_composition``</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		T_a : float or numpy array of floats</span>
<span class="sd">			Temperature in degrees centigrade.  Either a scaler values or a numpy array</span>
<span class="sd">			of float values must be provided.</span>
<span class="sd">		V_a : float or numpy array of floats</span>
<span class="sd">			Volume in Joules per bar. Either a scaler values or a numpy array of float</span>
<span class="sd">			values must be provided.</span>

<span class="sd">			NOTE: If both ``t_a`` and ``p_a`` are arrays, then they must both be the</span>
<span class="sd">			same length.</span>
<span class="sd">		initialize : bool, optional</span>
<span class="sd">			True if this is a T-, V-point that starts a sequence of calculations.</span>

<span class="sd">			False if this is a continuation T-,V-pair or series of pairs.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		output_a : an array of tuples</span>
<span class="sd">			tuple = (status, T, P, xmlout):</span>

<span class="sd">			* **status** is a string indicating the status of the calculation:</span>
<span class="sd">			  success/failiure, Reason for success/failure.</span>

<span class="sd">			* **T** is a float value corresponding to the temperature in degrees centigrade.</span>

<span class="sd">			* **P** is a float value correcponding to the pressure in mega-Pascals.</span>

<span class="sd">			* **xmlout** is an xml document tree of the type xml.etree.ElementTree.</span>
<span class="sd">			  The xml tree contains information on the masses and abundances of all phases</span>
<span class="sd">			  in the system. ``xmlout`` is utilized as input for a number of functions in</span>
<span class="sd">			  this package that retrieve properties of the equilibrium assemblage.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		The ``xmlout`` document tree will be expanded to include thermodynamic properties</span>
<span class="sd">		of the phases and chemical affinities of phases not present in the equilibrium</span>
<span class="sd">		assemblage.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">T_a</span><span class="p">,</span> <span class="n">V_a</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fill_array</span><span class="p">(</span><span class="n">T_a</span><span class="p">,</span> <span class="n">V_a</span><span class="p">)</span>
		<span class="n">output_a</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">T</span><span class="p">,</span><span class="n">V</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">T_a</span><span class="p">,</span><span class="n">V_a</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setTemperature_</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setVolume_</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

				<span class="n">nsarray_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSMutableArray&#39;</span><span class="p">)</span>
				<span class="n">nsarraykeys</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;ordinate&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;abscissa&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;imposeBuffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;bufferOffset&#39;</span><span class="p">))</span>

				<span class="n">nsarrayvalues</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Temperature (°C)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Volume (cc/kg)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool_</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;QFM&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Double initialization does not work (?)</span>

				<span class="n">nsdict_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSDictionary&#39;</span><span class="p">)</span>
				<span class="n">nsdict</span> <span class="o">=</span> <span class="n">nsdict_cls</span><span class="o">.</span><span class="n">dictionaryWithObjects_forKeys_</span><span class="p">(</span><span class="n">nsarrayvalues</span><span class="p">,</span> <span class="n">nsarraykeys</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setCalculationOptions_</span><span class="p">(</span><span class="n">nsdict</span><span class="p">)</span>

			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementTemperature_</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementVolume_</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
			<span class="n">output_NSDictionary</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
			<span class="n">xmlout</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrateResultsAsXML</span><span class="p">())</span>
			<span class="n">output_a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output_NSDictionary</span><span class="o">.</span><span class="n">objectForKey_</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">output_a</span></div>

<div class="viewcode-block" id="MELTSmodel.equilibrate_sv"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.equilibrate_sv">[docs]</a>	<span class="k">def</span> <span class="nf">equilibrate_sv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">S_a</span><span class="p">,</span> <span class="n">V_a</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Determines the equilibrium phase assemblage at an entropy-volume point</span>
<span class="sd">		or along a series of S-V points.</span>

<span class="sd">		The bulk composition of the system must first be set by calling the function:</span>

<span class="sd">		``set_bulk_composition``</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		S_a : float or numpy array of floats</span>
<span class="sd">			Entropy in Joules per Kelvins.  Either a scaler values or a numpy array of</span>
<span class="sd">			float values must be provided.</span>
<span class="sd">		V_a : float or numpy array of floats</span>
<span class="sd">			Volume in Joules per bar. Either a scaler values or a numpy array of float</span>
<span class="sd">			values must be provided.</span>

<span class="sd">			NOTE: If both ``t_a`` and ``p_a`` are arrays, then they must both be the</span>
<span class="sd">			same length.</span>
<span class="sd">		initialize : bool, optional</span>
<span class="sd">			True if this is a S-, V-point that starts a sequence of calculations.</span>

<span class="sd">			False if this is a continuation S-,V-pair or series of pairs.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		output_a : an array of tuples</span>
<span class="sd">			tuple = (status, T, P, xmlout):</span>

<span class="sd">			* **status** is a string indicating the status of the calculation:</span>
<span class="sd">			  success/failiure, Reason for success/failure.</span>

<span class="sd">			* **T** is a float value corresponding to the temperature in degrees centigrade.</span>

<span class="sd">			* **P** is a float value corresponding to the pressure in mega-Pascals.</span>

<span class="sd">			* **xmlout** is an xml document tree of the type xml.etree.ElementTree.</span>
<span class="sd">			  The xml tree contains information on the masses and abundances of all phases</span>
<span class="sd">			  in the system. ``xmlout`` is utilized as input for a number of functions in</span>
<span class="sd">			  this package that retrieve properties of the equilibrium assemblage.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		The ``xmlout`` document tree will be expanded to include thermodynamic properties</span>
<span class="sd">		of the phases and chemical affinities of phases not present in the equilibrium</span>
<span class="sd">		assemblage.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">S_a</span><span class="p">,</span> <span class="n">V_a</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">fill_array</span><span class="p">(</span><span class="n">S_a</span><span class="p">,</span> <span class="n">V_a</span><span class="p">)</span>
		<span class="n">output_a</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">ind</span><span class="p">,(</span><span class="n">S</span><span class="p">,</span><span class="n">V</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">S_a</span><span class="p">,</span><span class="n">V_a</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">initialize</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setEntropy_</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setVolume_</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>

				<span class="n">nsarray_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSMutableArray&#39;</span><span class="p">)</span>
				<span class="n">nsarraykeys</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;ordinate&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;abscissa&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;imposeBuffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">))</span>
				<span class="n">nsarraykeys</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;bufferOffset&#39;</span><span class="p">))</span>

				<span class="n">nsarrayvalues</span> <span class="o">=</span> <span class="n">nsarray_cls</span><span class="o">.</span><span class="n">arrayWithCapacity_</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Entropy (J/K-kg)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;Volume (cc/kg)&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool_</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSString&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stringWithString_</span><span class="p">(</span><span class="s1">&#39;QFM&#39;</span><span class="p">))</span>
				<span class="n">nsarrayvalues</span><span class="o">.</span><span class="n">addObject_</span><span class="p">(</span><span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSNumber&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">numberWithBool</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># Double initialization does not work (?)</span>

				<span class="n">nsdict_cls</span> <span class="o">=</span> <span class="n">ObjCClass</span><span class="p">(</span><span class="s1">&#39;NSDictionary&#39;</span><span class="p">)</span>
				<span class="n">nsdict</span> <span class="o">=</span> <span class="n">nsdict_cls</span><span class="o">.</span><span class="n">dictionaryWithObjects_forKeys_</span><span class="p">(</span><span class="n">nsarrayvalues</span><span class="p">,</span> <span class="n">nsarraykeys</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">setCalculationOptions_</span><span class="p">(</span><span class="n">nsdict</span><span class="p">)</span>

			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementEntropy_</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">incrementVolume_</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
			<span class="n">output_NSDictionary</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
			<span class="n">xmlout</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrateResultsAsXML</span><span class="p">())</span>
			<span class="n">output_a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output_NSDictionary</span><span class="o">.</span><span class="n">objectForKey_</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">),</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">output_a</span></div>

<div class="viewcode-block" id="MELTSmodel.get_list_of_phases_in_assemblage"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_list_of_phases_in_assemblage">[docs]</a>	<span class="k">def</span> <span class="nf">get_list_of_phases_in_assemblage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns a list of phases in the specified equilibrium assemblage.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list : list</span>
<span class="sd">			A Python list of all phases in the equilibrium assemblage</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
				<span class="nb">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">list</span></div>

<div class="viewcode-block" id="MELTSmodel.get_dictionary_of_default_fractionation_coefficients"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_dictionary_of_default_fractionation_coefficients">[docs]</a>	<span class="k">def</span> <span class="nf">get_dictionary_of_default_fractionation_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fracLiq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fracSolid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fracFluid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fracCoeff</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns a dictionary of default coefficients for phase fractionation.</span>

<span class="sd">		These coefficients may be modified by the user. They are used when setting</span>
<span class="sd">		the extent to which a phase will fractionate from the equilibrium assemblage.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		fracLiq : bool, optional</span>
<span class="sd">			Flag to indicate if liquid phases should be fractionated from the system.</span>
<span class="sd">			Default is False.</span>
<span class="sd">		fracSolids : bool, optional</span>
<span class="sd">			Flag to indicate if solid phases should be fractionated from the system.</span>
<span class="sd">			Default is True.</span>
<span class="sd">		fracFluids : bool, optional</span>
<span class="sd">			Flag to indicate if fluid phases should be fractionated from the system.</span>
<span class="sd">			Default is True.</span>
<span class="sd">		fracCoeff : float, optional</span>
<span class="sd">			Fractionation coefficient, which gives the fractional extend to which the</span>
<span class="sd">			mass of the phase is extracted during phase fractionation.</span>
<span class="sd">			Default is 1.0 (100%).</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dict : dictionary</span>
<span class="sd">			A Python dictionary keyed on phases with values giving the extent (in fractional</span>
<span class="sd">			units) that a phase will fractionation mass.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		This dictionary is provided as input to the function ``fractionate_phases()``.</span>
<span class="sd">		The default configuration fractionates all solid/fluid phases and retains liquid.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span><span class="p">{}</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;Liquid&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fracLiq</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">fracCoeff</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;Water&#39;</span> <span class="ow">or</span> <span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;Fluid&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fracFluid</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">fracCoeff</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fracSolid</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="n">fracCoeff</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">return</span> <span class="nb">dict</span></div>

<div class="viewcode-block" id="MELTSmodel.get_mass_of_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_mass_of_phase">[docs]</a>	<span class="k">def</span> <span class="nf">get_mass_of_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns the mass of a phase in the specified equilibrium assemblage.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``</span>
<span class="sd">		phase_name : string, optional</span>
<span class="sd">			The name of the phase whose abundance is requested, or the string &#39;System&#39;,</span>
<span class="sd">			which returns the combined mass of all phases in the system.  Default value</span>
<span class="sd">			is &#39;System&#39;.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		value : float</span>
<span class="sd">			The mass of the phase in the equilibrium assemblage specified by ``root``, in grams.</span>
<span class="sd">			If the specified phase is not in the equilibrium assemblage, a value of zero is retuned.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="MELTSmodel.get_composition_of_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_composition_of_phase">[docs]</a>	<span class="k">def</span> <span class="nf">get_composition_of_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;oxide_wt&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns the composition of a phase in the specified equilibrium assemblage</span>
<span class="sd">		as a dictionary, with composition tabluated in the specified mode.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``</span>
<span class="sd">		phase_name : string, optional</span>
<span class="sd">			The name of the phase whose abundance is requested, or the string &#39;System&#39;,</span>
<span class="sd">			which returns the combined mass of all phases in the system.  Default value</span>
<span class="sd">			is &#39;System&#39;.</span>
<span class="sd">		mode : string, optional</span>
<span class="sd">			Controls the contents of the returned dictionary.</span>

<span class="sd">			* &#39;formula&#39; returns a dictionary with the string &#39;formula&#39; as key and value</span>
<span class="sd">			  set to a string representation of the phase formula. For pure component</span>
<span class="sd">			  phases, this is the standard phase formula. For solutions, this is the</span>
<span class="sd">			  actual formula constructed by weighting the endmember components by their</span>
<span class="sd">			  mole fractions.</span>

<span class="sd">			* &#39;oxide_wt&#39; returns a dictionary of oxide string keys with values in wt%.</span>
<span class="sd">			  This is a valid ``mode`` for all ``phase_name`` entries.</span>

<span class="sd">			* &#39;component&#39; returns a dictionary of endmember component keys with values in</span>
<span class="sd">			  mole fraction. The length of this dictionary will vary dependening on the</span>
<span class="sd">			  number of components that describe the solution. Pure phases return an empty</span>
<span class="sd">			  dictionary, as does ``phase_name`` set to &#39;System&#39;.</span>

<span class="sd">			The default value of ``mode`` is &#39;oxide_wt&#39;.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dict : dictionary</span>
<span class="sd">			A dictionary describing the composition of ``phase_name`` according to the</span>
<span class="sd">			``mode`` specified. The dictionary will be empty if ``phase_name`` is not</span>
<span class="sd">			present in the equilibrium assemblage.  It will also be empty for certain</span>
<span class="sd">			cases described above under ``mode``.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;oxide_wt&#39;</span><span class="p">:</span>
				<span class="n">oxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Composition/Oxide&quot;</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
					<span class="n">key</span> <span class="o">=</span> <span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">phase</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">phase</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;formula&#39;</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Formula&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
				<span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;oxide_wt&#39;</span><span class="p">:</span>
					<span class="n">oxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Oxide&quot;</span><span class="p">))</span>
					<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
						<span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
				<span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;component&#39;</span><span class="p">:</span>
					<span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Component&quot;</span><span class="p">))</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="n">components</span><span class="p">:</span>
						<span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Formula&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
							<span class="n">key</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
							<span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">return</span> <span class="nb">dict</span></div>

<div class="viewcode-block" id="MELTSmodel.fractionate_phases"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.fractionate_phases">[docs]</a>	<span class="k">def</span> <span class="nf">fractionate_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">frac_coeff</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Fractionates phases from the system.</span>
<span class="sd">		Partitions and maintains an internal dictionary of fractionates and automatically</span>
<span class="sd">		modifies system bulk composition to reflect fractionation.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``</span>
<span class="sd">		frac_coeff : dictionary</span>
<span class="sd">			A dictionary keyed on phase names with values that indicate the fraction of</span>
<span class="sd">			each phase that should fractionate.</span>

<span class="sd">			See get_dictionary_of_default_fractionation_coefficients().</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dict : dictionary</span>
<span class="sd">			A dictionary keyed on phase names with values corresponding to a dictionary</span>
<span class="sd">			of phase properties. Keys are property names.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

		<span class="n">bc</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">bcFactor</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span>
		<span class="n">oxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Composition/Oxide&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
			<span class="n">key</span> <span class="o">=</span> <span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
			<span class="n">bc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

		<span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//System/Phase&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
			<span class="n">phase_name</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
			<span class="nb">dict</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="n">fraction</span> <span class="o">=</span> <span class="n">frac_coeff</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">fraction</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
				<span class="n">mass</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
				<span class="n">oxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Oxide&quot;</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
					<span class="n">key</span> <span class="o">=</span> <span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">*</span><span class="n">fraction</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="mf">100.0</span>
					<span class="n">bc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">value</span><span class="o">*</span><span class="n">fraction</span><span class="o">*</span><span class="n">mass</span><span class="o">/</span><span class="mf">100.0</span>
					<span class="k">if</span> <span class="n">bc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
						<span class="n">bc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Zeroed: &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">dict</span></div>

<div class="viewcode-block" id="MELTSmodel.get_thermo_properties_of_phase_components"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_thermo_properties_of_phase_components">[docs]</a>	<span class="k">def</span> <span class="nf">get_thermo_properties_of_phase_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mu&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns a dictionary of the specified component thermodynamic properties of</span>
<span class="sd">		the designated phase.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``.</span>
<span class="sd">		phase_name : string</span>
<span class="sd">			The name of the phase whose abundance is requested.</span>
<span class="sd">		mode : string, optional</span>
<span class="sd">			Controls the contents of the returned dictionary.</span>

<span class="sd">			* &#39;mu&#39; returns a dictionary of endmember component keys with values of</span>
<span class="sd">			  chemical potential. The length of this dictionary will vary depending on</span>
<span class="sd">			  the number of components that describe the solution. Pure phases return a</span>
<span class="sd">			  dictionary of unit length, with the phase name as key and their specific</span>
<span class="sd">			  Gibbs free energy as value (J/g).</span>

<span class="sd">			* &#39;excess&#39; returns a dictionary of endmember component keys with values of</span>
<span class="sd">			  excess chemical potential. The length of this dictionary will vary</span>
<span class="sd">			  depending on the number of components that describe the solution.</span>
<span class="sd">			  Pure phases return a dictionary of unit length, with the phase name as key</span>
<span class="sd">			  and zero as value.</span>

<span class="sd">			* &#39;activity&#39; returns a dictionary of endmember component keys with values of</span>
<span class="sd">			  component activity. The length of this dictionary will vary depending on</span>
<span class="sd">			  the number of components that describe the solution. Pure phases return a</span>
<span class="sd">			  dictionary of unit length, with the phase name as key and unity as value.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dict : dictionary</span>
<span class="sd">			A dictionary describing the thermodynamic properties of components in</span>
<span class="sd">			``phase_name`` according to the ``mode`` specified. The dictionary will be</span>
<span class="sd">			empty if ``phase_name`` is not present in the equilibrium assemblage.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">phase</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">phase</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mu&#39;</span><span class="p">:</span>
				<span class="n">mus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;ChemicalPotential&quot;</span><span class="p">))</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">mus</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;GibbsFreeEnergy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">/</span><span class="n">mass</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">mus</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
						<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

			<span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;excess&#39;</span><span class="p">:</span>
				<span class="n">mus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;ExcessChemicalPotential&quot;</span><span class="p">))</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">mus</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">mus</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
						<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

			<span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;activity&#39;</span><span class="p">:</span>
				<span class="n">mus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;ExcessChemicalPotential&quot;</span><span class="p">))</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">mus</span><span class="p">:</span>
					<span class="nb">dict</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">t</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Temperature&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>
					<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">mus</span><span class="p">:</span>
						<span class="n">key</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
						<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="nb">dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">value</span><span class="o">/</span><span class="mf">8.3143</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>

		<span class="k">return</span> <span class="nb">dict</span></div>

<div class="viewcode-block" id="MELTSmodel.get_list_of_properties"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_list_of_properties">[docs]</a>	<span class="k">def</span> <span class="nf">get_list_of_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns a list of properties reported for each phase in an equilibrium assemblage.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		list : list</span>
<span class="sd">			A Python list of all properties of phases in an equilibrium assemblage</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">,</span><span class="s1">&#39;GibbsFreeEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;Enthalpy&#39;</span><span class="p">,</span><span class="s1">&#39;Entropy&#39;</span><span class="p">,</span><span class="s1">&#39;HeatCapacity&#39;</span><span class="p">,</span><span class="s1">&#39;DcpDt&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span><span class="s1">&#39;DvDt&#39;</span><span class="p">,</span><span class="s1">&#39;DvDp&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDt2&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDtDp&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDp2&#39;</span><span class="p">,</span> \
				<span class="s1">&#39;Density&#39;</span><span class="p">,</span><span class="s1">&#39;Alpha&#39;</span><span class="p">,</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s2">&quot;K&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;Gamma&#39;</span><span class="p">]</span>
		<span class="k">return</span> <span class="nb">list</span></div>

<div class="viewcode-block" id="MELTSmodel.get_units_of_property"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_units_of_property">[docs]</a>	<span class="k">def</span> <span class="nf">get_units_of_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="s1">&#39;Mass&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns the units of a specified property.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		string : string</span>
<span class="sd">			The units of the specified property.  Returns &#39;none&#39; if property is invalid.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mass&#39;</span><span class="p">:</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;GibbsFreeEnergy&#39;</span><span class="p">:</span><span class="s1">&#39;J&#39;</span><span class="p">,</span><span class="s1">&#39;Enthalpy&#39;</span><span class="p">:</span><span class="s1">&#39;J&#39;</span><span class="p">,</span><span class="s1">&#39;Entropy&#39;</span><span class="p">:</span><span class="s1">&#39;J/K&#39;</span><span class="p">,</span><span class="s1">&#39;HeatCapacity&#39;</span><span class="p">:</span><span class="s1">&#39;J/K&#39;</span><span class="p">,</span><span class="s1">&#39;DcpDt&#39;</span><span class="p">:</span><span class="s1">&#39;J/K^2&#39;</span><span class="p">,</span> \
				<span class="s1">&#39;Volume&#39;</span><span class="p">:</span><span class="s1">&#39;J/bar&#39;</span><span class="p">,</span><span class="s1">&#39;DvDt&#39;</span><span class="p">:</span><span class="s1">&#39;J/bar-K&#39;</span><span class="p">,</span><span class="s1">&#39;DvDp&#39;</span><span class="p">:</span><span class="s1">&#39;J/bar^2&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDt2&#39;</span><span class="p">:</span><span class="s1">&#39;J/bar-K^2&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDtDp&#39;</span><span class="p">:</span><span class="s1">&#39;J/bar^2-K&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDp2&#39;</span><span class="p">:</span><span class="s1">&#39;J/bar^3&#39;</span><span class="p">,</span> \
				<span class="s1">&#39;Density&#39;</span><span class="p">:</span><span class="s1">&#39;g/cm^3&#39;</span><span class="p">,</span><span class="s1">&#39;Alpha&#39;</span><span class="p">:</span><span class="s1">&#39;1/K&#39;</span><span class="p">,</span><span class="s1">&#39;Beta&#39;</span><span class="p">:</span><span class="s1">&#39;1/bar&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">:</span><span class="s1">&#39;GPa&#39;</span><span class="p">,</span><span class="s2">&quot;K&#39;&quot;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="s1">&#39;Gamma&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
		<span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.get_property_of_phase"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_property_of_phase">[docs]</a>	<span class="k">def</span> <span class="nf">get_property_of_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">,</span> <span class="n">property_name</span><span class="o">=</span><span class="s1">&#39;Mass&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns the specified property of a phase in the specified equilibrium assemblage.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``</span>
<span class="sd">		phase_name : string, optional</span>
<span class="sd">			The name of the phase whose property is requested, or the string &#39;System&#39;,</span>
<span class="sd">			which returns the combined property of all phases in the system.  Default</span>
<span class="sd">			value is &#39;System&#39;.</span>
<span class="sd">		property_name : string, optional</span>
<span class="sd">			The name of the property to be returned. Default value is &#39;Mass&#39;.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		value : float</span>
<span class="sd">			The property of the phase in the equilibrium assemblage specified by ``root``,</span>
<span class="sd">			in standard units.</span>
<span class="sd">			If the specified phase is not in the equilibrium assemblage, a value of zero</span>
<span class="sd">			is returned.</span>
<span class="sd">			If the property is not in the standard list, a value of zero is returned.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">standard</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">,</span><span class="s1">&#39;GibbsFreeEnergy&#39;</span><span class="p">,</span><span class="s1">&#39;Enthalpy&#39;</span><span class="p">,</span><span class="s1">&#39;Entropy&#39;</span><span class="p">,</span><span class="s1">&#39;HeatCapacity&#39;</span><span class="p">,</span><span class="s1">&#39;DcpDt&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span><span class="s1">&#39;DvDt&#39;</span><span class="p">,</span><span class="s1">&#39;DvDp&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDt2&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDtDp&#39;</span><span class="p">,</span><span class="s1">&#39;D2vDp2&#39;</span><span class="p">]</span>
		<span class="n">derived</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span><span class="s1">&#39;Alpha&#39;</span><span class="p">,</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s2">&quot;K&#39;&quot;</span><span class="p">,</span><span class="s1">&#39;Gamma&#39;</span><span class="p">]</span>

		<span class="k">if</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="n">standard</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/&quot;</span> <span class="o">+</span> <span class="n">property_name</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">+=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/&quot;</span> <span class="o">+</span> <span class="n">property_name</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/&quot;</span> <span class="o">+</span> <span class="n">property_name</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/&quot;</span> <span class="o">+</span> <span class="n">property_name</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">elif</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="n">derived</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;Density&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
					<span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="n">mass</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">volume</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">mass</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">mass</span><span class="o">/</span><span class="n">volume</span><span class="o">/</span><span class="mf">10.0</span> <span class="c1"># g/cc</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">mass</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">value</span> <span class="o">=</span> <span class="n">mass</span><span class="o">/</span><span class="n">volume</span><span class="o">/</span><span class="mf">10.0</span> <span class="c1"># g/cc</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;Alpha&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
					<span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="n">dvdt</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">volume</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">dvdt</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="n">dvdt</span><span class="o">/</span><span class="n">volume</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">dvdt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">value</span> <span class="o">=</span> <span class="n">dvdt</span><span class="o">/</span><span class="n">volume</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;Beta&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
					<span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="n">dvdp</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">volume</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">dvdp</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">dvdp</span><span class="o">/</span><span class="n">volume</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">dvdp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">dvdp</span><span class="o">/</span><span class="n">volume</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
					<span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="n">dvdp</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">volume</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">dvdp</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">volume</span><span class="o">/</span><span class="n">dvdp</span><span class="o">/</span><span class="mf">10000.0</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">dvdp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">volume</span><span class="o">/</span><span class="n">dvdp</span><span class="o">/</span><span class="mf">10000.0</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s2">&quot;K&#39;&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
					<span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="n">dvdp</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="n">d2vdp2</span> <span class="o">=</span> <span class="mf">0.0</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">volume</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">dvdp</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">d2vdp2</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/D2vDp2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">volume</span><span class="o">*</span><span class="n">d2vdp2</span><span class="o">/</span><span class="n">dvdp</span><span class="o">/</span><span class="n">dvdp</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Volume&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">dvdp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">d2vdp2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/D2vDp2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">volume</span><span class="o">*</span><span class="n">d2vdp2</span><span class="o">/</span><span class="n">dvdp</span><span class="o">/</span><span class="n">dvdp</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
			<span class="k">elif</span> <span class="n">property_name</span> <span class="o">==</span> <span class="s1">&#39;Gamma&#39;</span><span class="p">:</span>
				<span class="n">dvdp</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="n">dvdt</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="n">cp</span> <span class="o">=</span> <span class="mf">0.0</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Temperature&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">+</span><span class="mf">273.15</span>
				<span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">dvdp</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">dvdt</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
							<span class="n">cp</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/HeatCapacity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">dvdt</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">dvdp</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">dvdt</span><span class="o">*</span><span class="n">dvdt</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Mass&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">dvdp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">dvdt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/DvDt&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">cp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//System/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase_name</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/HeatCapacity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
						<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">dvdt</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">dvdp</span> <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">dvdt</span><span class="o">*</span><span class="n">dvdt</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span>

		<span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="MELTSmodel.get_dictionary_of_affinities"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.get_dictionary_of_affinities">[docs]</a>	<span class="k">def</span> <span class="nf">get_dictionary_of_affinities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Returns an ordered dictionary of tuples of chemical affinity and phase formulae for</span>
<span class="sd">		undersaturated phases in the system.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_xx``</span>
<span class="sd">		sort : boolean</span>
<span class="sd">			A flag when set to sort the dictionary in order of ascending affinities</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		dict : OrderedDict</span>
<span class="sd">			A Python ordered dictionary. Dictionary keys are strings naming the phases</span>
<span class="sd">			not in the equilibrium assemblage but known to the system.  These phases are</span>
<span class="sd">			by definition undersaturated. Dictionary values are tuples consisting of a</span>
<span class="sd">			float value and a string: (affinity, formula). For a solution phase, the</span>
<span class="sd">			formula is the composition closest to equilibrium with the reported phase</span>
<span class="sd">			assemblage.  Dictionary ordering corresponds to array order in</span>
<span class="sd">			get_phase_names(), unless ``sorted`` is set to True; then entries are</span>
<span class="sd">			ordered by ascending chemical affinity.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="nb">dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_names_a</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Potential/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">affinity</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Potential/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Affinity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
				<span class="n">formulae</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Potential/Phase[@Type=&#39;&quot;</span> <span class="o">+</span> <span class="n">phase</span> <span class="o">+</span> <span class="s2">&quot;&#39;]/Formula&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
				<span class="k">if</span> <span class="n">affinity</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
					<span class="n">affinity</span> <span class="o">=</span> <span class="mf">999999.0</span>
				<span class="nb">dict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">affinity</span><span class="p">,</span> <span class="n">formulae</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nb">dict</span></div>

<div class="viewcode-block" id="MELTSmodel.output_summary"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.output_summary">[docs]</a>	<span class="k">def</span> <span class="nf">output_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">printT</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">printP</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">printMass</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">printSysWt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">printSysM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">printPhs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">printPhsWt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">printPhsM</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Prints information about the specified equilibrium phase assemblage.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_tp``</span>
<span class="sd">		printT : bool, optional, default=True</span>
<span class="sd">			Print the system temperature in degrees centigrade</span>
<span class="sd">		printP : bool, optional, default=True</span>
<span class="sd">			Print the system pressure in mega-Pascals</span>
<span class="sd">		printMass ; bool, optional, default=False</span>
<span class="sd">			Print the mass of the system in grams</span>
<span class="sd">		printSysWt : bool, optional, default=False</span>
<span class="sd">			Print the composition of the system in wt% oxides</span>
<span class="sd">		printSysM : bool, optional, default=False</span>
<span class="sd">			Print the composition of the system in moles of elements</span>
<span class="sd">		printPhs : bool, optional, default=True</span>
<span class="sd">			Print the phases present in the system, their masses (in grams) and their</span>
<span class="sd">			chemical formulas</span>
<span class="sd">		printPhsWt : bool, optional, default=False</span>
<span class="sd">			Print the composition of each phase in wt% oxides (most often used in</span>
<span class="sd">			conjunction with printPhs=True)</span>
<span class="sd">		printPhsM : bool, optional, default=False</span>
<span class="sd">			Print the composition of each phase in moles of endmember components</span>
<span class="sd">			(most often used in conjunction with printPhs=True)</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">printT</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;10s}</span><span class="s2"> </span><span class="si">{1:&gt;8.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;T (°C)&quot;</span><span class="p">,</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Temperature&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>
		<span class="k">if</span> <span class="n">printP</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;10s}</span><span class="s2"> </span><span class="si">{1:&gt;8.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;P (MPa)&quot;</span><span class="p">,</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Pressure&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.0</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">printMass</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;10s}</span><span class="s2"> </span><span class="si">{1:&gt;8.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Mass (g)&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>

		<span class="k">if</span> <span class="n">printSysM</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Bulk composition in elemental abundances (moles):&quot;</span><span class="p">)</span>
			<span class="n">bcElements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Composition/Element&quot;</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">bcElements</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;   </span><span class="si">{0:&gt;2s}</span><span class="s2"> </span><span class="si">{1:&gt;8.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>

		<span class="k">if</span> <span class="n">printSysWt</span><span class="p">:</span>
			<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Bulk composition in oxide abundances (wt %):&quot;</span><span class="p">)</span>
			<span class="n">bcOxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Composition/Oxide&quot;</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">bcOxides</span><span class="p">:</span>
				<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;   </span><span class="si">{0:&gt;5s}</span><span class="s2"> </span><span class="si">{1:&gt;8.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>

		<span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//System/Phase&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">printPhs</span><span class="p">:</span>
				<span class="n">formula</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Formula&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;15.15s}</span><span class="s2"> </span><span class="si">{1:&gt;8.4f}</span><span class="s2"> (g)  </span><span class="si">{2:&lt;60s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">formula</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="c1"># this formula consists of oxide, value pairs (liquid phase)</span>
					<span class="n">n_oxides</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
					<span class="n">n_oxides_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_oxides</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
					<span class="n">n_oxides_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_oxides</span> <span class="o">-</span> <span class="n">n_oxides_1</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">n_oxides</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
						<span class="n">n_oxides_1</span> <span class="o">=</span> <span class="n">n_oxides</span>
						<span class="n">n_oxides_2</span> <span class="o">=</span> <span class="mi">0</span>
					<span class="n">line_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oxides_1</span><span class="p">):</span>
						<span class="n">line_1</span> <span class="o">=</span> <span class="n">line_1</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">formula</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">formula</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;15.15s}</span><span class="s2"> </span><span class="si">{1:&gt;8.4f}</span><span class="s2"> (g) </span><span class="si">{2:&lt;s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">line_1</span><span class="p">))</span>
					<span class="n">line_2</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_oxides_2</span><span class="p">):</span>
						<span class="n">line_2</span> <span class="o">=</span> <span class="n">line_2</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">formula</span><span class="p">[</span><span class="n">n_oxides_1</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">formula</span><span class="p">[</span><span class="n">n_oxides_1</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
					<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:&lt;33.33s}{1:&lt;s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">line_2</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">printPhsWt</span><span class="p">:</span>
				<span class="n">oxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Oxide&quot;</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;   </span><span class="si">{0:&lt;5s}</span><span class="s2"> </span><span class="si">{1:&gt;8.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>
			<span class="k">if</span> <span class="n">printPhsM</span><span class="p">:</span>
				<span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Component&quot;</span><span class="p">))</span>
				<span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
						<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;   </span><span class="si">{0:&lt;15s}</span><span class="s2"> </span><span class="si">{1:&gt;9.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span></div>

	<span class="c1"># =================================================================</span>
	<span class="c1"># Block of Excel workbook functions for output</span>
	<span class="c1"># =================================================================</span>

<div class="viewcode-block" id="MELTSmodel.start_excel_workbook_with_sheet_name"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.start_excel_workbook_with_sheet_name">[docs]</a>	<span class="k">def</span> <span class="nf">start_excel_workbook_with_sheet_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sheetName</span><span class="o">=</span><span class="s2">&quot;Summary&quot;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Create an Excel workbook with one named sheet.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		sheetName : string</span>
<span class="sd">			Sheet name in the new empty Excel workbook</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		wb : type Workbook</span>
<span class="sd">			A pointer to an Excel workbook</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Part of the Excel workbook functions subpackage</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">wb</span> <span class="o">=</span> <span class="n">Workbook</span><span class="p">()</span>
		<span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
		<span class="n">ws</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">sheetName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">return</span> <span class="n">wb</span></div>

<div class="viewcode-block" id="MELTSmodel.add_sheet_to_workbook_named"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.add_sheet_to_workbook_named">[docs]</a>	<span class="k">def</span> <span class="nf">add_sheet_to_workbook_named</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">sheetName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Creates a new sheet in an existing Excel workbook.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		wb : type Workbook</span>
<span class="sd">			A pointer to an existing Excel workbook</span>
<span class="sd">		sheetName : string</span>
<span class="sd">			New sheet name in the specified Excel workbook</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		ws : type Worksheet</span>
<span class="sd">			A pointer to an Excel worksheet in the specified workbook, ``wb``</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Part of the Excel workbook functions subpackage</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">sheetName</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ws</span></div>

<div class="viewcode-block" id="MELTSmodel.write_to_cell_in_sheet"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.write_to_cell_in_sheet">[docs]</a>	<span class="k">def</span> <span class="nf">write_to_cell_in_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;general&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Writes information into the specified row, col on the specified worksheet.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		ws : type Worksheet</span>
<span class="sd">			A pointer to a previously created Excel worksheet</span>
<span class="sd">			(see add_sheet_to_workbook_named)</span>
<span class="sd">		col : int</span>
<span class="sd">			Column number to write entry to.  Numbering starts at column one.</span>
<span class="sd">		row : int</span>
<span class="sd">			Row number to write entry to. Numbering starts at row one.</span>
<span class="sd">		value : float</span>
<span class="sd">			Value to place at entry</span>
<span class="sd">		format : string, optional</span>
<span class="sd">			Format to use for value</span>

<span class="sd">			* &#39;general&#39; is the default; no formatting applied</span>
<span class="sd">			* &#39;number&#39; formats as &#39;0.00&#39;</span>
<span class="sd">			* &#39;scientific&#39; formats as &#39;0.00E+00&#39;</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Part of the Excel workbook functions subpackage</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span><span class="p">:</span>
			<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">number_format</span> <span class="o">=</span> <span class="s1">&#39;0.00&#39;</span>
		<span class="k">elif</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;scientific&#39;</span><span class="p">:</span>
			<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">number_format</span> <span class="o">=</span> <span class="s1">&#39;0.00E+00&#39;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ws</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.write_excel_workbook"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.write_excel_workbook">[docs]</a>	<span class="k">def</span> <span class="nf">write_excel_workbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s2">&quot;junk.xlsx&quot;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Writes the specified Excel workbook to disk.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		wb : type Workbook</span>
<span class="sd">			A pointer to an existing Excel workbook</span>
<span class="sd">		fileName : string, optional</span>
<span class="sd">			Name of the file that will contain the specified Excel notebook.</span>
<span class="sd">			Default file name is &#39;junk.xlsx&#39;.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Part of the Excel workbook functions subpackage</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">fileName</span><span class="p">)</span></div>

<div class="viewcode-block" id="MELTSmodel.update_excel_workbook"><a class="viewcode-back" href="../equilibrate.html#equilibrate.MELTSmodel.update_excel_workbook">[docs]</a>	<span class="k">def</span> <span class="nf">update_excel_workbook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wb</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Writes the specified equilibrium system state to the specified Excel workbook.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		wb : type Workbook</span>
<span class="sd">			A pointer to an existing Excel workbook</span>
<span class="sd">		root : type xml.etree.ElementTree</span>
<span class="sd">			An xml document tree returned by the function ``equilibrate_tp``</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		The workbook is structured with a Summary worksheet and one worksheet for each</span>
<span class="sd">		equilibrium phase.  The evolution of the system is recorded in successive rows.</span>
<span class="sd">		Row integrity is maintained across all sheets. This function may be called</span>
<span class="sd">		repeatedly using different ``root`` objects. Part of the Excel workbook functions</span>
<span class="sd">		subpackage.</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Temperature&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">atof</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Pressure&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">*</span><span class="mf">1000.0</span>
		<span class="n">bcElements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Composition/Element&quot;</span><span class="p">))</span>
		<span class="n">bcOxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//Composition/Oxide&quot;</span><span class="p">))</span>

		<span class="n">wsSummary</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s2">&quot;Summary&quot;</span><span class="p">]</span> <span class="c1"># .get_sheet_by_name(&quot;Summary&quot;) upgraded</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
			<span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;T °C&quot;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;P MPa&quot;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;Mass g&quot;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">bcElements</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">])</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">bcOxides</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">])</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
		<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
		<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;.//Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
		<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">bcElements</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;scientific&#39;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">bcOxides</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsSummary</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

		<span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;.//System/Phase&quot;</span><span class="p">))</span>
		<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
			<span class="n">phaseType</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
			<span class="n">oxides</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Oxide&quot;</span><span class="p">))</span>
			<span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;Component&quot;</span><span class="p">))</span>

			<span class="k">try</span><span class="p">:</span>
				<span class="n">wsPhase</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="n">phaseType</span><span class="p">]</span> <span class="c1"># .get_sheet_by_name(phaseType) upgraded</span>
			<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
				<span class="n">wsPhase</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">create_sheet</span><span class="p">(</span><span class="n">phaseType</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;T °C&quot;</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;P MPa&quot;</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Mass g&quot;</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Formula&quot;</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oxide</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">])</span>
					<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
					<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

			<span class="n">col</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Mass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Formula&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
			<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">oxides</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">oxide</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">write_to_cell_in_sheet</span><span class="p">(</span><span class="n">wsPhase</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">component</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;scientific&#39;</span><span class="p">)</span>
				<span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span></div></div>
</pre></div>

          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2020, ENKI.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 2.4.0.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>